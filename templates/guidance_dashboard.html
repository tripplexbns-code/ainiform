<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Uniform System - Guidance Dashboard</title>
    <meta name="description" content="Guidance Counselor Dashboard - Manage student uniform compliance efficiently">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéì</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }
        
        .header {
            background: #1877f2;
            color: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #1877f2, #42a5f5, #1877f2);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            z-index: 1000;
            display: none;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .main-layout {
            display: flex;
            min-height: calc(100vh - 80px);
        }
        
        .sidebar {
            width: 280px;
            background: #1877f2;
            color: white;
            position: sticky;
            top: 80px;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .sidebar-header h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .sidebar-header p {
            opacity: 0.8;
            font-size: 14px;
        }
        
        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .nav-item {
            margin: 0;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: rgba(255, 255, 255, 0.5);
        }
        
        .nav-link.active {
            background: rgba(255, 255, 255, 0.15);
            border-left-color: white;
        }
        
        .nav-icon {
            font-size: 20px;
            margin-right: 12px;
            width: 24px;
            text-align: center;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #1877f2;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #65676b;
            font-size: 14px;
            font-weight: 500;
        }
        
        .content-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Ensure only active tab content is visible */
        .tab-content:not(.active) {
            display: none !important;
            visibility: hidden !important;
        }
        
        .tab-content.active {
            display: block !important;
            visibility: visible !important;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #1c1e21;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #1877f2;
            color: white;
        }
        
        .btn-primary:hover {
            background: #166fe5;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #e4e6ea;
            color: #1c1e21;
        }
        
        .btn-secondary:hover {
            background: #d1d3d9;
        }
        
        .btn-success {
            background: #42b883;
            color: white;
        }
        
        .btn-success:hover {
            background: #369870;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e4e6ea;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #1877f2;
        }
        
        .data-table {
            width: 100%;
            min-width: 900px;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            table-layout: fixed;
        }
        
        .data-table th {
            background: #f8f9fa;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            color: #1c1e21;
            border-bottom: 1px solid #e4e6ea;
            white-space: nowrap;
        }
        
        .data-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #f0f2f5;
            word-wrap: break-word;
            vertical-align: middle;
        }
        
        /* Column width specifications */
        .data-table th:nth-child(1),
        .data-table td:nth-child(1) {
            width: 20%; /* Student */
        }
        
        .data-table th:nth-child(2),
        .data-table td:nth-child(2) {
            width: 15%; /* Student ID */
        }
        
        .data-table th:nth-child(3),
        .data-table td:nth-child(3) {
            width: 18%; /* Violation */
        }
        
        .data-table th:nth-child(4),
        .data-table td:nth-child(4) {
            width: 12%; /* Status */
        }
        
        .data-table th:nth-child(5),
        .data-table td:nth-child(5) {
            width: 8%; /* Offense */
        }
        
        .data-table th:nth-child(6),
        .data-table td:nth-child(6) {
            width: 27%; /* Actions */
            white-space: nowrap;
        }
        
        /* Specific styling for violations table */
        #violations .data-table th:nth-child(1),
        #violations .data-table td:nth-child(1) {
            width: 20%; /* Student */
        }
        
        #violations .data-table th:nth-child(2),
        #violations .data-table td:nth-child(2) {
            width: 15%; /* Student ID */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #violations .data-table th:nth-child(3),
        #violations .data-table td:nth-child(3) {
            width: 18%; /* Violation */
        }
        
        #violations .data-table th:nth-child(4),
        #violations .data-table td:nth-child(4) {
            width: 12%; /* Status */
        }
        
        #violations .data-table th:nth-child(5),
        #violations .data-table td:nth-child(5) {
            width: 8%; /* Offense - compact for ordinal numbers */
            text-align: center;
        }
        
        #violations .data-table th:nth-child(6),
        #violations .data-table td:nth-child(6) {
            width: 27%; /* Actions - increased space for buttons */
            white-space: nowrap;
            text-align: center;
        }
        
        /* Specific styling for designs table */
        #designs .data-table {
            display: table !important;
            visibility: visible !important;
            opacity: 1 !important;
            width: 100% !important;
            min-width: 700px !important;
        }
        
        #designs .data-table thead {
            display: table-header-group !important;
            visibility: visible !important;
        }
        
        #designs .data-table tbody {
            display: table-row-group !important;
            visibility: visible !important;
        }
        
        #designs .data-table tr {
            display: table-row !important;
            visibility: visible !important;
        }
        
        #designs .data-table th,
        #designs .data-table td {
            display: table-cell !important;
            visibility: visible !important;
        }
        
        #designs .data-table th:nth-child(1),
        #designs .data-table td:nth-child(1) {
            width: 30%; /* Design Name - more space for longer names */
        }
        
        #designs .data-table th:nth-child(2),
        #designs .data-table td:nth-child(2) {
            width: 15%; /* Type */
        }
        
        #designs .data-table th:nth-child(3),
        #designs .data-table td:nth-child(3) {
            width: 15%; /* Status */
        }
        
        #designs .data-table th:nth-child(4),
        #designs .data-table td:nth-child(4) {
            width: 30%; /* Actions - more space for multiple buttons */
            white-space: nowrap;
        }
        
        /* Ensure designs tab content is visible when active */
        #designs.tab-content.active {
            display: block !important;
        }
        
        #designs .table-container {
            display: block !important;
            visibility: visible !important;
        }
        
        /* Force all table elements to be visible in designs tab */
        #designs table,
        #designs table * {
            display: revert !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        #designs table {
            display: table !important;
        }
        
        #designs table thead {
            display: table-header-group !important;
        }
        
        #designs table tbody {
            display: table-row-group !important;
        }
        
        #designs table tr {
            display: table-row !important;
        }
        
        #designs table th,
        #designs table td {
            display: table-cell !important;
        }
        
        /* Ensure uniform designs content is only in designs tab */
        #designs .section-title {
            display: block !important;
        }
        
        /* Hide designs table in other tabs */
        .tab-content:not(#designs) .designs-table-container,
        .tab-content:not(#designs) .designs-table {
            display: none !important;
        }
        
        /* Ensure designs table is visible in designs tab */
        #designs .designs-table-container,
        #designs .designs-table {
            display: block !important;
        }
        
        #designs .designs-table {
            display: table !important;
        }
        
        /* Ensure violations and appeals tables are visible in their respective tabs */
        #violations .data-table,
        #appeals .data-table {
            display: table !important;
            visibility: visible !important;
        }
        
        #violations .table-container,
        #appeals .appeals-table-container {
            display: block !important;
            visibility: visible !important;
        }
        
        .data-table td:nth-child(6) {
            text-align: center;
        }
        
        .data-table td:nth-child(6) .btn {
            margin: 3px;
            padding: 8px 14px;
            font-size: 12px;
        }
        
        /* Specific button styling for violations table */
        #violations .data-table td:nth-child(6) .btn {
            margin: 3px;
            padding: 8px 14px;
            font-size: 12px;
            min-width: 70px;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .table-container {
            width: 100%;
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .table-container::-webkit-scrollbar {
            height: 8px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Appeals modal styling */
        .appeals-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .appeal-item {
            border: 1px solid #e4e6ea;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        
        .appeal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .appeal-number {
            font-weight: bold;
            color: #1877f2;
        }
        
        .appeal-date {
            color: #65676b;
            font-size: 14px;
        }
        
        .appeal-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Appeals table specific styling */
        .appeals-table {
            min-width: 100%;
            table-layout: auto;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e4e6ea;
        }
        
        
        .appeals-table .student-info {
            display: flex;
            align-items: center;
            gap: 6px;
            line-height: 1.2;
        }
        
        .appeals-table .clickable-student-name {
            font-weight: 600;
            color: #1877f2;
            cursor: pointer;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: inline-block;
            position: relative;
            font-size: 15px;
        }
        
        .appeals-table .clickable-student-name:hover {
            background: linear-gradient(135deg, rgba(24, 119, 242, 0.1), rgba(24, 119, 242, 0.2));
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(24, 119, 242, 0.2);
        }
        
        
        .appeals-table .clickable-student-name:active {
            transform: translateY(0);
            background-color: rgba(24, 119, 242, 0.2);
        }
        
        .appeals-table .auto-badge {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid rgba(25, 118, 210, 0.2);
            box-shadow: 0 1px 3px rgba(25, 118, 210, 0.2);
        }
        
        /* Action column CSS removed - no longer needed */
        
        
        .appeals-table .action-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .appeals-table .clickable-actions {
            transition: all 0.2s ease;
            border-radius: 8px;
            padding: 4px;
        }
        
        
        .appeals-table .action-buttons .btn {
            margin: 0;
            padding: 8px 16px;
            font-size: 12px;
            min-width: 70px;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        
        .appeals-table .view-btn {
            background: #1877f2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            transition: all 0.2s ease;
        }
        
        
        .appeals-table .view-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .appeals-table .view-btn .btn-icon {
            margin-right: 6px;
            font-size: 14px;
        }
        
        .appeals-table .view-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(24, 119, 242, 0.3);
        }
        
        /* Override any conflicting button styles for view buttons */
        .appeals-table .action-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .appeals-table .status-text {
            color: #65676b;
            font-style: italic;
            font-size: 12px;
        }
        
        .appeals-table tr {
            border-bottom: 1px solid #f0f2f5;
            transition: all 0.3s ease;
            height: auto;
            min-height: 48px;
        }
        
        .appeals-table tr:hover {
            background: linear-gradient(135deg, #f8f9ff, #e3f2fd) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(24, 119, 242, 0.15);
        }
        
        
        .appeals-table .clickable-row {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        
        
        
        .appeals-table tr:nth-child(even) {
            background: #fafbfc;
        }
        
        
        .appeals-table td {
            border: none;
            vertical-align: middle;
            padding: 12px 20px !important;
            height: auto;
            position: relative;
        }
        
        .appeals-table th {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            font-weight: 700;
            color: #1c1e21;
            border-bottom: 2px solid #dee2e6;
            font-size: 14px;
            letter-spacing: 0.3px;
            padding: 16px 20px !important;
            text-transform: uppercase;
            font-size: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        
        /* Appeals table container */
        .appeals-table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid #e4e6ea;
            margin-top: 20px;
        }
        
        .appeals-table-wrapper {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .appeals-table {
                min-width: 100%;
                font-size: 14px;
            }
            
            .appeals-table th,
            .appeals-table td {
                padding: 8px 12px !important;
            }
            
            .appeals-table .clickable-student-name {
                font-size: 14px;
                padding: 6px 10px;
            }
        }
        
        @media (max-width: 480px) {
            .appeals-table th,
            .appeals-table td {
                padding: 6px 8px !important;
            }
            
            .appeals-table .clickable-student-name {
                font-size: 13px;
                padding: 4px 8px;
            }
        }
        
        .appeal-details {
            margin-bottom: 15px;
        }
        
        .appeal-details p {
            margin: 5px 0;
            color: #1c1e21;
        }
        
        .appeal-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .appeal-actions .btn {
            font-size: 11px;
            padding: 4px 8px;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .reason-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .reason-badge.reason-excused {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }
        
        .reason-badge.reason-unexcused {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }
        
        .status-badge.status-guidance {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            color: white;
        }
        
        .status-badge.status-advisory {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }
        
        .status-badge.status-warning {
            background: linear-gradient(135deg, #ffc107, #ff8f00);
            color: white;
        }
        
        .status-badge.status-no-violations {
            background: linear-gradient(135deg, #4caf50, #388e3c);
            color: white;
        }
        
        .auto-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            margin-left: 5px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        
        .violation-count-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        .count-title {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
        }
        
        .count-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .count-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .count-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .count-card.max-violations {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            color: white;
            border-color: #d32f2f;
        }
        
        .count-card.warning-violations {
            background: linear-gradient(135deg, #ffc107, #ff8f00);
            color: white;
            border-color: #ffc107;
        }
        
        .count-card.normal-violations {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            border-color: #ff9800;
        }
        
        .student-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .violation-count {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .violation-status {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .max-violation-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .count-cell {
            text-align: center;
            vertical-align: middle;
            width: 80px;
        }
        
        .violation-count-badge {
            display: inline-block;
            padding: 8px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 14px;
            min-width: 35px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .violation-count-badge.max-violations {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            color: white;
            font-size: 16px;
            font-weight: 900;
            box-shadow: 0 4px 8px rgba(211, 47, 47, 0.3);
            animation: pulse 2s infinite;
        }
        
        .violation-count-badge.warning-violations {
            background: linear-gradient(135deg, #ffc107, #ff8f00);
            color: white;
            font-weight: bold;
        }
        
        .violation-count-badge.normal-violations {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .student-row {
            transition: background-color 0.2s ease;
        }
        
        .student-row.guidance-violations-row {
            background-color: #fff5f5;
            border-left: 4px solid #d32f2f;
            box-shadow: 0 2px 8px rgba(211, 47, 47, 0.1);
        }
        
        .student-row.advisory-violations-row {
            background-color: #fff8e1;
            border-left: 4px solid #ff9800;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.1);
        }
        
        .student-row.warning-violations-row {
            background-color: #fffbf0;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);
        }
        
        .student-row:hover {
            background-color: #f8f9fa;
        }
        
        .student-row.expanded {
            background-color: #e3f2fd;
        }
        
        .violation-details-row {
            background-color: #f8f9fa;
            display: none;
        }
        
        .violation-details-row.show {
            display: table-row;
        }
        
        .violation-details-cell {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            background-color: #f8f9fa;
        }
        
        .violation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .violation-item:last-child {
            border-bottom: none;
        }
        
        .violation-info {
            flex: 1;
        }
        
        .violation-actions {
            margin-left: 15px;
            display: flex;
            gap: 5px;
        }
        
        .violations-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .violation-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }
        
        .violation-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .violation-number {
            background-color: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .violation-type {
            font-weight: bold;
            color: #495057;
        }
        
        .violation-type-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .violation-date {
            font-size: 0.75em;
            color: #6c757d;
            font-weight: normal;
            margin-top: 2px;
        }
        
        .violation-details {
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }
        
        .violation-details p {
            margin: 5px 0;
            color: #6c757d;
        }
        
        .modal-footer {
            padding: 15px;
            border-top: 1px solid #e9ecef;
            text-align: right;
        }
        
        /* Design name link styles */
        .design-name-link {
            color: #1877f2;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }
        
        .design-name-link:hover {
            color: #0d5aa7;
            text-decoration: underline;
        }
        
        /* Design details modal styles */
        .modal-large {
            max-width: 800px;
        }
        
        .design-details-container {
            display: flex;
            gap: 30px;
            padding: 20px 0;
        }
        
        .design-info-section {
            flex: 1;
        }
        
        .design-image-section {
            flex: 1;
        }
        
        .detail-row {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .detail-label {
            font-weight: bold;
            color: #333;
            display: block;
            margin-bottom: 5px;
        }
        
        .detail-value {
            color: #666;
            font-size: 14px;
        }
        
        .image-container {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #fafafa;
        }
        
        .image-container img {
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .design-details-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .modal-large {
                max-width: 95%;
            }
        }
        
        .clickable-student-name {
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
            font-weight: 500;
            transition: color 0.2s ease;
        }
        
        .clickable-student-name:hover {
            color: #0056b3;
            text-decoration: none;
        }
        
        .appeal-count-badge {
            background-color: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75em;
            margin-left: 8px;
        }
        
        .appeals-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .appeal-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }
        
        .appeal-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .appeal-number {
            background-color: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .appeal-details {
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            border-left: 3px solid #28a745;
        }
        
        .appeal-details p {
            margin: 5px 0;
            color: #6c757d;
        }
        
        .appeal-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }
        
        .violation-details-header {
            background-color: #e9ecef;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .violation-details-header h4 {
            margin: 0;
            color: #495057;
        }
        
        .violation-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .violation-number {
            background-color: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-right: 8px;
        }
        
        .violation-status {
            margin-left: 10px;
        }
        
        .violation-date {
            background-color: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
            margin: 0 8px;
        }
        
        .date-cell {
            font-weight: 500;
            color: #495057;
            background-color: #f8f9fa;
            padding-left: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9em;
        }
        
        .expand-icon {
            transition: transform 0.2s ease;
            margin-right: 8px;
        }
        
        .expand-icon.expanded {
            transform: rotate(90deg);
        }
        
        .student-name-cell {
            display: flex;
            align-items: center;
        }
        
        .status-text {
            color: #6b7280;
            font-style: italic;
            font-size: 14px;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-advisory {
            background: #ffeaa7;
            color: #d63031;
        }
        
        .status-guidance {
            background: #fab1a0;
            color: #e17055;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-active {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e4e6ea;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1c1e21;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #65676b;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #1c1e21;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e4e6ea;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #1877f2;
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e4e6ea;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
            }
            
            .nav-menu {
                display: flex;
                overflow-x: auto;
            }
            
            .nav-item {
                flex-shrink: 0;
            }
            
            .nav-link {
                white-space: nowrap;
                padding: 15px 20px;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .data-table {
                font-size: 14px;
                min-width: 750px;
            }
            
            .data-table th,
            .data-table td {
                padding: 10px 8px;
            }
            
            .table-container {
                margin: 0 -10px;
                padding: 0 10px;
            }
            
            /* Responsive design for violations table */
            #violations .data-table {
                min-width: 750px;
            }
            
            #violations .data-table th,
            #violations .data-table td {
                padding: 8px 6px;
                font-size: 13px;
            }
            
            /* Responsive design for designs table */
            #designs .data-table {
                min-width: 700px;
            }
            
            #designs .data-table th,
            #designs .data-table td {
                padding: 8px 6px;
                font-size: 13px;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 20px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .tab-content {
                padding: 20px 15px;
            }
        }
        
        /* Activity Log Styles */
        .activity-log-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-top: 20px;
        }
        
        .activity-log-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e4e6ea;
            border-radius: 8px;
            background: #fafbfc;
        }
        
        .activity-log-content {
            padding: 20px;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #e4e6ea;
            background: white;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        
        .activity-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .activity-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .activity-icon.add {
            background: #d4edda;
            color: #155724;
        }
        
        .activity-icon.edit {
            background: #fff3cd;
            color: #856404;
        }
        
        .activity-icon.delete {
            background: #f8d7da;
            color: #721c24;
        }
        
        .activity-icon.appeal {
            background: #cce5ff;
            color: #004085;
        }
        
        .activity-details {
            flex: 1;
            min-width: 0;
        }
        
        .activity-title {
            font-weight: 600;
            color: #1c1e21;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .activity-description {
            color: #6c757d;
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .activity-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 12px;
            color: #8a8d93;
        }
        
        .activity-time {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .activity-user {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        
        .no-activities {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .no-activities .icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .no-activities h3 {
            margin-bottom: 10px;
            color: #495057;
        }
        
        .no-activities p {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="loading-indicator" id="loadingIndicator" style="display: none;"></div>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div>
                <h1>üéì AI Uniform System</h1>
                <p>Guidance Counselor Dashboard</p>
            </div>
            <div class="user-info">
                <div class="user-avatar">üë©‚Äçüè´</div>
                <div>
                    <div style="font-weight: 600;">{{ user.name or user.username or 'User' }}</div>
                    <div style="font-size: 12px; opacity: 0.8;">{{ (user.role or 'Guidance Counselor').title() }}</div>
                </div>
                <a href="logout" class="logout-btn">Logout</a>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Navigation</h2>
                <p>Manage your tasks</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" onclick="showTab('violations')">
                        <span class="nav-icon">‚ö†Ô∏è</span>
                        Violations
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showTab('appeals')">
                        <span class="nav-icon">üìù</span>
                        Appeals
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showTab('designs')">
                        <span class="nav-icon">üëî</span>
                        Uniform Designs
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showTab('activity')">
                        <span class="nav-icon">üìã</span>
                        Activity Log
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="container">
                <!-- Statistics Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">‚ö†Ô∏è</div>
                        <div class="stat-number">{{ violations|length }}</div>
                        <div class="stat-label">Total Violations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìù</div>
                        <div class="stat-number">{{ appeals|length }}</div>
                        <div class="stat-label">Pending Appeals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üëî</div>
                        <div class="stat-number">{{ designs|length }}</div>
                        <div class="stat-label">Uniform Designs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-number">{{ appeals|selectattr('status', 'equalto', 'Approved')|list|length }}</div>
                        <div class="stat-label">Approved Appeals</div>
                    </div>
                </div>

                <!-- Content Sections -->
                <div class="content-section">
                    <!-- Violations Tab -->
                    <div id="violations" class="tab-content active">
        <div class="section-header">
            <h3 class="section-title">Uniform Violations Management</h3>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openModal('violationModal')">‚ûï Add Violation</button>
                <button class="btn btn-danger" onclick="clearAllViolations()">üóëÔ∏è Clear All</button>
            </div>
        </div>
        
                        
                        <div class="search-bar">
                            <input type="text" class="search-input" id="violationSearch" placeholder="Search violations...">
                            <button class="btn btn-primary" onclick="searchViolations()">üîç Search</button>
                        </div>
                        
                        <div class="table-container">
                            <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Student ID</th>
                                    <th>Violation</th>
                                    <th>Status</th>
                                    <th>Offense</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="violationsTableBody">
                                {% for violation in violations %}
                                <tr class="violation-row" data-student="{{ violation.student_name or 'Unknown' }}" data-violation-id="{{ violation.id or 'unknown' }}">
                                    <td class="student-name-cell">
                                        {{ violation.student_name or 'Unknown Student' }}
                                    </td>
                                    <td class="student-id-cell">
                                        {{ violation.student_id or 'No ID' }}
                                    </td>
                                    <td>{{ violation.violation_type or 'Unknown Type' }}</td>
                                    <td><span class="status-badge status-{{ (violation.status or 'Pending').lower() }}">{{ violation.status or 'Pending' }}</span></td>
                                    <td class="count-cell">
                                        <span class="violation-count-badge">
                                            <!-- Offense will be populated by JavaScript -->
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-danger" onclick="deleteViolation('{{ violation.id or 'unknown' }}')">Delete</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        </div>
                    </div>
                    
                    <!-- Appeals Tab -->
                    <div id="appeals" class="tab-content">
                        <div class="section-header">
                            <h3 class="section-title">Appeals Management</h3>
                            <div class="action-buttons">
                                <button class="btn btn-primary" onclick="openModal('appealModal')">‚ûï Add Appeal</button>
                                <button class="btn btn-danger" onclick="clearAllAppeals()">üóëÔ∏è Clear All</button>
                            </div>
                        </div>
                        
                        <div class="search-bar">
                            <input type="text" class="search-input" id="appealSearch" placeholder="Search appeals...">
                            <button class="btn btn-primary" onclick="searchAppeals()">üîç Search</button>
                        </div>
                        
                        <div class="appeals-table-container">
                            <div class="appeals-table-wrapper">
                        <table class="data-table appeals-table">
                            <thead>
                                <tr>
                                            <th style="text-align: left;">Student Name</th>
                                            <th style="text-align: left; width: 120px;">Student ID</th>
                                            <th style="text-align: center; width: 100px;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="appealsTableBody">
                                {% for appeal in appeals %}
                                <tr class="appeal-row">
                                    <td style="text-align: left; vertical-align: middle; padding-right: 8px;">
                                        <div class="student-info">
                                            <span class="clickable-student-name" onclick="console.log('Student name clicked for appeal ID:', '{{ appeal.id or 'unknown' }}'); viewAppealDetails('{{ appeal.id or 'unknown' }}')" title="Click to view appeal details for {{ appeal.student_name or 'Unknown' }}">
                                                {{ appeal.student_name or 'Unknown Student' }}
                                            </span>
                                            {% if appeal.created_automatically %}
                                            <span class="auto-badge" title="Auto-created from violation">ü§ñ</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td style="text-align: left; vertical-align: middle; padding-left: 8px;">
                                        <span style="color: #666; font-size: 14px;">{{ appeal.student_id or 'N/A' }}</span>
                                    </td>
                                    <td style="text-align: center; vertical-align: middle;">
                                        <button class="btn btn-primary btn-sm view-btn" onclick="viewAppealDetails('{{ appeal.id or 'unknown' }}')" title="View appeal details">
                                            View
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Uniform Designs Tab -->
                    <div id="designs" class="tab-content">
                        <div class="section-header">
                            <h3 class="section-title">Uniform Designs Management</h3>
                            <div class="action-buttons">
                                <button class="btn btn-primary" onclick="openModal('designModal')">‚ûï Add Design</button>
                                <button class="btn btn-danger" onclick="clearAllDesigns()">üóëÔ∏è Clear All</button>
                            </div>
                        </div>
                        
                        <div class="search-bar">
                            <input type="text" class="search-input" id="designSearch" placeholder="Search designs...">
                            <button class="btn btn-primary" onclick="searchDesigns()">üîç Search</button>
                        </div>
                        
                        <div class="table-container designs-table-container">
                            <table class="data-table designs-table">
                            <thead>
                                <tr>
                                    <th>Design Name</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for design in designs[:5] %}
                                <tr>
                                    <td><a href="#" class="design-name-link" onclick="viewDesignDetails('{{ design.id or 'unknown' }}')">{{ design.name or 'Unknown Design' }}</a></td>
                                    <td>{{ design.type or 'Unknown Type' }}</td>
                                    <td><span class="status-badge status-{{ (design.status or 'Pending').lower() }}">{{ design.status or 'Pending' }}</span></td>
                                    <td>
                                        <button class="btn btn-success" onclick="approveDesign('{{ design.id or 'unknown' }}')">Approve</button>
                                        <button class="btn btn-danger" onclick="deleteDesign('{{ design.id or 'unknown' }}')">Delete</button>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% if not designs or designs|length == 0 %}
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 20px; color: #666;">
                                        <div style="margin-bottom: 10px;">üìã No uniform designs found</div>
                                        <button class="btn btn-primary" onclick="openModal('designModal')">‚ûï Add First Design</button>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                        </div>
                    </div>
                    
                    <!-- Activity Log Tab -->
                    <div id="activity" class="tab-content">
                        <div class="section-header">
                            <h3 class="section-title">üìã Activity Log</h3>
                            <div class="action-buttons">
                                <button class="btn btn-primary" onclick="refreshActivityLog()">üîÑ Refresh</button>
                                <button class="btn btn-danger" onclick="clearActivityLog()">üóëÔ∏è Clear Log</button>
                            </div>
                        </div>
                        
                        <div class="search-bar">
                            <input type="text" class="search-input" id="activitySearch" placeholder="Search activities...">
                            <button class="btn btn-primary" onclick="searchActivities()">üîç Search</button>
                        </div>
                        
                        <div class="activity-log-container">
                            <div id="activityLogContent" class="activity-log-content">
                                <div class="loading-spinner">Loading activity log...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Violation Modal -->
    <div id="violationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Violation</h3>
                <button class="close-btn" onclick="closeModal('violationModal')">&times;</button>
            </div>
            <form id="violationForm">
                <div class="form-group">
                    <label class="form-label">Student Name</label>
                    <input type="text" class="form-input" name="student_name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Student ID</label>
                    <input type="text" class="form-input" name="student_id" pattern="[0-9]+" title="Please enter numbers only" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" name="email_address" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Violation Type</label>
                    <select class="form-select" name="violation_type" required>
                        <option value="Incomplete Uniform">Incomplete Uniform</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" name="date" id="violationDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input form-textarea" name="description" required></textarea>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">Save Violation</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('violationModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Appeal Modal -->
    <div id="appealModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Appeal</h3>
                <button class="close-btn" onclick="closeModal('appealModal')">&times;</button>
            </div>
            <form id="appealForm">
                <div class="form-group">
                    <label class="form-label">Student Name</label>
                    <input type="text" class="form-input" name="student_name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Reason Type</label>
                    <select class="form-select" name="reason_type" required>
                        <option value="">Select reason type</option>
                        <option value="Excused">Excused</option>
                        <option value="Unexcused">Unexcused</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Appeal Date</label>
                    <input type="date" class="form-input" name="appeal_date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Reason Details</label>
                    <textarea class="form-input form-textarea" name="reason" placeholder="Provide detailed explanation for the appeal..." required></textarea>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-success">Approve</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('appealModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Design Modal -->
    <div id="designModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Design</h3>
                <button class="close-btn" onclick="closeModal('designModal')">&times;</button>
            </div>
            <form id="designForm">
                <div class="form-group">
                    <label class="form-label">Design Name</label>
                    <input type="text" class="form-input" name="name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-select" name="type" required>
                        <option value="">Select Type</option>
                        <option value="school uniform">School Uniform</option>
                        <option value="house shirt">House Shirt</option>
                        <option value="casual shirt">Casual Shirt</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Upload Picture</label>
                    <input type="file" class="form-input" name="image" accept="image/*">
                    <small class="form-text">Upload a picture of the uniform design (JPG, PNG, GIF)</small>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">Save Design</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('designModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Design Details Modal -->
    <div id="designDetailsModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 class="modal-title">Design Details</h3>
                <button class="close-btn" onclick="closeModal('designDetailsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="design-details-container">
                    <div class="design-info-section">
                        <div class="detail-row">
                            <label class="detail-label">Design Name:</label>
                            <span class="detail-value" id="detailDesignName">-</span>
                        </div>
                        <div class="detail-row">
                            <label class="detail-label">Type:</label>
                            <span class="detail-value" id="detailDesignType">-</span>
                        </div>
                        <div class="detail-row">
                            <label class="detail-label">Status:</label>
                            <span class="detail-value" id="detailDesignStatus">-</span>
                        </div>
                        <div class="detail-row">
                            <label class="detail-label">Created Date:</label>
                            <span class="detail-value" id="detailDesignDate">-</span>
                        </div>
                    </div>
                    <div class="design-image-section">
                        <label class="detail-label">Design Image:</label>
                        <div class="image-container" id="designImageContainer">
                            <img id="designImage" src="" alt="Design Image" style="max-width: 100%; max-height: 400px; display: none;">
                            <div id="noImageMessage" style="text-align: center; padding: 20px; color: #666; display: none;">
                                No image uploaded for this design
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('designDetailsModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Violation Modal -->
    <div id="editViolationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Violation</h3>
                <button class="close-btn" onclick="closeModal('editViolationModal')">&times;</button>
            </div>
            <form id="editViolationForm">
                <input type="hidden" id="editViolationId" name="id">
                <div class="form-group">
                    <label class="form-label">Student Name</label>
                    <input type="text" class="form-input" id="editStudentName" name="student_name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Student ID</label>
                    <input type="text" class="form-input" id="editStudentId" name="student_id" pattern="[0-9]+" title="Please enter numbers only" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" id="editEmailAddress" name="email_address" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Violation Type</label>
                    <select class="form-select" id="editViolationType" name="violation_type" required>
                        <option value="Incomplete Uniform">Incomplete Uniform</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input form-textarea" id="editDescription" name="description" required placeholder="Describe the violation details..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="editStatus" name="status" required>
                        <option value="">Select Status</option>
                        <option value="Warning">Warning</option>
                        <option value="Advisory">Advisory</option>
                        <option value="Guidance">Guidance</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">Update Violation</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editViolationModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Appeal Modal -->
    <div id="editAppealModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Appeal</h3>
                <button class="close-btn" onclick="closeModal('editAppealModal')">&times;</button>
            </div>
            <form id="editAppealForm">
                <input type="hidden" id="editAppealId" name="id">
                <div class="form-group">
                    <label class="form-label">Student Name</label>
                    <input type="text" class="form-input" id="editAppealStudentName" name="student_name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Reason Type</label>
                    <select class="form-select" id="editAppealReasonType" name="reason_type" required>
                        <option value="">Select reason type</option>
                        <option value="Excused">Excused</option>
                        <option value="Unexcused">Unexcused</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Reason Details</label>
                    <textarea class="form-input form-textarea" id="editAppealReason" name="reason" required placeholder="Describe the reason for the appeal..."></textarea>
                </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Resolution Notes</label>
                    <textarea class="form-input form-textarea" id="editAppealResolutionNotes" name="resolution_notes" placeholder="Add resolution notes or follow-up actions..."></textarea>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">Update Appeal</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editAppealModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Alert Messages -->
    <div id="alertContainer"></div>

    <script>
        // Pass server-side data to JavaScript
        window.violationsData = {{ violations | tojson }};
        window.appealsData = {{ appeals | tojson }};
        window.designsData = {{ designs | tojson }};
        
        console.log('Server data loaded:', {
            violations: window.violationsData,
            appeals: window.appealsData,
            designs: window.designsData
        });
    </script>
    
    <script>
        // Tab functionality
        function showTab(tabName) {
            console.log('=== SHOWING TAB ===');
            console.log('Tab name:', tabName);
            
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            console.log('Found tab contents:', tabContents.length);
            tabContents.forEach(content => {
                console.log('Hiding tab:', content.id);
                content.classList.remove('active');
            });
            
            // Remove active class from all nav links
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => link.classList.remove('active'));
            
            // Show selected tab content
            const targetTab = document.getElementById(tabName);
            console.log('Target tab element:', targetTab);
            if (targetTab) {
                targetTab.classList.add('active');
                console.log('Added active class to:', tabName);
                
                // Special handling for designs tab
                if (tabName === 'designs') {
                    console.log('Designs tab activated');
                    console.log('Designs data:', window.designsData);
                    console.log('Number of designs:', window.designsData ? window.designsData.length : 'No data');
                    
                    // Use setTimeout to ensure DOM is fully updated
                    setTimeout(() => {
                        // Force designs tab to be visible
                        targetTab.style.display = 'block';
                        targetTab.style.visibility = 'visible';
                        targetTab.style.opacity = '1';
                        
                        // Check if table is visible
                        const table = document.querySelector('#designs .designs-table');
                        if (table) {
                            console.log('Table found:', table);
                            console.log('Table display style:', window.getComputedStyle(table).display);
                            console.log('Table visibility:', window.getComputedStyle(table).visibility);
                            
                            // Force table to be visible with all properties
                            table.style.display = 'table';
                            table.style.visibility = 'visible';
                            table.style.opacity = '1';
                            table.style.width = '100%';
                            table.style.minWidth = '700px';
                            table.style.tableLayout = 'fixed';
                            console.log('Forced table to be visible');
                            
                            // Force thead visibility
                            const thead = table.querySelector('thead');
                            if (thead) {
                                thead.style.display = 'table-header-group';
                                thead.style.visibility = 'visible';
                                console.log('Forced thead to be visible');
                            }
                        } else {
                            console.error('Table not found in designs tab');
                        }
                        
                        // Check table body
                        const tbody = document.querySelector('#designs tbody');
                        if (tbody) {
                            console.log('Table body found:', tbody);
                            console.log('Table body display style:', window.getComputedStyle(tbody).display);
                            
                            // Force tbody to be visible
                            tbody.style.display = 'table-row-group';
                            tbody.style.visibility = 'visible';
                            console.log('Forced table body to be visible');
                        }
                        
                        // Check table rows
                        const rows = document.querySelectorAll('#designs tbody tr');
                        console.log('Number of table rows:', rows.length);
                        rows.forEach((row, index) => {
                            console.log(`Row ${index}:`, row.textContent.trim());
                            console.log(`Row ${index} display:`, window.getComputedStyle(row).display);
                            
                            // Force row to be visible
                            row.style.display = 'table-row';
                            row.style.visibility = 'visible';
                            console.log(`Forced row ${index} to be visible`);
                        });
                        
                        // Force table container to be visible
                        const tableContainer = document.querySelector('#designs .designs-table-container');
                        if (tableContainer) {
                            console.log('Table container found:', tableContainer);
                            tableContainer.style.display = 'block';
                            tableContainer.style.visibility = 'visible';
                            tableContainer.style.opacity = '1';
                            console.log('Forced table container to be visible');
                        }
                        
                        // Clear any search filter and show all rows
                        const searchInput = document.getElementById('designSearch');
                        if (searchInput) {
                            searchInput.value = '';
                            console.log('Cleared search input');
                        }
                        
                        // Ensure all rows are visible
                        rows.forEach(row => {
                            row.style.display = 'table-row';
                            row.style.visibility = 'visible';
                        });
                        console.log('Reset all rows to be visible');
                        
                        // Final check - log all computed styles
                        console.log('Final table styles:', {
                            display: window.getComputedStyle(table).display,
                            visibility: window.getComputedStyle(table).visibility,
                            opacity: window.getComputedStyle(table).opacity
                        });
                    }, 100);
                }
            } else {
                console.error('Tab not found:', tabName);
            }
            
            // Add active class to clicked nav link
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Load activities if activity tab is selected
            if (tabName === 'activity') {
                loadActivityLog();
            }
            
            // DISABLED: Appeals observer management - causing console messages
            // Observer functionality completely disabled
            window.appealsObserverActive = false;
            console.log('Appeals observer disabled for all tabs');
        }

        // Modal functionality
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            
            // Set today's date for violation form when modal opens
            if (modalId === 'violationModal') {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('violationDate').value = today;
            }
            
            // Set today's date for appeal form when modal opens
            if (modalId === 'appealModal') {
                setTimeout(() => {
                    const today = new Date().toISOString().split('T')[0];
                    const appealDateInput = document.querySelector('input[name="appeal_date"]');
                    if (appealDateInput) {
                        appealDateInput.value = today;
                    }
                }, 100);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Form submissions
        document.getElementById('violationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Prevent double submission
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn.disabled) {
                return; // Already processing
            }
            
            // Disable submit button and show loading
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            fetch('/api/violations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert('Violation added successfully!', 'success');
                    closeModal('violationModal');
                    
                    // Log activity
                    logActivity('add', 'violation', 'Violation Added', `New violation added for ${data.student_name}`, `Offense: ${data.offense || 'Unknown'}, Date: ${data.date || 'Unknown'}`);
                    
                    // Reset form
                    this.reset();
                    
                    // Automatically refresh the table to show the new violation
                    console.log('Violation added successfully, refreshing data...');
                    // Add a small delay to ensure server cache is cleared and modal is closed
                    setTimeout(() => {
                        console.log('Starting refresh after add violation...');
                        refreshDataOnly();
                    }, 1500); // Wait 1.5 seconds to ensure everything is processed
                } else {
                    // Handle duplicate error specifically
                    if (result.duplicate) {
                        showAlert('‚ö†Ô∏è Duplicate Violation: ' + result.error, 'warning');
                    } else {
                        showAlert('Error adding violation: ' + (result.error || result.message || 'Unknown error'), 'error');
                    }
                }
            })
            .catch(error => {
                showAlert('Error adding violation: ' + error.message, 'error');
            })
            .finally(() => {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Violation';
            });
        });


        document.getElementById('appealForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            // Validate required fields
            if (!data.reason_type) {
                showAlert('Please select a reason type (Excused or Unexcused)', 'error');
                return;
            }
            
            if (!data.reason || data.reason.trim() === '') {
                showAlert('Please provide reason details', 'error');
                return;
            }
            
            // Automatically set status to approved
            data.status = 'Approved';
            data.approved_date = new Date().toISOString();
            data.approved_by = 'Guidance Counselor'; // You can modify this to get actual user
            
            fetch('/api/appeals', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert('Appeal approved and saved successfully!', 'success');
                    
                    // Log activity
                    logActivity('add', 'appeal', 'Appeal Added', `New appeal submitted by ${data.student_name}`, `Reason: ${data.reason_type}, Details: ${data.reason.substring(0, 50)}...`);
                    
                    closeModal('appealModal');
                    
                    // Reset form
                    this.reset();
                    
                    // Automatically refresh the table to show the new appeal
                    setTimeout(() => {
                        refreshDataOnly();
                    }, 500); // Wait 500ms to show the success message
                    
                    // Also refresh after a longer delay to ensure data is updated
                    setTimeout(() => {
                        refreshDataOnly();
                    }, 2000);
                } else {
                    showAlert('Error adding appeal: ' + (result.error || result.message || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showAlert('Error adding appeal: ' + error.message, 'error');
            });
        });

        document.getElementById('designForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch('/api/designs', {
                method: 'POST',
                credentials: 'same-origin',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert('Design added successfully!', 'success');
                    
                    // Log activity
                    const formData = new FormData(this);
                    const data = Object.fromEntries(formData);
                    logActivity('add', 'design', 'Design Added', `New uniform design created: ${data.name}`, `Type: ${data.type}, Status: Under Review`);
                    
                    closeModal('designModal');
                    
                    // Automatically reload the page to show the new design
                    setTimeout(() => {
                        location.reload();
                    }, 1000); // Wait 1 second to show the success message
                } else {
                    showAlert('Error adding design: ' + (result.error || result.message || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showAlert('Error adding design: ' + error.message, 'error');
            });
        });

        // Edit Violation Form Handler
        document.getElementById('editViolationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            const violationId = data.id;
            
            // Remove the id from the data object as it's not needed in the update
            delete data.id;
            
            fetch(`/api/violations/${violationId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert('Violation updated successfully!', 'success');
                    
                    // Log activity
                    logActivity('edit', 'violation', 'Violation Updated', `Violation for ${data.student_name} has been updated`, `Student: ${data.student_name}, Type: ${data.violation_type}, Status: ${data.status}`);
                    
                    closeModal('editViolationModal');
                    
                    // Automatically refresh the table to show the updated violation
                    setTimeout(() => {
                        refreshDataOnly();
                    }, 1000); // Wait 1 second to show the success message
                } else {
                    showAlert('Error updating violation: ' + (result.error || result.message || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showAlert('Error updating violation: ' + error.message, 'error');
            });
        });

        // Edit Appeal Form Handler
        document.getElementById('editAppealForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            const appealId = data.id;
            
            // Validate required fields
            if (!data.reason_type) {
                showAlert('Please select a reason type (Excused or Unexcused)', 'error');
                return;
            }
            
            if (!data.reason || data.reason.trim() === '') {
                showAlert('Please provide reason details', 'error');
                return;
            }
            
            // Remove the id from the data object as it's not needed in the update
            delete data.id;
            
            fetch(`/api/appeals/${appealId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert('Appeal updated successfully!', 'success');
                    
                    // Log activity
                    logActivity('edit', 'appeal', 'Appeal Updated', `Appeal for ${data.student_name} has been updated`, `Status: ${data.status}, Reason: ${data.reason_type}`);
                    
                    closeModal('editAppealModal');
                    location.reload();
                } else {
                    showAlert('Error updating appeal: ' + (result.error || result.message || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showAlert('Error updating appeal: ' + error.message, 'error');
            });
        });



        // Search functionality
        function searchViolations() {
            const searchTerm = document.getElementById('violationSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#violationsTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
            
            // Recalculate counts after search
            refreshViolationCounts();
        }

        function searchAppeals() {
            const searchTerm = document.getElementById('appealSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#appealsTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }


        function groupAppealRows() {
            const tableBody = document.getElementById('appealsTableBody');
            if (!tableBody) return;

            const rows = Array.from(tableBody.querySelectorAll('tr'));
            if (rows.length === 0) return;

            // console.log('Found appeal rows:', rows.length); // Disabled to prevent console messages

            // Check if already grouped (has appeal-count-badge)
            const hasGroupedStructure = tableBody.querySelector('.appeal-count-badge');
            if (hasGroupedStructure) {
                // console.log('Appeals already grouped, but checking for duplicates...'); // Disabled to prevent console messages
                // Check if there are still duplicate student names
                const studentNames = Array.from(tableBody.querySelectorAll('.clickable-student-name')).map(el => el.textContent.trim());
                const uniqueNames = new Set(studentNames);
                if (studentNames.length === uniqueNames.size) {
                    // console.log('No duplicates found, keeping current structure'); // Disabled to prevent console messages
                    return;
                } else {
                    // console.log('Duplicates found, re-grouping...'); // Disabled to prevent console messages
                }
            }

            // Group rows by student name
            const groupedRows = {};
            rows.forEach(row => {
                const studentNameElement = row.querySelector('.clickable-student-name');
                if (studentNameElement) {
                    const studentName = studentNameElement.textContent.trim();
                    if (!groupedRows[studentName]) {
                        groupedRows[studentName] = [];
                    }
                    groupedRows[studentName].push(row);
                }
            });

            // console.log('Grouped appeals by student:', Object.keys(groupedRows)); // Disabled to prevent console messages

            // Only group if we have multiple rows for the same student
            const needsGrouping = Object.values(groupedRows).some(appeals => appeals.length > 1);
            if (!needsGrouping) {
                // console.log('No duplicate students found, keeping original structure'); // Disabled to prevent console messages
                return;
            }

            // Clear table body completely
            tableBody.innerHTML = '';

            // Create one row per student
            Object.keys(groupedRows).forEach(studentName => {
                const studentAppeals = groupedRows[studentName];
                const count = studentAppeals.length;
                
                console.log(`Student: ${studentName}, Appeals: ${count}`);
                
                // Extract student ID from the first row (second td contains student_id)
                const firstRow = studentAppeals[0];
                const studentIdCell = firstRow.querySelector('td:nth-child(2)');
                const studentId = studentIdCell ? (studentIdCell.textContent.trim() || 'N/A') : 'N/A';
                
                // Create main student row
                const studentRow = document.createElement('tr');
                studentRow.className = 'student-row';
                
                studentRow.innerHTML = `
                    <td style="text-align: left; vertical-align: middle; padding-right: 8px;">
                        <span class="clickable-student-name" onclick="viewStudentAppeals('${studentName}')" title="Click to view all appeals for ${studentName}">
                            <strong>${studentName}</strong>
                        </span>
                        <span class="appeal-count-badge">(${count} appeal${count > 1 ? 's' : ''})</span>
                    </td>
                    <td style="text-align: left; vertical-align: middle; padding-left: 8px; width: 120px;">
                        <span style="color: #666; font-size: 14px;">${studentId}</span>
                    </td>
                    <td style="text-align: center; vertical-align: middle;">
                        <button class="btn btn-primary btn-sm view-btn" onclick="viewStudentAppeals('${studentName}')" title="View all appeals for ${studentName}">
                            View
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(studentRow);
            });
        }

        function reapplyGrouping() {
            // Re-apply grouping after data changes
            setTimeout(() => {
                calculateViolationCounts();
                groupAppealRows();
            }, 1000); // Wait a bit longer for data to load
        }

        function forceGrouping() {
            // Force grouping regardless of current state
            // console.log('Force grouping appeals...'); // Disabled to prevent console messages
            const tableBody = document.getElementById('appeals').querySelector('tbody');
            if (!tableBody) return;

            // Clear any existing grouping
            const existingRows = Array.from(tableBody.querySelectorAll('tr'));
            if (existingRows.length === 0) return;

            // Always re-group
            tableBody.innerHTML = '';
            
            // Group rows by student name
            const groupedRows = {};
            existingRows.forEach(row => {
                const studentNameElement = row.querySelector('.clickable-student-name');
                if (studentNameElement) {
                    const studentName = studentNameElement.textContent.trim();
                    if (!groupedRows[studentName]) {
                        groupedRows[studentName] = [];
                    }
                    groupedRows[studentName].push(row);
                }
            });

            // Create one row per student
            Object.keys(groupedRows).forEach(studentName => {
                const studentAppeals = groupedRows[studentName];
                const count = studentAppeals.length;
                
                // Extract student ID from the first row (second td contains student_id)
                const firstRow = studentAppeals[0];
                const studentIdCell = firstRow.querySelector('td:nth-child(2)');
                const studentId = studentIdCell ? (studentIdCell.textContent.trim() || 'N/A') : 'N/A';
                
                // Create main student row
                const studentRow = document.createElement('tr');
                studentRow.className = 'student-row';
                
                studentRow.innerHTML = `
                    <td style="text-align: left; vertical-align: middle; padding-right: 8px;">
                        <span class="clickable-student-name" onclick="viewStudentAppeals('${studentName}')" title="Click to view all appeals for ${studentName}">
                            <strong>${studentName}</strong>
                        </span>
                        <span class="appeal-count-badge">(${count} appeal${count > 1 ? 's' : ''})</span>
                    </td>
                    <td style="text-align: left; vertical-align: middle; padding-left: 8px; width: 120px;">
                        <span style="color: #666; font-size: 14px;">${studentId}</span>
                    </td>
                    <td style="text-align: center; vertical-align: middle;">
                        <button class="btn btn-primary btn-sm view-btn" onclick="viewStudentAppeals('${studentName}')" title="View all appeals for ${studentName}">
                            View
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(studentRow);
            });
        }

        function searchDesigns() {
            const searchTerm = document.getElementById('designSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#designs tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function debugDesignsTable() {
            console.log('=== DEBUGGING DESIGNS TABLE ===');
            
            // Check if designs tab is active
            const designsTab = document.getElementById('designs');
            console.log('Designs tab element:', designsTab);
            console.log('Designs tab has active class:', designsTab?.classList.contains('active'));
            console.log('Designs tab display style:', designsTab ? window.getComputedStyle(designsTab).display : 'N/A');
            console.log('Designs tab visibility:', designsTab ? window.getComputedStyle(designsTab).visibility : 'N/A');
            console.log('Designs tab opacity:', designsTab ? window.getComputedStyle(designsTab).opacity : 'N/A');
            
            // Check table container
            const tableContainer = document.querySelector('#designs .designs-table-container');
            console.log('Table container element:', tableContainer);
            if (tableContainer) {
                console.log('Table container display:', window.getComputedStyle(tableContainer).display);
                console.log('Table container visibility:', window.getComputedStyle(tableContainer).visibility);
                console.log('Table container opacity:', window.getComputedStyle(tableContainer).opacity);
            }
            
            // Check table
            const table = document.querySelector('#designs .designs-table');
            console.log('Table element:', table);
            if (table) {
                console.log('Table display style:', window.getComputedStyle(table).display);
                console.log('Table visibility:', window.getComputedStyle(table).visibility);
                console.log('Table opacity:', window.getComputedStyle(table).opacity);
                console.log('Table width:', window.getComputedStyle(table).width);
                console.log('Table height:', window.getComputedStyle(table).height);
            }
            
            // Check table body
            const tbody = document.querySelector('#designs tbody');
            console.log('Table body element:', tbody);
            if (tbody) {
                console.log('Table body display style:', window.getComputedStyle(tbody).display);
                console.log('Table body visibility:', window.getComputedStyle(tbody).visibility);
            }
            
            // Check rows
            const rows = document.querySelectorAll('#designs tbody tr');
            console.log('Number of rows:', rows.length);
            rows.forEach((row, index) => {
                console.log(`Row ${index}:`, {
                    element: row,
                    display: window.getComputedStyle(row).display,
                    visibility: window.getComputedStyle(row).visibility,
                    opacity: window.getComputedStyle(row).opacity,
                    text: row.textContent.trim()
                });
            });
            
            // Check designs data
            console.log('Designs data:', window.designsData);
            console.log('Number of designs in data:', window.designsData ? window.designsData.length : 'No data');
            
            // Check for any CSS rules that might be hiding the table
            if (table) {
                const allStyles = window.getComputedStyle(table);
                console.log('All table computed styles:', {
                    display: allStyles.display,
                    visibility: allStyles.visibility,
                    opacity: allStyles.opacity,
                    position: allStyles.position,
                    zIndex: allStyles.zIndex,
                    overflow: allStyles.overflow,
                    width: allStyles.width,
                    height: allStyles.height,
                    maxWidth: allStyles.maxWidth,
                    maxHeight: allStyles.maxHeight
                });
            }
            
            // Show alert with summary
            const summary = `Designs Tab Active: ${designsTab?.classList.contains('active')}\nTable Found: ${!!table}\nRows Found: ${rows.length}\nData Available: ${window.designsData ? window.designsData.length : 0} designs\nTable Display: ${table ? window.getComputedStyle(table).display : 'N/A'}\nTable Visibility: ${table ? window.getComputedStyle(table).visibility : 'N/A'}`;
            alert(summary);
        }

        function forceRefreshDesignsTable() {
            console.log('=== FORCE REFRESHING DESIGNS TABLE ===');
            
            // First, ensure the designs tab is active
            const designsTab = document.getElementById('designs');
            if (designsTab) {
                designsTab.classList.add('active');
                designsTab.style.display = 'block';
                designsTab.style.visibility = 'visible';
                designsTab.style.opacity = '1';
            }
            
            // Force table container visibility
            const tableContainer = document.querySelector('#designs .designs-table-container');
            if (tableContainer) {
                tableContainer.style.display = 'block';
                tableContainer.style.visibility = 'visible';
                tableContainer.style.opacity = '1';
            }
            
            // Force table visibility
            const table = document.querySelector('#designs .designs-table');
            if (table) {
                table.style.display = 'table';
                table.style.visibility = 'visible';
                table.style.opacity = '1';
                table.style.width = '100%';
                table.style.minWidth = '700px';
                table.style.tableLayout = 'fixed';
                
                // Force thead visibility
                const thead = table.querySelector('thead');
                if (thead) {
                    thead.style.display = 'table-header-group';
                    thead.style.visibility = 'visible';
                }
                
                // Force all th elements
                const thElements = table.querySelectorAll('th');
                thElements.forEach(th => {
                    th.style.display = 'table-cell';
                    th.style.visibility = 'visible';
                });
            }
            
            // Force tbody visibility
            const tbody = document.querySelector('#designs tbody');
            if (tbody) {
                tbody.style.display = 'table-row-group';
                tbody.style.visibility = 'visible';
            }
            
            // Force all rows to be visible
            const rows = document.querySelectorAll('#designs tbody tr');
            rows.forEach(row => {
                row.style.display = 'table-row';
                row.style.visibility = 'visible';
                row.style.opacity = '1';
                
                // Force all td elements in each row
                const tdElements = row.querySelectorAll('td');
                tdElements.forEach(td => {
                    td.style.display = 'table-cell';
                    td.style.visibility = 'visible';
                });
            });
            
            // Clear any search filters
            const searchInput = document.getElementById('designSearch');
            if (searchInput) {
                searchInput.value = '';
            }
            
            console.log('Force refresh completed');
        }

        // Activity Log Functions
        function showActivityLog() {
            // This function is now handled by the tab system
            showTab('activity');
        }

        function loadActivityLog() {
            console.log('Loading activity log...');
            const content = document.getElementById('activityLogContent');
            if (!content) {
                console.error('Activity log content element not found');
                return;
            }
            
            content.innerHTML = '<div class="loading-spinner">Loading activity log...</div>';
            
            // Load activities from localStorage
            setTimeout(() => {
                console.log('Loading activities...');
                const storedActivities = JSON.parse(localStorage.getItem('activities') || '[]');
                console.log('Stored activities:', storedActivities);
                
                // Ensure all activities have proper timestamps
                const validActivities = storedActivities.filter(activity => {
                    if (!activity.timestamp) {
                        console.warn('Activity missing timestamp:', activity);
                        return false;
                    }
                    return true;
                });
                
                // Sort by timestamp (newest first)
                const sortedActivities = validActivities.sort((a, b) => {
                    const timeA = new Date(a.timestamp);
                    const timeB = new Date(b.timestamp);
                    return timeB - timeA;
                });
                
                console.log('Valid activities:', validActivities.length);
                console.log('Sorted activities:', sortedActivities);
                displayActivities(sortedActivities);
            }, 100);
        }


        function displayActivities(activities) {
            console.log('Displaying activities:', activities);
            const content = document.getElementById('activityLogContent');
            
            if (!content) {
                console.error('Activity log content element not found in displayActivities');
                return;
            }
            
            if (activities.length === 0) {
                console.log('No activities to display');
                content.innerHTML = `
                    <div class="no-activities">
                        <div class="icon">üìã</div>
                        <h3>No Activities Found</h3>
                        <p>No activities have been recorded yet.</p>
                    </div>
                `;
                return;
            }
            
            const activitiesHtml = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-icon ${activity.type}">
                        ${getActivityIcon(activity.type, activity.category)}
                    </div>
                    <div class="activity-details">
                        <div class="activity-title">${activity.title}</div>
                        <div class="activity-description">${activity.description}</div>
                        <div class="activity-meta">
                            <div class="activity-time">
                                <span>üïí</span>
                                <span>${formatTimestamp(activity.timestamp)}</span>
                            </div>
                            <div class="activity-user">
                                <span>üë§</span>
                                <span>${activity.user}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            content.innerHTML = activitiesHtml;
        }

        function getActivityIcon(type, category) {
            const icons = {
                add: { violation: '‚ûï', appeal: 'üìù', design: 'üëî', system: 'üöÄ' },
                edit: { violation: '‚úèÔ∏è', appeal: '‚úèÔ∏è', design: '‚úèÔ∏è', system: '‚öôÔ∏è' },
                delete: { violation: 'üóëÔ∏è', appeal: 'üóëÔ∏è', design: 'üóëÔ∏è', system: 'üîß' }
            };
            return icons[type]?.[category] || 'üìã';
        }

        function formatTimestamp(timestamp) {
            const now = new Date();
            const activityTime = new Date(timestamp);
            
            // Check if timestamp is valid
            if (isNaN(activityTime.getTime())) {
                return 'Unknown time';
            }
            
            const diff = now - activityTime;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            
            return activityTime.toLocaleDateString();
        }

        function refreshActivityLog() {
            loadActivityLog();
        }
        
        
        function filterStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const studentItems = document.querySelectorAll('.student-item');
            
            studentItems.forEach(item => {
                const studentName = item.getAttribute('data-student').toLowerCase();
                if (studentName.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function viewLatestAppeal(appealId) {
            viewAppeal(appealId);
        }
        
        function addInitialActivities() {
            // Check if activities already exist
            const existingActivities = JSON.parse(localStorage.getItem('activities') || '[]');
            if (existingActivities.length > 0) {
                console.log('Activities already exist, skipping initial setup');
                return;
            }
            
            // Create some initial activities
            const initialActivities = [
                {
                    id: 'welcome_1',
                    type: 'add',
                    category: 'system',
                    title: 'System Initialized',
                    description: 'Uniform Guard system has been started',
                    details: 'Welcome to the Uniform Guard management system',
                    timestamp: new Date(),
                    user: 'System'
                },
                {
                    id: 'welcome_2',
                    type: 'add',
                    category: 'system',
                    title: 'Dashboard Loaded',
                    description: 'Guidance counselor dashboard is ready for use',
                    details: 'All systems operational and ready for data entry',
                    timestamp: new Date(Date.now() - 30000),
                    user: 'System'
                }
            ];
            
            localStorage.setItem('activities', JSON.stringify(initialActivities));
            console.log('Initial activities created');
        }

        function exportActivityLog() {
            const activities = JSON.parse(localStorage.getItem('activities') || '[]');
            const csvContent = [
                ['Timestamp', 'Type', 'Category', 'Title', 'Description', 'User'],
                ...activities.map(activity => [
                    activity.timestamp.toISOString(),
                    activity.type,
                    activity.category,
                    activity.title,
                    activity.description,
                    activity.user
                ])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'activity_log.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function clearActivityLog() {
            if (confirm('Are you sure you want to clear the activity log? This action cannot be undone.')) {
                const content = document.getElementById('activityLogContent');
                content.innerHTML = `
                    <div class="no-activities">
                        <div class="icon">üìã</div>
                        <h3>Activity Log Cleared</h3>
                        <p>All activities have been cleared from the log.</p>
                    </div>
                `;
            }
        }

        function searchActivities() {
            const searchTerm = document.getElementById('activitySearch').value.toLowerCase();
            const activityItems = document.querySelectorAll('.activity-item');
            
            activityItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        // Test function to add sample activities

        // Test function to test appeal modal

        // Get current user function
        function getCurrentUser() {
            // Try to get user from session data or use a default
            const userElement = document.querySelector('.user-info .user-name');
            if (userElement) {
                return userElement.textContent.trim();
            }
            // Fallback to session data if available
            return '{{ user.name }}' || 'Unknown User';
        }

        // Activity logging function
        function logActivity(type, category, title, description, details = '') {
            console.log(`[ACTIVITY LOG] Logging activity: ${type} - ${category} - ${title}`);
            
            const activity = {
                id: `${category}_${Date.now()}`,
                type: type,
                category: category,
                title: title,
                description: description,
                details: details,
                timestamp: new Date(),
                user: getCurrentUser() // Get actual current user
            };
            
            // Store in localStorage for persistence
            let activities = JSON.parse(localStorage.getItem('activities') || '[]');
            activities.unshift(activity); // Add to beginning
            activities = activities.slice(0, 100); // Keep only last 100 activities
            localStorage.setItem('activities', JSON.stringify(activities));
            
            console.log(`[ACTIVITY LOG] Activity stored. Total activities: ${activities.length}`);
            
            // If activity log tab is active, refresh it
            const activityTab = document.getElementById('activity');
            if (activityTab && activityTab.classList.contains('active')) {
                console.log('[ACTIVITY LOG] Activity tab is active, refreshing...');
                loadActivityLog();
            } else {
                console.log('[ACTIVITY LOG] Activity tab is not active');
            }
            
            // Activity logged successfully
        }

        // Function to check and log new violations from student_violations
        function checkAndLogNewViolations(violations) {
            if (!violations || !Array.isArray(violations)) {
                return;
            }

            // Get tracked violation IDs from localStorage
            const trackedViolations = JSON.parse(localStorage.getItem('trackedStudentViolations') || '[]');
            const trackedIds = new Set(trackedViolations);

            // Find new violations from student_violations collection
            const newViolations = violations.filter(violation => {
                // Check if violation is from student_violations collection
                // Violations from student_violations have source='student_violations' or reported_by='System'
                const isFromStudentViolations = violation.source === 'student_violations' || 
                                               violation.reported_by === 'System' ||
                                               (violation.id && !violation.reported_by);
                
                // Check if we haven't logged this violation yet
                const isNew = violation.id && !trackedIds.has(violation.id);
                
                return isFromStudentViolations && isNew;
            });

            // Log each new violation
            newViolations.forEach(violation => {
                const studentName = violation.student_name || 'Unknown Student';
                const studentId = violation.student_id || 'N/A';
                const violationType = violation.violation_type || 'Uniform Violation';
                const violationDate = violation.date || new Date().toLocaleDateString();

                logActivity(
                    'add',
                    'violation',
                    'Automatic Violation Detected',
                    `New violation automatically detected for ${studentName}`,
                    `Student: ${studentName} (ID: ${studentId}), Type: ${violationType}, Date: ${violationDate}, Source: Guard Detection System`
                );

                // Add to tracked violations
                trackedIds.add(violation.id);
                console.log(`[ACTIVITY LOG] Logged new automatic violation: ${violation.id} for ${studentName}`);
            });

            // Update tracked violations list (keep last 500 IDs)
            const updatedTracked = Array.from(trackedIds).slice(-500);
            localStorage.setItem('trackedStudentViolations', JSON.stringify(updatedTracked));

            if (newViolations.length > 0) {
                console.log(`[ACTIVITY LOG] Logged ${newViolations.length} new automatic violation(s) from student_violations collection`);
            }
        }

        function updateActivityCount() {
            const activities = JSON.parse(localStorage.getItem('activities') || '[]');
            const totalActivities = activities.length;
            
            const activityCountElement = document.getElementById('activityCount');
            if (activityCountElement) {
                activityCountElement.textContent = totalActivities;
            }
        }

        // Action functions
        function editViolation(id) {
            // Find the violation data from the table
            const table = document.getElementById('violationsTableBody');
            const rows = table.querySelectorAll('tr');
            
            for (let row of rows) {
                const editBtn = row.querySelector('button[onclick*="editViolation"]');
                if (editBtn && editBtn.getAttribute('onclick').includes(id)) {
                    const cells = row.querySelectorAll('td');
                    
                    // Populate the edit form with current data
                    document.getElementById('editViolationId').value = id;
                    document.getElementById('editStudentName').value = cells[0].textContent.trim();
                    document.getElementById('editStudentId').value = cells[1].textContent.trim();
                    document.getElementById('editEmailAddress').value = ''; // Default empty email
                    document.getElementById('editViolationType').value = cells[2].textContent.trim();
                    document.getElementById('editDescription').value = 'Violation details...'; // Default description
                    
                    // Extract status from the badge
                    const statusBadge = cells[3].querySelector('.status-badge');
                    const status = statusBadge ? statusBadge.textContent.trim() : 'Warning';
                    document.getElementById('editStatus').value = status;
                    
                    // Open the edit modal
                    openModal('editViolationModal');
                    break;
                }
            }
        }

        function deleteViolation(id) {
            if (confirm('Are you sure you want to delete this violation?')) {
                fetch(`/api/violations/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showAlert('Violation deleted successfully!', 'success');
                        
                        // Log activity
                        logActivity('delete', 'violation', 'Violation Deleted', `Violation ${id} deleted from system`, `ID: ${id}`);
                        
                        // Refresh the table immediately
                        refreshDataOnly();
                        
                        // Also refresh activity log if it's currently active
                        const activityTab = document.getElementById('activity');
                        if (activityTab && activityTab.classList.contains('active')) {
                            setTimeout(() => {
                                loadActivityLog();
                            }, 500);
                        }
                    } else {
                        showAlert('Error deleting violation: ' + (result.error || result.message || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    showAlert('Error deleting violation: ' + error.message, 'error');
                });
            }
        }

        function clearAllViolations() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL violations permanently!\n\nAre you absolutely sure you want to continue?')) {
                if (confirm('This action cannot be undone. Type "DELETE ALL" to confirm:')) {
                    // Get all violations first
                    fetch('/api/violations', {
                        credentials: 'same-origin'
                    })
                        .then(response => response.json())
                        .then(result => {
                            if (!result.success) {
                                showAlert('Error fetching violations: ' + (result.error || 'Unknown error'), 'error');
                                return;
                            }
                            
                            const violations = result.data || result;
                            if (!violations || !Array.isArray(violations) || violations.length === 0) {
                                showAlert('No violations to delete.', 'info');
                                return;
                            }
                            
                            // Delete all violations one by one
                            let deletePromises = violations.map(violation => 
                                fetch(`/api/violations/${violation.id}`, {
                                    method: 'DELETE'
                                })
                            );
                            
                            Promise.all(deletePromises)
                                .then(responses => {
                                    const results = responses.map(response => response.json());
                                    return Promise.all(results);
                                })
                                .then(results => {
                                    const successCount = results.filter(result => result.success).length;
                                    if (successCount === violations.length) {
                                        showAlert(`Successfully deleted ${successCount} violations!`, 'success');
                                        
                                        // Log activity
                                        logActivity('delete', 'violation', 'Bulk Violation Deletion', `All ${successCount} violations have been deleted`, `Total deleted: ${successCount} violations`);
                                        
                                        refreshDataOnly();
                                    } else {
                                        showAlert(`Deleted ${successCount} out of ${violations.length} violations. Some may have failed.`, 'warning');
                                        
                                        // Log activity
                                        logActivity('delete', 'violation', 'Partial Violation Deletion', `${successCount} out of ${violations.length} violations deleted`, `Successfully deleted: ${successCount}, Failed: ${violations.length - successCount}`);
                                        
                                        refreshDataOnly();
                                    }
                                })
                                .catch(error => {
                                    showAlert('Error clearing violations: ' + error.message, 'error');
                                });
                        })
                        .catch(error => {
                            showAlert('Error fetching violations: ' + error.message, 'error');
                        });
                }
            }
        }

        function clearAllAppeals() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL appeals permanently!\n\nAre you absolutely sure you want to continue?')) {
                if (confirm('This action cannot be undone. Type "DELETE ALL" to confirm:')) {
                    // Get all appeals first
                    fetch('/api/appeals', {
                        credentials: 'same-origin'
                    })
                        .then(response => response.json())
                        .then(result => {
                            if (!result.success) {
                                showAlert('Error fetching appeals: ' + (result.error || 'Unknown error'), 'error');
                                return;
                            }
                            
                            const appeals = result.data || result;
                            if (!appeals || !Array.isArray(appeals) || appeals.length === 0) {
                                showAlert('No appeals to delete.', 'info');
                                return;
                            }
                            
                            // Delete all appeals one by one
                            let deletePromises = appeals.map(appeal => 
                                fetch(`/api/appeals/${appeal.id}`, {
                                    method: 'DELETE'
                                })
                            );
                            
                            Promise.all(deletePromises)
                                .then(responses => {
                                    const results = responses.map(response => response.json());
                                    return Promise.all(results);
                                })
                                .then(results => {
                                    const successCount = results.filter(result => result.success).length;
                                    if (successCount === appeals.length) {
                                        showAlert(`Successfully deleted ${successCount} appeals!`, 'success');
                                        
                                        // Log activity
                                        logActivity('delete', 'appeal', 'Bulk Appeal Deletion', `All ${successCount} appeals have been deleted`, `Total deleted: ${successCount} appeals`);
                                        
                                        location.reload();
                                    } else {
                                        showAlert(`Deleted ${successCount} out of ${appeals.length} appeals. Some may have failed.`, 'warning');
                                        
                                        // Log activity
                                        logActivity('delete', 'appeal', 'Partial Appeal Deletion', `${successCount} out of ${appeals.length} appeals deleted`, `Successfully deleted: ${successCount}, Failed: ${appeals.length - successCount}`);
                                        
                                        location.reload();
                                    }
                                })
                                .catch(error => {
                                    showAlert('Error clearing appeals: ' + error.message, 'error');
                                });
                        })
                        .catch(error => {
                            showAlert('Error fetching appeals: ' + error.message, 'error');
                        });
                }
            }
        }

        function clearAllDesigns() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL designs permanently!\n\nAre you absolutely sure you want to continue?')) {
                if (confirm('This action cannot be undone. Type "DELETE ALL" to confirm:')) {
                    // Get all designs first
                    fetch('/api/designs', {
                        credentials: 'same-origin'
                    })
                        .then(response => response.json())
                        .then(result => {
                            if (!result.success) {
                                showAlert('Error fetching designs: ' + (result.error || 'Unknown error'), 'error');
                                return;
                            }
                            
                            const designs = result.data || result;
                            if (!designs || !Array.isArray(designs) || designs.length === 0) {
                                showAlert('No designs to delete.', 'info');
                                return;
                            }
                            
                            // Delete all designs one by one
                            let deletePromises = designs.map(design => 
                                fetch(`/api/designs/${design.id}`, {
                                    method: 'DELETE'
                                })
                            );
                            
                            Promise.all(deletePromises)
                                .then(responses => {
                                    const results = responses.map(response => response.json());
                                    return Promise.all(results);
                                })
                                .then(results => {
                                    const successCount = results.filter(result => result.success).length;
                                    if (successCount === designs.length) {
                                        showAlert(`Successfully deleted ${successCount} designs!`, 'success');
                                        
                                        // Log activity
                                        logActivity('delete', 'design', 'Bulk Design Deletion', `All ${successCount} designs have been deleted`, `Total deleted: ${successCount} designs`);
                                        
                                        location.reload();
                                    } else {
                                        showAlert(`Deleted ${successCount} out of ${designs.length} designs. Some may have failed.`, 'warning');
                                        
                                        // Log activity
                                        logActivity('delete', 'design', 'Partial Design Deletion', `${successCount} out of ${designs.length} designs deleted`, `Successfully deleted: ${successCount}, Failed: ${designs.length - successCount}`);
                                        
                                        location.reload();
                                    }
                                })
                                .catch(error => {
                                    showAlert('Error clearing designs: ' + error.message, 'error');
                                });
                        })
                        .catch(error => {
                            showAlert('Error fetching designs: ' + error.message, 'error');
                        });
                }
            }
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è CRITICAL WARNING: This will delete ALL data permanently!\n\nThis includes:\n- All Violations\n- All Appeals\n- All Designs\n\nAre you absolutely sure you want to continue?')) {
                if (confirm('This action cannot be undone and will clear your entire database!\n\nType "DELETE EVERYTHING" to confirm:')) {
                    // Clear all violations
                    fetch('/api/violations', {
                        credentials: 'same-origin'
                    })
                        .then(response => response.json())
                        .then(violationResult => {
                            const violations = violationResult.data || violationResult;
                            const violationPromises = Array.isArray(violations) ? violations.map(violation => 
                                fetch(`/api/violations/${violation.id}`, { method: 'DELETE', credentials: 'same-origin' })
                            ) : [];
                            
                            // Clear all appeals
                            return fetch('/api/appeals', {
                                credentials: 'same-origin'
                            })
                                .then(response => response.json())
                                .then(appealResult => {
                                    const appeals = appealResult.data || appealResult;
                                    const appealPromises = Array.isArray(appeals) ? appeals.map(appeal => 
                                        fetch(`/api/appeals/${appeal.id}`, { method: 'DELETE', credentials: 'same-origin' })
                                    ) : [];
                                    
                                    // Clear all designs
                                    return fetch('/api/designs', {
                                        credentials: 'same-origin'
                                    })
                                        .then(response => response.json())
                                        .then(designResult => {
                                            const designs = designResult.data || designResult;
                                            const designPromises = Array.isArray(designs) ? designs.map(design => 
                                                fetch(`/api/designs/${design.id}`, { method: 'DELETE', credentials: 'same-origin' })
                                            ) : [];
                                            
                                            // Execute all deletions
                                            return Promise.all([
                                                ...violationPromises,
                                                ...appealPromises,
                                                ...designPromises
                                            ]);
                                        });
                                });
                        })
                        .then(() => {
                            showAlert('All data has been cleared successfully!', 'success');
                            location.reload();
                        })
                        .catch(error => {
                            showAlert('Error clearing data: ' + error.message, 'error');
                        });
                }
            }
        }

        function approveAppeal(id) {
            if (confirm('Are you sure you want to approve this appeal?')) {
                fetch(`/api/appeals/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ status: 'Approved' })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        if (result.violation_deleted) {
                            showAlert('Appeal approved successfully! Related violation has been automatically deleted.', 'success');
                            
                            // Log activity
                            logActivity('edit', 'appeal', 'Appeal Approved', `Appeal with ID ${id} has been approved`, `Status: Approved, Related violation deleted`);
                        } else {
                            showAlert('Appeal approved successfully!', 'success');
                            
                            // Log activity
                            logActivity('edit', 'appeal', 'Appeal Approved', `Appeal with ID ${id} has been approved`, `Status: Approved`);
                        }
                        reapplyGrouping();
                        refreshDataOnly(); // Use the new refresh function that maintains current tab
                    } else {
                        showAlert('Error approving appeal: ' + (result.error || result.message || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    showAlert('Error approving appeal: ' + error.message, 'error');
                });
            }
        }



        function viewAppeal(id) {
            console.log('View appeal called with ID:', id);
            
            // Get appeals data
            let appealsData = window.currentAppealsData || [];
            
            // Find appeal by ID
            let appeal = appealsData.find(a => a.id === id || a.id === String(id));
            
            if (appeal) {
                showAppealDetailsModal(appeal);
            } else {
                alert('Appeal not found. Please refresh the page to load data.');
            }
        }
        

        // Function to load appeals data
        function loadAppealsData() {
            console.log('Loading appeals data...');
            return fetch('/api/appeals', {
                credentials: 'same-origin',
                cache: 'no-cache'
            })
            .then(response => {
                console.log('Appeals API response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('Appeals API response data:', result);
                let appealsData = null;
                if (result.success && result.data) {
                    appealsData = result.data;
                } else if (Array.isArray(result)) {
                    appealsData = result;
                }
                
                // Store appeals data globally
                window.currentAppealsData = appealsData || [];
                console.log('Stored appeals data:', window.currentAppealsData);
                return window.currentAppealsData;
            })
            .catch(error => {
                console.error('Error loading appeals data:', error);
                window.currentAppealsData = [];
                return [];
            });
        }

        // Debug function to show appeals data
        function debugAppealsData() {
            console.log('=== DEBUG: Appeals Data ===');
            console.log('Current appeals data:', window.currentAppealsData);
            console.log('Number of appeals:', window.currentAppealsData ? window.currentAppealsData.length : 0);
            if (window.currentAppealsData && window.currentAppealsData.length > 0) {
                console.log('First appeal:', window.currentAppealsData[0]);
                console.log('All appeal IDs:', window.currentAppealsData.map(a => a.id));
            }
            
            // Also check the actual table buttons
            const viewButtons = document.querySelectorAll('.view-btn');
            console.log('Found view buttons in table:', viewButtons.length);
            viewButtons.forEach((btn, index) => {
                console.log(`Button ${index} onclick:`, btn.getAttribute('onclick'));
            });
        }

        // Test function to verify viewAppeal is working
        function testViewAppeal() {
            console.log('Testing viewAppeal function...');
            debugAppealsData();
            
            // First try to use existing data
            let appealsData = window.currentAppealsData || [];
            
            if (appealsData.length > 0) {
                const testId = appealsData[0].id;
                console.log('Testing with existing appeal ID:', testId);
                viewAppeal(testId);
            } else {
                console.log('No appeals data in memory, loading from API...');
                // Load data from API
                loadAppealsData().then(loadedData => {
                    console.log('Loaded data:', loadedData);
                    debugAppealsData();
                    if (loadedData.length > 0) {
                        const testId = loadedData[0].id;
                        console.log('Testing with loaded appeal ID:', testId);
                        viewAppeal(testId);
                    } else {
                        console.log('No appeals data available for testing');
                        alert('No appeals data available for testing. Please add some appeals first.');
                    }
                });
            }
        }
        
        
        function showAppealDetailsModal(appeal) {
            console.log('Showing appeal details modal for:', appeal);
            
            // Remove any existing modal
            const existingModal = document.getElementById('appealDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal HTML
            const modalHtml = `
                <div id="appealDetailsModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    z-index: 9999;
                    display: block;
                ">
                    <div style="
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border-radius: 10px;
                        max-width: 600px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    ">
                        <!-- Header -->
                        <div style="
                            background: #1877f2;
                            color: white;
                            padding: 20px;
                            border-radius: 10px 10px 0 0;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h3 style="margin: 0; font-size: 20px;">üìã Appeal Details</h3>
                            <button onclick="closeAppealDetailsModal()" style="
                                background: rgba(255,255,255,0.2);
                                color: white;
                                border: none;
                                width: 30px;
                                height: 30px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 18px;
                            ">&times;</button>
                        </div>
                        
                        <!-- Content -->
                        <div style="padding: 15px;">
                            <!-- Student Info -->
                            <div style="background: #e3f2fd; padding: 12px 15px; border-radius: 6px; border-left: 4px solid #1877f2; margin-bottom: 15px;">
                                <div style="font-size: 12px; color: #1877f2; font-weight: 600; margin-bottom: 4px;">STUDENT</div>
                                <div style="font-size: 15px; font-weight: 600; color: #333;">${appeal.student_name || 'N/A'}</div>
                                <div style="font-size: 12px; color: #666; margin-top: 2px;">ID: ${appeal.student_id || 'N/A'}</div>
                            </div>
                            
                            <!-- Status and Reason Type Side by Side -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <!-- Status -->
                                <div style="background: #f8f9fa; padding: 12px 15px; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #1877f2; font-weight: 600; margin-bottom: 8px;">STATUS</div>
                                    <span style="padding: 6px 12px; border-radius: 12px; font-size: 13px; font-weight: 600; 
                                        background: ${appeal.status === 'Approved' ? '#d4edda' : appeal.status === 'Rejected' ? '#f8d7da' : '#fff3cd'}; 
                                        color: ${appeal.status === 'Approved' ? '#155724' : appeal.status === 'Rejected' ? '#721c24' : '#856404'};">
                                        ${appeal.status || 'Pending Review'}
                                    </span>
                                </div>
                                
                                <!-- Reason Type -->
                                <div style="background: #f8f9fa; padding: 12px 15px; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #1877f2; font-weight: 600; margin-bottom: 8px;">REASON TYPE</div>
                                    ${appeal.status === 'Approved' ? 
                                        `<span style="padding: 6px 12px; border-radius: 4px; font-size: 13px; font-weight: 600;
                                            background: ${(appeal.reason_type || 'Unexcused') === 'Excused' ? '#d4edda' : '#f8d7da'}; 
                                            color: ${(appeal.reason_type || 'Unexcused') === 'Excused' ? '#155724' : '#721c24'};">
                                            ${appeal.reason_type || 'Unexcused'}
                                        </span>` :
                                        `<select id="appealReasonTypeSelect" style="
                                            width: 100%;
                                            padding: 8px 10px;
                                            border: 2px solid #e3f2fd;
                                            border-radius: 5px;
                                            font-size: 14px;
                                            background: white;
                                            color: #333;
                                            cursor: pointer;
                                        ">
                                            <option value="Excused" ${(appeal.reason_type || 'Unexcused') === 'Excused' ? 'selected' : ''}>Excused</option>
                                            <option value="Unexcused" ${(appeal.reason_type || 'Unexcused') === 'Unexcused' ? 'selected' : ''}>Unexcused</option>
                                        </select>`
                                    }
                                </div>
                            </div>
                            
                            <!-- Reason Description -->
                            <div style="background: #f8f9fa; padding: 12px 15px; border-radius: 6px; border-left: 3px solid #1877f2; margin-bottom: 15px;">
                                <div style="font-size: 12px; color: #1877f2; font-weight: 600; margin-bottom: 8px;">REASON DESCRIPTION</div>
                                <p style="margin: 0; line-height: 1.5; color: #333; font-size: 14px; white-space: pre-wrap;">${appeal.appeal_reason || appeal.reason || 'No reason provided'}</p>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div style="
                            background: #f8f9fa;
                            padding: 15px 20px;
                            border-top: 1px solid #e4e6ea;
                            text-align: center;
                            border-radius: 0 0 10px 10px;
                            display: flex;
                            gap: 10px;
                            justify-content: center;
                        ">
                            ${appeal.status !== 'Approved' ? `
                                <button onclick="approveAppealFromModal('${appeal.id}')" style="
                                    background: #28a745;
                                    color: white;
                                    border: none;
                                    padding: 10px 20px;
                                    border-radius: 5px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 600;
                                ">‚úì Approve Appeal</button>
                            ` : ''}
                            <button onclick="closeAppealDetailsModal()" style="
                                background: #6c757d;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 14px;
                            ">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            console.log('Appeal details modal created and displayed');
        }

        function closeAppealDetailsModal() {
            const modal = document.getElementById('appealDetailsModal');
            if (modal) {
                modal.remove();
            }
        }
        
        


        function editAppeal(id) {
            console.log('editAppeal function called with id:', id);
            
            // Close details modal if open
            closeAppealDetailsModal();
            
            // Fetch appeal data from API
            fetch('/api/appeals', {
                credentials: 'same-origin'
            })
                .then(response => response.json())
                .then(result => {
                    let appealsData = null;
                    if (result.success && result.data) {
                        appealsData = result.data;
                    } else if (Array.isArray(result)) {
                        appealsData = result;
                    }
                    
                    if (appealsData) {
                        const appeal = appealsData.find(a => a.id === id);
                        if (appeal) {
                            // Populate the edit form with current data
                            document.getElementById('editAppealId').value = id;
                            document.getElementById('editAppealStudentName').value = appeal.student_name || '';
                            document.getElementById('editAppealReasonType').value = appeal.reason_type || 'Unexcused';
                            document.getElementById('editAppealReason').value = appeal.appeal_reason || appeal.reason || '';
                            document.getElementById('editAppealStatus').value = appeal.status || 'Pending Review';
                            document.getElementById('editAppealDate').value = appeal.submitted_date || appeal.appeal_date || '';
                            document.getElementById('editAppealSubmittedBy').value = appeal.submitted_by || '';
                            
                            // Open the edit modal
                            openModal('editAppealModal');
                        } else {
                            showAlert('Appeal not found', 'error');
                        }
                    } else {
                        showAlert('Error fetching appeal data', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error fetching appeal:', error);
                    showAlert('Error fetching appeal: ' + error.message, 'error');
                });
        }

        function approveDesign(id) {
            if (confirm('Are you sure you want to approve this design?')) {
                fetch(`/api/designs/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: 'APPROVED' })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showAlert('Design approved successfully!', 'success');
                        
                        // Log activity
                        logActivity('edit', 'design', 'Design Approved', `Design with ID ${id} has been approved`, `Status: Approved`);
                        
                        reapplyGrouping();
                        refreshDataOnly(); // Use the new refresh function that maintains current tab
                    } else {
                        showAlert('Error approving design: ' + (result.error || result.message || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    showAlert('Error approving design: ' + error.message, 'error');
                });
            }
        }


        function deleteDesign(id) {
            if (confirm('Are you sure you want to delete this design?')) {
                fetch(`/api/designs/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showAlert('Design deleted successfully!', 'success');
                        
                        // Log activity
                        logActivity('delete', 'design', 'Design Deleted', `Uniform design with ID ${id} has been deleted`, `ID: ${id}`);
                        
                        refreshDataOnly();
                    } else {
                        showAlert('Error deleting design: ' + (result.error || result.message || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    showAlert('Error deleting design: ' + error.message, 'error');
                });
            }
        }

        function viewDesignDetails(id) {
            // Get all designs from the current page data
            const designs = {{ designs | tojson }};
            console.log('All designs:', designs);
            console.log('Looking for design with ID:', id);
            
            const design = designs.find(d => d.id === id || d._id === id);
            console.log('Found design:', design);
            
            if (!design) {
                showAlert('Design not found!', 'error');
                return;
            }
            
            // Populate the modal with design details
            document.getElementById('detailDesignName').textContent = design.name || 'Unknown Design';
            document.getElementById('detailDesignType').textContent = design.type || 'Unknown Type';
            document.getElementById('detailDesignStatus').textContent = design.status || 'Unknown Status';
            document.getElementById('detailDesignDate').textContent = design.created_date || design.submitted_date || 'Unknown Date';
            
            // Handle image display
            const imageElement = document.getElementById('designImage');
            const noImageMessage = document.getElementById('noImageMessage');
            
            console.log('Design image_url:', design.image_url);
            console.log('Image URL type:', typeof design.image_url);
            console.log('Image URL length:', design.image_url ? design.image_url.length : 'null');
            
            if (design.image_url && design.image_url.trim() !== '') {
                console.log('Setting image source to:', design.image_url);
                imageElement.src = design.image_url;
                imageElement.style.display = 'block';
                noImageMessage.style.display = 'none';
            } else {
                console.log('No image URL found, showing no image message');
                imageElement.style.display = 'none';
                noImageMessage.style.display = 'block';
            }
            
            // Show the modal
            openModal('designDetailsModal');
        }

        function exportData(type) {
            showAlert('Export functionality coming soon!', 'success');
        }

        // Alert system
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function refreshCurrentTab() {
            // Get the currently active tab
            const activeTab = document.querySelector('.tab-content.active');
            if (!activeTab) return;

            const tabId = activeTab.id;
            
            // Store the current tab in sessionStorage
            sessionStorage.setItem('activeTab', tabId);
            
            // Reload immediately without additional loading screens
            location.reload();
        }

        function refreshViolationCounts() {
            // Recalculate violation counts after data changes
            setTimeout(() => {
                calculateViolationCounts();
            }, 300);
        }

        function refreshDataOnly() {
            // Refresh data without page reload
            console.log('Refreshing data without page reload...');
            console.log('Current time:', new Date().toISOString());
            
            // Show loading indicator
            showLoading();
            
            // Track if any requests fail
            let hasErrors = false;
            
            // Force clear any existing cache
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    names.forEach(function(name) {
                        caches.delete(name);
                    });
                });
            }
            
            // Fetch fresh violations data with cache busting
            fetch('/api/violations?t=' + Date.now(), {
                credentials: 'same-origin',
                cache: 'no-cache'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.success && result.data) {
                        console.log('Fresh violations data:', result.data);
                        console.log('Updating violations table with', result.data.length, 'violations');
                        // Check and log new violations from student_violations
                        checkAndLogNewViolations(result.data);
                        // Update the violations table
                        updateViolationsTable(result.data);
                        // Recalculate counts and grouping
                        calculateViolationCounts();
                        groupViolationRows();
                        groupAppealRows();
                    } else if (Array.isArray(result)) {
                        console.log('Fresh violations data (array):', result);
                        // Check and log new violations from student_violations
                        checkAndLogNewViolations(result);
                        updateViolationsTable(result);
                        calculateViolationCounts();
                        groupViolationRows();
                        groupAppealRows();
                    }
                })
                .catch(error => {
                    console.error('Error refreshing violations data:', error);
                    hasErrors = true;
                });
            
            // Also fetch fresh appeals data with cache busting
            fetch('/api/appeals?t=' + Date.now(), {
                credentials: 'same-origin',
                cache: 'no-cache'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.success && result.data) {
                        console.log('Fresh appeals data:', result.data);
                        console.log('Updating appeals table with', result.data.length, 'appeals');
                        // Update the appeals table
                        updateAppealsTable(result.data);
                        groupAppealRows();
                    } else if (Array.isArray(result)) {
                        console.log('Fresh appeals data (array):', result);
                        updateAppealsTable(result);
                        groupAppealRows();
                    }
                })
                .catch(error => {
                    console.error('Error refreshing appeals data:', error);
                    hasErrors = true;
                })
                .finally(() => {
                    hideLoading();
                    console.log('Data refresh completed');
                    showAlert('Data refreshed successfully!', 'success');
                });
        }

        function updateViolationsTable(violations) {
            console.log('updateViolationsTable called with:', violations);
            console.log('Number of violations to display:', violations ? violations.length : 0);
            console.log('Timestamp:', new Date().toISOString());
            
            // Check and log new violations from student_violations (if not already checked)
            if (violations && Array.isArray(violations)) {
                checkAndLogNewViolations(violations);
            }
            
            const tableBody = document.getElementById('violationsTableBody');
            if (!tableBody) {
                console.error('Violations table body not found');
                return;
            }
            
            console.log('Found violations table body, updating...');
            
            // Clear existing content
            tableBody.innerHTML = '';
            
            // Group violations by student to calculate counts
            const studentViolationCounts = {};
            violations.forEach(violation => {
                const studentName = violation.student_name;
                studentViolationCounts[studentName] = (studentViolationCounts[studentName] || 0) + 1;
            });
            
            // Add new rows
            violations.forEach(violation => {
                const row = document.createElement('tr');
                row.className = 'violation-row';
                row.setAttribute('data-student', violation.student_name);
                row.setAttribute('data-violation-id', violation.id);
                
                // Calculate status based on student's total violation count
                const studentCount = studentViolationCounts[violation.student_name] || 1;
                const status = getViolationStatus(studentCount);
                const statusClass = status.toLowerCase().replace(/\s+/g, '-');
                
                row.innerHTML = `
                    <td class="student-name-cell">
                        ${violation.student_name}
                    </td>
                    <td class="student-id-cell">
                        ${violation.student_id || 'No ID'}
                    </td>
                    <td>${violation.violation_type || 'Incomplete Uniform'}</td>
                    <td><span class="status-badge status-${statusClass}">${status}</span></td>
                    <td class="count-cell">
                        <span class="violation-count-badge">
                            <!-- Offense will be populated by JavaScript -->
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteViolation('${violation.id}')">Delete</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            console.log(`Updated violations table with ${violations.length} violations`);
        }

        function updateAppealsTable(appeals) {
            console.log('Updating appeals table with:', appeals);
            console.log('Appeals data structure:', appeals.map(a => ({id: a.id, student_name: a.student_name, has_id: !!a.id})));
            
            // Store appeals data globally for testing
            window.currentAppealsData = appeals;
            
            const tableBody = document.getElementById('appealsTableBody');
            if (!tableBody) {
                console.error('Appeals table body not found');
                return;
            }
            
            // Clear existing content
            tableBody.innerHTML = '';
            
            // Add new rows
            appeals.forEach((appeal, index) => {
                console.log(`Processing appeal ${index}:`, {id: appeal.id, student_name: appeal.student_name, has_id: !!appeal.id});
                const row = document.createElement('tr');
                row.className = 'appeal-row';
                row.setAttribute('data-student', appeal.student_name);
                row.setAttribute('data-appeal-id', appeal.id);
                
                row.innerHTML = `
                    <td style="text-align: left; vertical-align: middle; padding-right: 8px;">
                        <div class="student-info">
                            <span class="clickable-student-name" onclick="console.log('Dynamic student name clicked for appeal ID:', '${appeal.id || 'unknown'}'); viewAppealDetails('${appeal.id || 'unknown'}')" title="Click to view appeal details for ${appeal.student_name}">
                                ${appeal.student_name}
                            </span>
                            ${appeal.created_automatically ? '<span class="auto-badge" title="Auto-created from violation">ü§ñ</span>' : ''}
                        </div>
                    </td>
                    <td style="text-align: left; vertical-align: middle; padding-left: 8px; width: 120px;">
                        <span style="color: #666; font-size: 14px;">${appeal.student_id || 'N/A'}</span>
                    </td>
                    <td style="text-align: center; vertical-align: middle;">
                        <button class="btn btn-primary btn-sm view-btn" onclick="viewAppealDetails('${appeal.id || 'unknown'}')" title="View appeal details">
                            View
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            console.log(`Updated appeals table with ${appeals.length} appeals`);
            
            // Add event listeners to the new view buttons
            setTimeout(() => {
            }, 100);
        }

        function calculateViolationCounts() {
            // First try to get fresh data from API
            fetch('/api/violations', {
                credentials: 'same-origin'
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data) {
                        console.log('Fresh violations data:', result.data);
                        buildGroupedViolationsTable(result.data);
                    } else {
                        // Fallback to grouping existing rows
                        groupViolationRows();
                    }
                })
                .catch(error => {
                    console.error('Error fetching fresh violations:', error);
                    // Fallback to grouping existing rows
                    groupViolationRows();
                });
        }

        function groupViolationRows() {
            const tableBody = document.getElementById('violationsTableBody');
            if (!tableBody) return;

            const rows = Array.from(tableBody.querySelectorAll('.violation-row'));
            if (rows.length === 0) return;

            console.log('Found violation rows:', rows.length);

            // Group rows by student name
            const groupedRows = {};
            rows.forEach(row => {
                const studentName = row.dataset.student;
                if (!groupedRows[studentName]) {
                    groupedRows[studentName] = [];
                }
                groupedRows[studentName].push(row);
            });

            console.log('Grouped by student:', Object.keys(groupedRows));

            // Clear table body completely
            tableBody.innerHTML = '';

            // Sort students by violation count (highest to lowest)
            const sortedStudents = Object.keys(groupedRows).sort((a, b) => {
                const countA = groupedRows[a].length;
                const countB = groupedRows[b].length;
                return countB - countA; // Descending order (3rd offense first)
            });

            console.log('Sorted students by violation count:', sortedStudents);

            // Create one row per student in sorted order
            sortedStudents.forEach(studentName => {
                const studentViolations = groupedRows[studentName];
                const count = studentViolations.length;
                
                console.log(`Student: ${studentName}, Violations: ${count}`);
                
                // Get the most recent violation for display
                const latestViolation = studentViolations[studentViolations.length - 1];
                const latestCells = latestViolation.querySelectorAll('td');
                
                // Create main student row (non-clickable)
                const studentRow = document.createElement('tr');
                studentRow.className = `student-row ${getRowClass(count)}`;
                
                studentRow.innerHTML = `
                    <td class="student-name-cell">
                        <strong>${studentName}</strong>
                    </td>
                    <td class="student-id-cell">${latestCells[1]?.textContent?.trim() || 'No ID'}</td>
                    <td>${latestCells[2]?.textContent?.trim() || 'Multiple Types'}</td>
                    <td>${latestCells[3]?.innerHTML || '<span class="status-badge status-active">Active</span>'}</td>
                    <td class="count-cell">
                        <span class="violation-count-badge ${getCountClass(count)}">${getCountText(count)}</span>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); viewStudentViolations('${studentName}')">View</button>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteAllStudentViolations('${studentName}')">Delete</button>
                    </td>
                `;
                
                tableBody.appendChild(studentRow);
            });
        }

        function buildGroupedViolationsTable(violations) {
            console.log('Building grouped violations table with:', violations);
            const tableBody = document.getElementById('violationsTableBody');
            if (!tableBody) {
                console.error('Table body not found!');
                return;
            }

            // Group violations by student
            const groupedViolations = {};
            violations.forEach(violation => {
                const studentName = violation.student_name;
                if (!groupedViolations[studentName]) {
                    groupedViolations[studentName] = [];
                }
                groupedViolations[studentName].push(violation);
            });

            console.log('Grouped violations:', groupedViolations);

            // Clear existing content
            tableBody.innerHTML = '';

            // Sort students by violation count (highest to lowest)
            const sortedStudents = Object.keys(groupedViolations).sort((a, b) => {
                const countA = groupedViolations[a].length;
                const countB = groupedViolations[b].length;
                return countB - countA; // Descending order (3rd offense first)
            });

            console.log('Sorted students by violation count:', sortedStudents);

            // Create rows for each student in sorted order
            sortedStudents.forEach(studentName => {
                const studentViolations = groupedViolations[studentName];
                const count = studentViolations.length;
                
                // Create student row
                const studentRow = document.createElement('tr');
                studentRow.className = `student-row ${getRowClass(count)}`;
                
                // Get latest violation for summary
                const latestViolation = studentViolations[studentViolations.length - 1];
                
                // Calculate status based on violation count
                const status = getViolationStatus(count);
                const statusClass = status.toLowerCase().replace(/\s+/g, '-');
                
                studentRow.innerHTML = `
                    <td class="student-name-cell">
                        <strong>${studentName}</strong>
                    </td>
                    <td class="student-id-cell">${latestViolation.student_id || 'No ID'}</td>
                    <td>${latestViolation.violation_type || 'Multiple'}</td>
                    <td><span class="status-badge status-${statusClass}">${status}</span></td>
                    <td class="count-cell">
                        <span class="violation-count-badge ${getCountClass(count)}">${getCountText(count)}</span>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewStudentViolations('${studentName}')">View</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAllStudentViolations('${studentName}')">Delete</button>
                    </td>
                `;
                
                tableBody.appendChild(studentRow);
                
                // Create details row
                const detailsRow = document.createElement('tr');
                detailsRow.className = 'violation-details-row';
                detailsRow.id = `details-${studentName.replace(/\s+/g, '-')}`;
                
                const detailsCell = document.createElement('td');
                detailsCell.className = 'violation-details-cell';
                detailsCell.colSpan = 7;
                
                let detailsHtml = '<div style="margin-bottom: 10px;"><strong>All Violations for ' + studentName + ':</strong></div>';
                studentViolations.forEach((violation, index) => {
                    // Format date and time from last_updated
                    let dateDisplay = '';
                    let timeDisplay = '';
                    if (violation.last_updated) {
                        try {
                            // Parse last_updated format: "YYYY-MM-DD HH:MM:SS"
                            const lastUpdated = violation.last_updated;
                            const dateTimeParts = lastUpdated.split(' ');
                            if (dateTimeParts.length >= 2) {
                                const datePart = dateTimeParts[0];
                                const timePart = dateTimeParts[1];
                                // Format date as MM/DD/YYYY
                                const dateObj = new Date(datePart + 'T' + timePart);
                                dateDisplay = dateObj.toLocaleDateString('en-US', {month: '2-digit', day: '2-digit', year: 'numeric'});
                                // Format time as HH:MM
                                timeDisplay = timePart.substring(0, 5);
                            }
                        } catch (e) {
                            console.error('Error parsing last_updated:', e);
                        }
                    }
                    // Fallback to date field if last_updated is not available
                    if (!dateDisplay && violation.date) {
                        try {
                            const dateObj = new Date(violation.date);
                            dateDisplay = dateObj.toLocaleDateString('en-US', {month: '2-digit', day: '2-digit', year: 'numeric'});
                        } catch (e) {
                            dateDisplay = violation.date;
                        }
                    }
                    
                    detailsHtml += `
                        <div class="violation-item">
                            <div class="violation-info">
                                <strong>${violation.violation_type || 'Unknown Type'}</strong> - 
                                <span class="status-badge status-${(violation.status || 'Active').toLowerCase()}">${violation.status || 'Active'}</span>
                                ${dateDisplay ? `<div style="margin-top: 5px; color: #666; font-size: 12px; text-align: center;">
                                    <div>${dateDisplay}</div>
                                    ${timeDisplay ? `<div style="color: rgba(255, 255, 255, 0.6); font-size: 11px; text-align: center; margin-top: 2px; opacity: 0.7;">${timeDisplay}</div>` : ''}
                                </div>` : ''}
                            </div>
                            <div class="violation-actions">
                                <button class="btn btn-sm btn-secondary" onclick="editViolation('${violation.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteViolation('${violation.id}')">Delete</button>
                            </div>
                        </div>
                    `;
                });
                
                detailsCell.innerHTML = detailsHtml;
                detailsRow.appendChild(detailsCell);
                tableBody.appendChild(detailsRow);
            });
        }

        function buildGroupedViolationsTableFromTable() {
            // Fallback method to build from existing table
            const table = document.getElementById('violationsTableBody');
            if (!table) return;

            const rows = table.querySelectorAll('tr');
            const violations = [];

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 6) {
                    violations.push({
                        id: row.dataset.id || Math.random().toString(36).substr(2, 9),
                        student_name: cells[0]?.textContent?.trim(),
                        student_id: cells[1]?.textContent?.trim(),
                        violation_type: cells[2]?.textContent?.trim(),
                        status: cells[3]?.textContent?.trim()
                    });
                }
            });

            buildGroupedViolationsTable(violations);
        }

        function getCountClass(count) {
            if (count >= 3) return 'max-violations';      // Red for Guidance (3+)
            if (count === 2) return 'normal-violations';  // Orange for Advisory (2)
            if (count === 1) return 'warning-violations'; // Yellow for Warning (1)
            return 'normal-violations';
        }
        
        function getCountText(count) {
            if (count >= 3) return `${getOrdinalNumber(count)} (MAX)`;
            return getOrdinalNumber(count);
        }
        
        function getOrdinalNumber(num) {
            if (num >= 11 && num <= 13) {
                return num + 'th';
            }
            switch (num % 10) {
                case 1: return num + 'st';
                case 2: return num + 'nd';
                case 3: return num + 'rd';
                default: return num + 'th';
            }
        }
        
        function getRowClass(count) {
            if (count >= 3) return 'guidance-violations-row';
            if (count === 2) return 'advisory-violations-row';
            if (count === 1) return 'warning-violations-row';
            return '';
        }
        
        function getViolationStatus(count) {
            if (count >= 3) return 'Guidance';
            if (count === 2) return 'Advisory';
            if (count === 1) return 'Warning';
            return 'No Violations';
        }


        function viewAppealDetails(appealId) {
            console.log('=== VIEW APPEAL DETAILS CALLED ===');
            console.log('Appeal ID:', appealId);
            
            // Show immediate feedback
            showAlert(`Loading appeal details for ID: ${appealId}`, 'info');
            
            try {
                // Get appeals data
                const appealsData = window.currentAppealsData || [];
                console.log('Available appeals data:', appealsData);
                console.log('Number of appeals:', appealsData.length);
                
                if (appealsData.length === 0) {
                    showAlert('No appeals data available. Please refresh the page.', 'warning');
                    return;
                }
                
                // Find the specific appeal
                const appeal = appealsData.find(a => {
                    console.log('Checking appeal:', a.id, 'against:', appealId);
                    return a.id === appealId || a.id === String(appealId) || a.id === parseInt(appealId);
                });
                
                console.log('Found appeal:', appeal);
                
                if (appeal) {
                    console.log('Showing appeal details modal');
                    showAppealDetailsModal(appeal);
                } else {
                    console.log('Appeal not found in current data, showing simple modal');
                    // Show a simple modal with basic info
                    showSimpleAppealModal(appealId);
                }
            } catch (error) {
                console.error('Error in viewAppealDetails:', error);
                showAlert('Error loading appeal details: ' + error.message, 'error');
            }
        }

        function showSimpleAppealModal(appealId) {
            console.log('Showing simple appeal modal for ID:', appealId);
            
            // Create a simple modal
            const modal = document.createElement('div');
            modal.id = 'simpleAppealModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 25px;
                    border-radius: 10px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                ">
                    <h3 style="margin-top: 0; color: #333; margin-bottom: 20px; text-align: center;">Appeal Details</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="margin: 8px 0;"><strong>Appeal ID:</strong> ${appealId}</p>
                        <p style="margin: 8px 0;"><strong>Status:</strong> Loading...</p>
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #1877f2;">
                        <p style="margin: 0; color: #666; font-size: 14px; text-align: center;">Loading appeal details...</p>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="document.getElementById('simpleAppealModal').remove()" 
                                style="
                                    background: #1877f2;
                                    color: white;
                                    border: none;
                                    padding: 10px 20px;
                                    border-radius: 5px;
                                    cursor: pointer;
                                ">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Try to fetch more details
            fetch(`/api/appeals/${appealId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.appeal) {
                        const appeal = data.appeal;
                        const appealDate = appeal.status === 'Approved' && appeal.approved_date 
                            ? new Date(appeal.approved_date).toLocaleDateString() 
                            : appeal.date || appeal.created_date || appeal.submitted_date || 'Not specified';
                        const reasonType = appeal.reason_type || 'Not specified';
                        const reason = appeal.reason || appeal.appeal_reason || 'No reason provided';
                        
                        // Update the modal content with only required fields
                        const status = appeal.status || 'Unknown';
                        
                        modal.innerHTML = `
                            <div style="
                                background: white;
                                padding: 25px;
                                border-radius: 10px;
                                max-width: 600px;
                                width: 90%;
                                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                            ">
                                <h3 style="margin-top: 0; color: #333; margin-bottom: 20px; text-align: center;">Appeal Details</h3>
                                
                                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #1877f2; margin-bottom: 20px;">
                                    <h4 style="color: #1877f2; margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid #bbdefb; padding-bottom: 5px;">Student Name</h4>
                                    <p style="margin: 0; font-size: 14px; font-weight: 600; color: #333;">${appeal.student_name || appeal.studentName || 'Not specified'}</p>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                        <h4 style="color: #1877f2; margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid #e3f2fd; padding-bottom: 5px;">Reason Type</h4>
                                        <p style="margin: 0; font-size: 14px; font-weight: 600; color: #333;">${reasonType}</p>
                                    </div>
                                    
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                        <h4 style="color: #1877f2; margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid #e3f2fd; padding-bottom: 5px;">Approve Date</h4>
                                        <p style="margin: 0; font-size: 14px; font-weight: 600; color: #333;">${appealDate}</p>
                                    </div>
                                </div>
                                
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                    <h4 style="color: #1877f2; margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid #e3f2fd; padding-bottom: 5px;">Status</h4>
                                    <p style="margin: 0;">
                                        <span style="padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; 
                                            background: ${status === 'Approved' ? '#d4edda' : status === 'Pending' ? '#fff3cd' : '#f8d7da'}; 
                                            color: ${status === 'Approved' ? '#155724' : status === 'Pending' ? '#856404' : '#721c24'};">
                                            ${status}
                                        </span>
                                    </p>
                                </div>
                                
                                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #1877f2; margin-bottom: 20px;">
                                    <h4 style="color: #1877f2; margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid #bbdefb; padding-bottom: 5px;">Reason Description</h4>
                                    <p style="margin: 0; line-height: 1.5; color: #333; font-size: 13px; white-space: pre-wrap;">${reason}</p>
                                </div>
                                
                                <div style="text-align: center;">
                                    <button onclick="document.getElementById('simpleAppealModal').remove()" 
                                            style="
                                                background: #1877f2;
                                                color: white;
                                                border: none;
                                                padding: 10px 20px;
                                                border-radius: 5px;
                                                cursor: pointer;
                                            ">
                                        Close
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error fetching appeal details:', error);
                    modal.querySelector('p:nth-child(3)').innerHTML = `<strong>Status:</strong> <span style="color: #dc3545;">Error loading</span>`;
                });
        }

        function fetchAppealDetails(appealId) {
            console.log('Fetching appeal details for ID:', appealId);
            
            fetch(`/api/appeals/${appealId}`, {
                credentials: 'same-origin'
            })
                .then(response => response.json())
            .then(appeal => {
                console.log('Fetched appeal:', appeal);
                if (appeal) {
                    showAppealDetailsModal(appeal);
                    } else {
                    showAlert('Appeal not found', 'error');
                    }
                })
                .catch(error => {
                console.error('Error fetching appeal:', error);
                showAlert('Error loading appeal details: ' + error.message, 'error');
            });
        }

        function showAppealDetailsModal(appeal) {
            console.log('Showing appeal details modal for:', appeal);
            
            // Remove any existing modal
            const existingModal = document.getElementById('appealDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const currentReasonType = appeal.reason_type || 'Unexcused';
            const reason = appeal.reason || appeal.appeal_reason || 'No reason provided';
            const status = appeal.status || 'Unknown';
            const appealId = appeal.id;
            const isApproved = status === 'Approved';
            
            const modalHtml = `
                <div id="appealDetailsModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 550px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Appeal Details</h3>
                            <button class="close-btn" onclick="closeAppealDetailsModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="padding: 15px;">
                                <!-- Student Info -->
                                <div style="background: #e3f2fd; padding: 12px 15px; border-radius: 6px; border-left: 4px solid #1877f2; margin-bottom: 15px;">
                                    <div style="font-size: 12px; color: #1877f2; font-weight: 600; margin-bottom: 4px;">STUDENT</div>
                                    <div style="font-size: 15px; font-weight: 600; color: #333;">${appeal.student_name || appeal.studentName || 'Not specified'}</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 2px;">ID: ${appeal.student_id || 'N/A'}</div>
                                </div>
                                
                                <!-- Status and Reason Type Side by Side -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <!-- Status -->
                                    <div style="background: #f8f9fa; padding: 12px 15px; border-radius: 6px;">
                                        <div style="font-size: 12px; color: #1877f2; font-weight: 600; margin-bottom: 8px;">STATUS</div>
                                        <span style="padding: 6px 12px; border-radius: 12px; font-size: 13px; font-weight: 600; 
                                            background: ${status === 'Approved' ? '#d4edda' : status === 'Pending' ? '#fff3cd' : '#f8d7da'}; 
                                            color: ${status === 'Approved' ? '#155724' : status === 'Pending' ? '#856404' : '#721c24'};">
                                            ${status}
                                        </span>
                                    </div>
                                    
                                    <!-- Reason Type -->
                                    <div style="background: #f8f9fa; padding: 12px 15px; border-radius: 6px;">
                                        <div style="font-size: 12px; color: #1877f2; font-weight: 600; margin-bottom: 8px;">REASON TYPE</div>
                                        ${isApproved ? `
                                            <span style="padding: 6px 12px; border-radius: 4px; font-size: 13px; font-weight: 600;
                                                background: ${currentReasonType === 'Excused' ? '#d4edda' : '#f8d7da'}; 
                                                color: ${currentReasonType === 'Excused' ? '#155724' : '#721c24'};">
                                                ${currentReasonType}
                                            </span>
                                        ` : `
                                            <select id="appealReasonTypeSelect" style="
                                                width: 100%;
                                                padding: 8px 10px;
                                                border: 2px solid #e3f2fd;
                                                border-radius: 5px;
                                                font-size: 14px;
                                                background: white;
                                                color: #333;
                                                cursor: pointer;
                                            ">
                                                <option value="Excused" ${currentReasonType === 'Excused' ? 'selected' : ''}>Excused</option>
                                                <option value="Unexcused" ${currentReasonType === 'Unexcused' ? 'selected' : ''}>Unexcused</option>
                                            </select>
                                        `}
                                    </div>
                                </div>
                                
                                <!-- Reason Description -->
                                <div style="background: #f8f9fa; padding: 12px 15px; border-radius: 6px; border-left: 3px solid #1877f2; margin-bottom: 15px;">
                                    <div style="font-size: 12px; color: #1877f2; font-weight: 600; margin-bottom: 8px;">REASON DESCRIPTION</div>
                                    <p style="margin: 0; line-height: 1.5; color: #333; font-size: 14px; white-space: pre-wrap;">${reason}</p>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div style="margin-top: 15px; text-align: center; display: flex; gap: 10px; justify-content: center;">
                                    ${!isApproved ? `
                                        <button onclick="approveAppealFromModal('${appealId}')" style="
                                            background: #28a745;
                                            color: white;
                                            border: none;
                                            padding: 10px 20px;
                                            border-radius: 5px;
                                            font-size: 14px;
                                            font-weight: 600;
                                            cursor: pointer;
                                            transition: background 0.3s;
                                        " onmouseover="this.style.background='#218838'" onmouseout="this.style.background='#28a745'">
                                            ‚úì Approve Appeal
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-primary" onclick="closeAppealDetailsModal()" style="padding: 10px 20px; font-size: 14px;">
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeAppealDetailsModal() {
            const modal = document.getElementById('appealDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        function approveAppealFromModal(appealId) {
            // Get the selected reason type from the dropdown
            const reasonTypeSelect = document.getElementById('appealReasonTypeSelect');
            const reasonType = reasonTypeSelect ? reasonTypeSelect.value : 'Unexcused';
            
            if (confirm(`Are you sure you want to approve this appeal as "${reasonType}"?`)) {
                // Prepare update data
                const updateData = {
                    status: 'Approved',
                    reason_type: reasonType
                };
                
                fetch(`/api/appeals/${appealId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(updateData)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        let message = `Appeal approved successfully as "${reasonType}"!`;
                        if (result.violation_deleted) {
                            message += ' Related violation has been automatically deleted.';
                        }
                        showAlert(message, 'success');
                        
                        // Log activity
                        logActivity('edit', 'appeal', 'Appeal Approved', `Appeal with ID ${appealId} has been approved`, `Status: Approved, Reason Type: ${reasonType}`);
                        
                        // Close the modal
                        closeAppealDetailsModal();
                        
                        // Refresh the data
                        if (typeof reapplyGrouping === 'function') {
                            reapplyGrouping();
                        }
                        if (typeof refreshDataOnly === 'function') {
                            refreshDataOnly();
                        } else if (typeof loadDashboardData === 'function') {
                            loadDashboardData();
                        }
                    } else {
                        showAlert('Error approving appeal: ' + (result.error || result.message || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error approving appeal:', error);
                    showAlert('Error approving appeal: ' + error.message, 'error');
                });
            }
        }
        
        function viewStudentAppeals(studentName) {
            console.log('View button clicked for:', studentName);
            
            // Show a simple modal with student information
            showSimpleAppealsModal(studentName);
        }

        function showSimpleAppealsModal(studentName) {
            // Remove any existing modal
            const existingModal = document.getElementById('simpleAppealsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modalHtml = `
                <div id="simpleAppealsModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Appeals for ${studentName}</h3>
                            <button class="close-btn" onclick="closeSimpleAppealsModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="text-align: center; padding: 20px;">
                                <h4 style="color: #1877f2; margin-bottom: 15px;">Student: ${studentName}</h4>
                                <p style="margin-bottom: 20px;">This student has appeals in the system.</p>
                                
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                                    <h5 style="margin: 0 0 10px 0; color: #1c1e21;">Appeal Information</h5>
                                    <p style="margin: 5px 0; color: #65676b;">‚Ä¢ Student has submitted appeals</p>
                                    <p style="margin: 5px 0; color: #65676b;">‚Ä¢ Appeals are being processed</p>
                                    <p style="margin: 5px 0; color: #65676b;">‚Ä¢ Status updates available</p>
                                </div>
                                
                                <div style="margin-top: 20px;">
                                    <button class="btn btn-primary" onclick="refreshAppealsData()" style="margin-right: 10px;">
                                        üîÑ Refresh Data
                                    </button>
                                    <button class="btn btn-secondary" onclick="closeSimpleAppealsModal()">
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeSimpleAppealsModal() {
            const modal = document.getElementById('simpleAppealsModal');
            if (modal) {
                modal.remove();
            }
        }

        function showStudentAppealsSummary(studentName, appeals) {
            // Remove any existing modal
            const existingModal = document.getElementById('studentAppealsSummaryModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modalHtml = `
                <div id="studentAppealsSummaryModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3 class="modal-title">All Appeals for ${studentName} (${appeals.length} total)</h3>
                            <button class="close-btn" onclick="closeStudentAppealsSummary()">&times;</button>
                        </div>
                        <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                            <div class="appeals-list">
                                ${appeals.map((appeal, index) => {
                                    const appealId = appeal.id || appeal._id || `appeal-${index}`;
                                    const appealDate = appeal.status === 'Approved' && appeal.approved_date 
                                        ? new Date(appeal.approved_date).toLocaleDateString() 
                                        : appeal.date || appeal.created_date || appeal.submitted_date || 'No Date';
                                    const appealStatus = appeal.status || 'Pending Review';
                                    const appealReason = appeal.reason || appeal.appeal_reason || 'No reason provided';
                                    
                                    return `
                                        <div class="appeal-item" style="margin-bottom: 15px; padding: 15px; border: 1px solid #e4e6ea; border-radius: 8px; background: #f8f9fa;">
                                            <div class="appeal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="font-weight: 600; color: #1877f2;">Appeal #${index + 1}</span>
                                                <span class="status-badge status-${appealStatus.toLowerCase().replace(/\s+/g, '-')}" style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">${appealStatus}</span>
                                            </div>
                                            <div class="appeal-details">
                                                <p style="margin: 5px 0;"><strong>Date:</strong> ${appealDate}</p>
                                                <p style="margin: 5px 0;"><strong>Reason:</strong> ${appealReason}</p>
                                            </div>
                                            <div class="appeal-actions" style="margin-top: 10px;">
                                                <button class="btn btn-primary btn-sm" onclick="viewAppeal('${appealId}')" style="margin-right: 8px;">
                                                    View Details
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeStudentAppealsSummary()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
                document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeStudentAppealsSummary() {
            const modal = document.getElementById('studentAppealsSummaryModal');
            if (modal) {
                modal.remove();
            }
        }

        function showSimpleStudentAppealsModal(studentName) {
            // Remove any existing modal
            const existingModal = document.getElementById('simpleStudentAppealsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modalHtml = `
                <div id="simpleStudentAppealsModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Appeals for ${studentName}</h3>
                            <button class="close-btn" onclick="closeSimpleStudentAppealsModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p>Student: <strong>${studentName}</strong></p>
                            <p>This student has appeals in the system. The detailed view is being loaded...</p>
                            <div style="text-align: center; margin: 20px 0;">
                                <button class="btn btn-primary" onclick="refreshAppealsData()">Refresh Data</button>
                                <button class="btn btn-secondary" onclick="closeSimpleStudentAppealsModal()">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeSimpleStudentAppealsModal() {
            const modal = document.getElementById('simpleStudentAppealsModal');
            if (modal) {
                modal.remove();
            }
        }

        function refreshAppealsData() {
            showAlert('Refreshing appeals data...', 'info');
            loadAppealsData().then(appealsData => {
                if (appealsData && appealsData.length > 0) {
                    updateAppealsTable(appealsData);
                    showAlert('Appeals data refreshed successfully!', 'success');
                } else {
                    showAlert('No appeals data available after refresh', 'warning');
                }
            }).catch(error => {
                showAlert('Error refreshing appeals data: ' + error.message, 'error');
            });
        }


        function viewStudentViolations(studentName) {
            // Fetch all violations for this student
            fetch('/api/violations', {
                credentials: 'same-origin'
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data) {
                        const studentViolations = result.data.filter(v => v.student_name === studentName);
                        showStudentViolationsModal(studentName, studentViolations);
                    } else {
                        showAlert('Error fetching violations for ' + studentName, 'error');
                    }
                })
                .catch(error => {
                    showAlert('Error fetching violations: ' + error.message, 'error');
                });
        }

        function showStudentViolationsModal(studentName, violations) {
            // Remove any existing student violations modal
            const existingModal = document.getElementById('studentViolationsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal HTML
            const modalHtml = `
                <div id="studentViolationsModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3 class="modal-title">All Violations for ${studentName} (${violations.length} total)</h3>
                            <button class="close-btn" onclick="closeStudentViolationsModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="violations-list">
                                ${violations.map((violation, index) => {
                                    // Format date and time from last_updated
                                    let dateDisplay = '';
                                    let timeDisplay = '';
                                    if (violation.last_updated) {
                                        try {
                                            // Parse last_updated format: "YYYY-MM-DD HH:MM:SS"
                                            const lastUpdated = violation.last_updated;
                                            const dateTimeParts = lastUpdated.split(' ');
                                            if (dateTimeParts.length >= 2) {
                                                const datePart = dateTimeParts[0];
                                                const timePart = dateTimeParts[1];
                                                // Format date as MM/DD/YYYY
                                                const dateObj = new Date(datePart + 'T' + timePart);
                                                dateDisplay = dateObj.toLocaleDateString('en-US', {month: '2-digit', day: '2-digit', year: 'numeric'});
                                                // Format time as HH:MM
                                                timeDisplay = timePart.substring(0, 5);
                                            }
                                        } catch (e) {
                                            console.error('Error parsing last_updated:', e);
                                        }
                                    }
                                    // Fallback to date field if last_updated is not available
                                    if (!dateDisplay && violation.date) {
                                        try {
                                            const dateObj = new Date(violation.date);
                                            dateDisplay = dateObj.toLocaleDateString('en-US', {month: '2-digit', day: '2-digit', year: 'numeric'});
                                        } catch (e) {
                                            dateDisplay = violation.date;
                                        }
                                    }
                                    
                                    return `
                                    <div class="violation-item">
                                        <div class="violation-header">
                                            <span class="violation-number">#${index + 1}</span>
                                            <div class="violation-type-container">
                                                <span class="violation-type">${violation.violation_type || 'Incomplete Uniform'}</span>
                                                <span class="violation-date" style="text-align: center; display: block;">
                                                    ${dateDisplay || 'No date'}
                                                    ${timeDisplay ? `<div style="font-size: 11px; color: rgba(255, 255, 255, 0.6); margin-top: 2px; text-align: center; opacity: 0.7;">${timeDisplay}</div>` : ''}
                                                </span>
                                            </div>
                                            <span class="violation-status status-${(violation.status || 'Warning').toLowerCase().replace(/[^a-z0-9]/g, '-')}">${violation.status || 'Warning'}</span>
                                        </div>
                                        <div class="violation-details">
                                            <p><strong>Description:</strong> ${violation.description || 'No description provided'}</p>
                                        </div>
                                        <div class="violation-actions">
                                            <button class="btn btn-sm btn-secondary" onclick="editViolationFromModal('${violation.id}', '${(violation.student_name || '').replace(/'/g, "\\'")}', '${(violation.violation_type || 'Incomplete Uniform').replace(/'/g, "\\'")}', '${(violation.description || '').replace(/'/g, "\\'")}', '${(violation.status || 'Warning').replace(/'/g, "\\'")}')">Edit</button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteViolation('${violation.id}')">Delete</button>
                                        </div>
                                    </div>
                                `;
                                }).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeStudentViolationsModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeStudentViolationsModal() {
            const modal = document.getElementById('studentViolationsModal');
                if (modal) {
                modal.remove();
            }
        }
        
        function editViolationFromModal(violationId, studentName, violationType, description, status) {
            // Close the student violations modal first
            closeStudentViolationsModal();
            
            // Populate the edit form with the violation data
            document.getElementById('editViolationId').value = violationId;
            document.getElementById('editStudentName').value = studentName;
            document.getElementById('editViolationType').value = violationType;
            document.getElementById('editDescription').value = description;
            document.getElementById('editStatus').value = status;
            
            // Open the edit violation modal
            openModal('editViolationModal');
        }

        function editStudentViolations(studentName) {
            showAlert(`Edit all violations for ${studentName} - Feature coming soon!`, 'info');
        }


        function editStudentAppeals(studentName) {
            showAlert(`Edit all appeals for ${studentName} - Feature coming soon!`, 'info');
        }

        function deleteAllStudentViolations(studentName) {
            if (confirm(`‚ö†Ô∏è WARNING: This will delete ALL violations for ${studentName} permanently!\n\nThis includes:\n‚Ä¢ All violation records\n‚Ä¢ This action cannot be undone!\n\nAre you absolutely sure you want to continue?`)) {
                if (confirm(`üö® FINAL CONFIRMATION üö®\n\nThis will permanently delete ALL violations for ${studentName}!\n\nType "DELETE ALL" to confirm:`)) {
                    // Show loading indicator
                    showLoading();
                    
                    // Call the API to delete all violations for this student
                    fetch(`/api/violations/student/${encodeURIComponent(studentName)}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(result => {
                        hideLoading();
                        
                        if (result.success) {
                            const totalDeleted = result.total_deleted || 0;
                            const deletedViolations = result.deleted_violations || 0;
                            const deletedAppeals = result.deleted_appeals || 0;
                            
                            if (totalDeleted > 0) {
                                let message = `‚úÖ Successfully deleted `;
                                const parts = [];
                                if (deletedViolations > 0) parts.push(`${deletedViolations} violation(s)`);
                                if (deletedAppeals > 0) parts.push(`${deletedAppeals} appeal(s)`);
                                message += parts.join(' and ') + ` for ${studentName}!`;
                                
                                // Log the activity
                                logActivity('delete', 'violation', 'Student Violations Deleted', 
                                    `All violations deleted for student: ${studentName}`, 
                                    `Student: ${studentName}, Violations deleted: ${deletedViolations}, Deleted by: ${getCurrentUser()}`);
                                
                                showAlert(message, 'success');
                                // Refresh the page to show updated data
                                setTimeout(() => {
                                    location.reload();
                                }, 1500);
                            } else {
                                showAlert(`‚ÑπÔ∏è No violations or appeals found for ${studentName}`, 'info');
                            }
                        } else {
                            showAlert(`‚ùå Error deleting violations: ${result.error || 'Unknown error'}`, 'error');
                        }
                    })
                    .catch(error => {
                        hideLoading();
                        showAlert(`‚ùå Error deleting violations: ${error.message}`, 'error');
                        console.error('Delete all violations error:', error);
                    });
                }
            }
        }

        // Loading indicator functions
        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
        }
        
        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }
        
        // Hide loading on page load (data already loaded from server)
        window.addEventListener('load', function() {
            hideLoading();
            
            // Initialize observer as disabled
            window.appealsObserverActive = false;
            window.appealsObserver = null;
            console.log('Appeals observer completely disabled on page load');
        });
        
        // Show loading only for external navigation
        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'A' && e.target.href && !e.target.href.includes('#') && !e.target.href.includes(window.location.hostname)) {
                showLoading();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if there's a stored active tab
            const storedTab = sessionStorage.getItem('activeTab');
            if (storedTab) {
                showTab(storedTab);
                sessionStorage.removeItem('activeTab'); // Clear after use
            }
            
            // Set up search input listeners
            document.getElementById('violationSearch').addEventListener('input', searchViolations);
            document.getElementById('appealSearch').addEventListener('input', searchAppeals);
            document.getElementById('designSearch').addEventListener('input', searchDesigns);
            document.getElementById('activitySearch').addEventListener('input', searchActivities);
            
            // Set today's date for violation form
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('violationDate').value = today;
            
            // Prevent non-numeric input in Student ID fields
            const studentIdInputs = document.querySelectorAll('input[name="student_id"], #editStudentId');
            studentIdInputs.forEach(function(input) {
                input.addEventListener('input', function(e) {
                    // Remove any non-numeric characters
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
                
                input.addEventListener('keypress', function(e) {
                    // Prevent typing non-numeric characters
                    if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                    }
                });
            });
            
            // Initialize activities
            addInitialActivities();
            
            // Load appeals data on page load
            loadAppealsData().then(appealsData => {
                if (appealsData && appealsData.length > 0) {
                    updateAppealsTable(appealsData);
                } else {
                    console.log('No appeals data available');
                }
            }).catch(error => {
                console.error('Error loading appeals data:', error);
            });
            
            // Immediate grouping on page load
            forceGrouping();
            calculateViolationCounts();
            
            // Add event listeners to view buttons after a short delay
            setTimeout(() => {
            }, 500);
            
            // Use requestAnimationFrame for immediate grouping
            requestAnimationFrame(() => {
                forceGrouping();
                calculateViolationCounts();
            });
            
            // Calculate violation counts on page load
            setTimeout(() => {
                // Try to use server-side data first
                const serverViolations = window.violationsData || [];
                if (serverViolations.length > 0) {
                    console.log('Using server-side violations data:', serverViolations);
                    buildGroupedViolationsTable(serverViolations);
                } else {
                    calculateViolationCounts();
                }
                
                // Load appeals data
                loadAppealsData().then(appealsData => {
                    console.log('Loaded appeals data on page load:', appealsData);
                    if (appealsData.length > 0) {
                        updateAppealsTable(appealsData);
                    }
                });
                
                // Group appeals by student
                forceGrouping();
            }, 100);
            
            // Additional grouping after a longer delay to ensure it works after page refresh
            setTimeout(() => {
                forceGrouping();
                calculateViolationCounts();
            }, 500);
            
            // More aggressive grouping for page refreshes
            setTimeout(() => {
                forceGrouping();
                calculateViolationCounts();
            }, 1000);
            
            setTimeout(() => {
                forceGrouping();
                calculateViolationCounts();
            }, 2000);
            
            // DISABLED: MutationObserver for appeals table - causing issues
            // const appealsTable = document.getElementById('appeals');
            // if (appealsTable) {
            //     const appealsTbody = appealsTable.querySelector('tbody');
            //     if (appealsTbody) {
            //         // Store tbody reference globally for reuse
            //         window.appealsTbody = appealsTbody;
            //         
            //         // Create observer but don't start it
            //         window.appealsObserver = new MutationObserver(function(mutations) {
            //             // Observer functionality disabled
            //         });
            //         
            //         console.log('Appeals observer disabled to prevent console messages');
            //     }
            // }
            
            // Initialize observer as disabled
            window.appealsObserverActive = false;
            window.appealsObserver = null;
            console.log('Appeals observer completely disabled');
            
            // Set up automatic refresh every 30 seconds (only if page is visible)
            setInterval(() => {
                if (!document.hidden) {
                    console.log('Auto-refreshing data...');
                    refreshDataOnly();
                }
            }, 30000); // 30 seconds
        });
    </script>
</body>
</html>
</html>