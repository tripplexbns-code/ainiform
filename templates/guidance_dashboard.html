<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Uniform System - Guidance Dashboard</title>
    <meta name="description" content="Guidance Counselor Dashboard - Manage student uniform compliance efficiently">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1877f2 0%, #1565c0 100%);
            color: white;
            padding: 18px 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            position: relative;
        }
        
        .dashboard-badge {
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.15) 100%);
            padding: 12px 20px;
            border-radius: 16px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .dashboard-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .dashboard-badge:hover::before {
            left: 100%;
        }
        
        .dashboard-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .dashboard-badge-icon {
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.2) 100%);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            z-index: 1;
        }
        
        .dashboard-badge-text {
            font-size: 15px;
            font-weight: 700;
            letter-spacing: 0.5px;
            white-space: nowrap;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 1;
        }
        
        .header-brand {
            display: flex;
            align-items: center;
            gap: 18px;
            justify-content: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .header-ve-container {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: box-shadow 0.2s;
        }
        
        .header-logo-container:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .header-logo {
            height: 48px;
            width: auto;
            object-fit: contain;
            display: block;
        }
        
        .header-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .header h1 {
            font-size: 22px;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
            letter-spacing: -0.3px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #1877f2, #42a5f5, #1877f2);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            z-index: 1000;
            display: none;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: background 0.2s, transform 0.2s;
            position: absolute;
            right: 0;
        }
        
        .user-info:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }
        
        .user-avatar {
            width: 42px;
            height: 42px;
            background: rgba(255, 255, 255, 0.25);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 14px;
            line-height: 1.3;
        }
        
        .user-role {
            font-size: 11px;
            opacity: 0.85;
            font-weight: 400;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Dropdown menu styles */
        .dropdown-container {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .dropdown-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 5px;
            background: white;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            overflow: hidden;
            z-index: 1000;
        }
        
        .dropdown-content.show {
            display: block;
        }
        
        .dropdown-item {
            display: block;
            padding: 12px 16px;
            color: #1c1e21;
            text-decoration: none;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f2f5;
            font-size: 14px;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background: #f8f9fa;
        }
        
        .dropdown-item-icon {
            margin-right: 8px;
        }
        
        .main-layout {
            display: flex;
            min-height: calc(100vh - 80px);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .sidebar {
            width: 300px;
            background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            position: sticky;
            top: 80px;
            height: calc(100vh - 80px);
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        
        .sidebar-header {
            padding: 30px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .sidebar-header h2 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .sidebar-header p {
            opacity: 0.85;
            font-size: 13px;
            font-weight: 400;
        }
        
        .nav-menu {
            list-style: none;
            padding: 12px 0;
            margin: 0;
        }
        
        .nav-item {
            margin: 4px 12px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .nav-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: rgba(255, 255, 255, 0.8);
            transform: scaleY(0);
            transition: transform 0.3s;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.12);
            color: white;
            transform: translateX(4px);
        }
        
        .nav-link.active {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.15) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .nav-link.active::before {
            transform: scaleY(1);
        }
        
        .nav-icon {
            font-size: 22px;
            margin-right: 14px;
            width: 28px;
            text-align: center;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }
        
        .main-content {
            flex: 1;
            padding: 30px;
            background: transparent;
            overflow-y: auto;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 28px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transform: scaleX(0);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12), 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .stat-card:hover::before {
            transform: scaleX(1);
        }
        
        .stat-icon {
            font-size: 52px;
            margin-bottom: 16px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            letter-spacing: -1px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .content-section {
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .tab-content {
            display: none;
            padding: 32px;
            animation: fadeIn 0.4s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Ensure only active tab content is visible */
        .tab-content:not(.active) {
            display: none !important;
            visibility: hidden !important;
        }
        
        .tab-content.active {
            display: block !important;
            visibility: visible !important;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f2f5;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: #1c1e21;
            letter-spacing: -0.5px;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary {
            background: #1877f2;
            color: white;
        }
        
        .btn-primary:hover {
            background: #166fe5;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(24, 119, 242, 0.4);
        }
        
        .btn-secondary {
            background: #e4e6ea;
            color: #1c1e21;
        }
        
        .btn-secondary:hover {
            background: #d1d3d9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-success {
            background: #42b883;
            color: white;
        }
        
        .btn-success:hover {
            background: #369870;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 184, 131, 0.4);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }
        
        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            background: #f8f9fa;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #e4e6ea;
        }
        
        .search-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e4e6ea;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .data-table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            table-layout: fixed;
        }
        
        .data-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 10px 8px;
            text-align: left;
            font-weight: 700;
            color: #1c1e21;
            border-bottom: 2px solid #e4e6ea;
            white-space: nowrap;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f2f5;
            word-wrap: break-word;
            vertical-align: middle;
            font-size: 13px;
        }
        
        /* Column width specifications */
        .data-table th:nth-child(1),
        .data-table td:nth-child(1) {
            width: 18%; /* Student */
        }
        
        .data-table th:nth-child(2),
        .data-table td:nth-child(2) {
            width: 12%; /* Student ID */
        }
        
        .data-table th:nth-child(3),
        .data-table td:nth-child(3) {
            width: 15%; /* Violation */
        }
        
        .data-table th:nth-child(4),
        .data-table td:nth-child(4) {
            width: 10%; /* Date */
        }
        
        .data-table th:nth-child(5),
        .data-table td:nth-child(5) {
            width: 10%; /* Status */
        }
        
        .data-table th:nth-child(6),
        .data-table td:nth-child(6) {
            width: 8%; /* Offense */
        }
        
        .data-table th:nth-child(7),
        .data-table td:nth-child(7) {
            width: 27%; /* Actions */
            white-space: nowrap;
        }
        
        /* Specific styling for violations table */
        #violations .data-table th:nth-child(1),
        #violations .data-table td:nth-child(1) {
            width: 18%; /* Student */
        }
        
        #violations .data-table th:nth-child(2),
        #violations .data-table td:nth-child(2) {
            width: 12%; /* Student ID */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #violations .data-table th:nth-child(3),
        #violations .data-table td:nth-child(3) {
            width: 15%; /* Violation */
        }
        
        #violations .data-table th:nth-child(4),
        #violations .data-table td:nth-child(4) {
            width: 10%; /* Date */
            white-space: nowrap;
            font-size: 12px;
        }
        
        #violations .data-table th:nth-child(5),
        #violations .data-table td:nth-child(5) {
            width: 10%; /* Status */
        }
        
        #violations .data-table th:nth-child(6),
        #violations .data-table td:nth-child(6) {
            width: 8%; /* Offense - compact for ordinal numbers */
            text-align: center;
        }
        
        #violations .data-table th:nth-child(7),
        #violations .data-table td:nth-child(7) {
            width: 27%; /* Actions - increased space for buttons */
            white-space: nowrap;
            text-align: center;
        }
        
        /* Specific styling for designs table */
        #designs .data-table {
            display: table !important;
            visibility: visible !important;
            opacity: 1 !important;
            width: 100% !important;
            min-width: 700px !important;
        }
        
        #designs .data-table thead {
            display: table-header-group !important;
            visibility: visible !important;
        }
        
        #designs .data-table tbody {
            display: table-row-group !important;
            visibility: visible !important;
        }
        
        #designs .data-table tr {
            display: table-row !important;
            visibility: visible !important;
        }
        
        #designs .data-table th,
        #designs .data-table td {
            display: table-cell !important;
            visibility: visible !important;
        }
        
        #designs .data-table th:nth-child(1),
        #designs .data-table td:nth-child(1) {
            width: 30%; /* Design Name - more space for longer names */
        }
        
        #designs .data-table th:nth-child(2),
        #designs .data-table td:nth-child(2) {
            width: 15%; /* Type */
        }
        
        #designs .data-table th:nth-child(3),
        #designs .data-table td:nth-child(3) {
            width: 15%; /* Status */
        }
        
        #designs .data-table th:nth-child(4),
        #designs .data-table td:nth-child(4) {
            width: 30%; /* Actions - more space for multiple buttons */
            white-space: nowrap;
        }
        
        /* Ensure designs tab content is visible when active */
        #designs.tab-content.active {
            display: block !important;
        }
        
        #designs .table-container {
            display: block !important;
            visibility: visible !important;
        }
        
        /* Force all table elements to be visible in designs tab */
        #designs table,
        #designs table * {
            display: revert !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        #designs table {
            display: table !important;
        }
        
        #designs table thead {
            display: table-header-group !important;
        }
        
        #designs table tbody {
            display: table-row-group !important;
        }
        
        #designs table tr {
            display: table-row !important;
        }
        
        #designs table th,
        #designs table td {
            display: table-cell !important;
        }
        
        /* Ensure uniform designs content is only in designs tab */
        #designs .section-title {
            display: block !important;
        }
        
        /* Hide designs table in other tabs */
        .tab-content:not(#designs) .designs-table-container,
        .tab-content:not(#designs) .designs-table {
            display: none !important;
        }
        
        /* Ensure designs table is visible in designs tab */
        #designs .designs-table-container,
        #designs .designs-table {
            display: block !important;
        }
        
        #designs .designs-table {
            display: table !important;
        }
        
        /* Ensure violations and appeals tables are visible in their respective tabs */
        #violations .data-table,
        #appeals .data-table {
            display: table !important;
            visibility: visible !important;
        }
        
        #violations .table-container,
        #appeals .appeals-table-container {
            display: block !important;
            visibility: visible !important;
        }
        
        .data-table td:nth-child(7) {
            text-align: center;
        }
        
        .data-table td:nth-child(7) .btn {
            margin: 2px;
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* Specific button styling for violations table */
        #violations .data-table td:nth-child(7) .btn {
            margin: 2px;
            padding: 6px 12px;
            font-size: 12px;
            min-width: 65px;
        }
        
        /* Compact button styling for violations table */
        #violations .data-table td:nth-child(7) .btn.btn-sm {
            padding: 5px 10px;
            font-size: 11px;
            min-width: 60px;
        }
        
        .data-table tr {
            transition: all 0.2s ease;
        }
        
        .data-table tbody tr:hover {
            background: linear-gradient(90deg, #f8f9fa 0%, #f0f2f5 100%);
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .table-container {
            width: 100%;
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            background: white;
            padding: 4px;
        }
        
        .table-container::-webkit-scrollbar {
            height: 10px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #f1f3f5;
            border-radius: 8px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.1);
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8f 100%);
        }
        
        /* Appeals modal styling */
        .appeals-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .appeal-item {
            border: 1px solid #e4e6ea;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        
        .appeal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .appeal-number {
            font-weight: bold;
            color: #1877f2;
        }
        
        .appeal-date {
            color: #65676b;
            font-size: 14px;
        }
        
        .appeal-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Appeals table specific styling */
        .appeals-table {
            min-width: 100%;
            table-layout: auto;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e4e6ea;
        }
        
        
        .appeals-table .student-info {
            display: flex;
            align-items: center;
            gap: 6px;
            line-height: 1.2;
        }
        
        .appeals-table .clickable-student-name {
            font-weight: 600;
            color: #1877f2;
            cursor: pointer;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: inline-block;
            position: relative;
            font-size: 15px;
        }
        
        .appeals-table .clickable-student-name:hover {
            background: linear-gradient(135deg, rgba(24, 119, 242, 0.1), rgba(24, 119, 242, 0.2));
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(24, 119, 242, 0.2);
        }
        
        
        .appeals-table .clickable-student-name:active {
            transform: translateY(0);
            background-color: rgba(24, 119, 242, 0.2);
        }
        
        .appeals-table .auto-badge {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid rgba(25, 118, 210, 0.2);
            box-shadow: 0 1px 3px rgba(25, 118, 210, 0.2);
        }
        
        /* Action column CSS removed - no longer needed */
        
        
        .appeals-table .action-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .appeals-table .clickable-actions {
            transition: all 0.2s ease;
            border-radius: 8px;
            padding: 4px;
        }
        
        
        .appeals-table .action-buttons .btn {
            margin: 0;
            padding: 8px 16px;
            font-size: 12px;
            min-width: 70px;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        
        .appeals-table .view-btn {
            background: #1877f2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            transition: all 0.2s ease;
        }
        
        
        .appeals-table .view-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .appeals-table .view-btn .btn-icon {
            margin-right: 6px;
            font-size: 14px;
        }
        
        .appeals-table .view-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(24, 119, 242, 0.3);
        }
        
        /* Override any conflicting button styles for view buttons */
        .appeals-table .action-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .appeals-table .status-text {
            color: #65676b;
            font-style: italic;
            font-size: 12px;
        }
        
        .appeals-table tr {
            border-bottom: 1px solid #f0f2f5;
            transition: all 0.3s ease;
            height: auto;
            min-height: 48px;
        }
        
        .appeals-table tr:hover {
            background: linear-gradient(135deg, #f8f9ff, #e3f2fd) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(24, 119, 242, 0.15);
        }
        
        
        .appeals-table .clickable-row {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        
        
        
        .appeals-table tr:nth-child(even) {
            background: #fafbfc;
        }
        
        
        .appeals-table td {
            border: none;
            vertical-align: middle;
            padding: 12px 20px !important;
            height: auto;
            position: relative;
        }
        
        .appeals-table th {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            font-weight: 700;
            color: #1c1e21;
            border-bottom: 2px solid #dee2e6;
            font-size: 14px;
            letter-spacing: 0.3px;
            padding: 16px 20px !important;
            text-transform: uppercase;
            font-size: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        
        /* Appeals table container */
        .appeals-table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid #e4e6ea;
            margin-top: 20px;
        }
        
        .appeals-table-wrapper {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* Violations table container - similar to appeals */
        .violations-table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid #e4e6ea;
            margin-top: 20px;
        }
        
        .violations-table-wrapper {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* Custom scrollbar styling for violations table */
        .violations-table-wrapper::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .violations-table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .violations-table-wrapper::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .violations-table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .appeals-table {
                min-width: 100%;
                font-size: 14px;
            }
            
            .appeals-table th,
            .appeals-table td {
                padding: 8px 12px !important;
            }
            
            .appeals-table .clickable-student-name {
                font-size: 14px;
                padding: 6px 10px;
            }
        }
        
        @media (max-width: 480px) {
            .appeals-table th,
            .appeals-table td {
                padding: 6px 8px !important;
            }
            
            .appeals-table .clickable-student-name {
                font-size: 13px;
                padding: 4px 8px;
            }
        }
        
        .appeal-details {
            margin-bottom: 15px;
        }
        
        .appeal-details p {
            margin: 5px 0;
            color: #1c1e21;
        }
        
        .appeal-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .appeal-actions .btn {
            font-size: 11px;
            padding: 4px 8px;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        /* Compact status badges for violations table */
        #violations .status-badge {
            padding: 4px 10px;
            font-size: 10px;
        }
        
        .status-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .reason-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .reason-badge.reason-excused {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }
        
        .reason-badge.reason-unexcused {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }
        
        .status-badge.status-guidance {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            color: white;
        }
        
        .status-badge.status-advisory {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }
        
        .status-badge.status-warning {
            background: linear-gradient(135deg, #ffc107, #ff8f00);
            color: white;
        }
        
        .status-badge.status-no-violations {
            background: linear-gradient(135deg, #4caf50, #388e3c);
            color: white;
        }
        
        .auto-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            margin-left: 5px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        
        .violation-count-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        .count-title {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
        }
        
        .count-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .count-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .count-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .count-card.max-violations {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            color: white;
            border-color: #d32f2f;
        }
        
        .count-card.warning-violations {
            background: linear-gradient(135deg, #ffc107, #ff8f00);
            color: white;
            border-color: #ffc107;
        }
        
        .count-card.normal-violations {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            border-color: #ff9800;
        }
        
        .student-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .violation-count {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .violation-status {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .max-violation-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .count-cell {
            text-align: center;
            vertical-align: middle;
            width: 80px;
        }
        
        .violation-count-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 12px;
            min-width: 32px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .violation-count-badge.max-violations {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            color: white;
            font-size: 13px;
            font-weight: 900;
            box-shadow: 0 3px 6px rgba(211, 47, 47, 0.3);
            animation: pulse 2s infinite;
        }
        
        /* Compact count badges for violations table */
        #violations .violation-count-badge {
            padding: 4px 8px;
            font-size: 11px;
            min-width: 28px;
        }
        
        #violations .violation-count-badge.max-violations {
            font-size: 12px;
        }
        
        .violation-count-badge.warning-violations {
            background: linear-gradient(135deg, #ffc107, #ff8f00);
            color: white;
            font-weight: bold;
        }
        
        .violation-count-badge.normal-violations {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .student-row {
            transition: background-color 0.2s ease;
        }
        
        .student-row.guidance-violations-row {
            background-color: #fff5f5;
            border-left: 4px solid #d32f2f;
            box-shadow: 0 2px 8px rgba(211, 47, 47, 0.1);
        }
        
        .student-row.advisory-violations-row {
            background-color: #fff8e1;
            border-left: 4px solid #ff9800;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.1);
        }
        
        .student-row.warning-violations-row {
            background-color: #fffbf0;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);
        }
        
        .student-row:hover {
            background-color: #f8f9fa;
        }
        
        .student-row.expanded {
            background-color: #e3f2fd;
        }
        
        .violation-details-row {
            background-color: #f8f9fa;
            display: none;
        }
        
        .violation-details-row.show {
            display: table-row;
        }
        
        .violation-details-cell {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            background-color: #f8f9fa;
        }
        
        .violation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .violation-item:last-child {
            border-bottom: none;
        }
        
        .violation-info {
            flex: 1;
        }
        
        .violation-actions {
            margin-left: 15px;
            display: flex;
            gap: 5px;
        }
        
        .violations-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .violation-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }
        
        .violation-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .violation-number {
            background-color: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .violation-type {
            font-weight: bold;
            color: #495057;
        }
        
        .violation-type-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .violation-date {
            font-size: 0.75em;
            color: #6c757d;
            font-weight: normal;
            margin-top: 2px;
        }
        
        .violation-details {
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }
        
        .violation-details p {
            margin: 5px 0;
            color: #6c757d;
        }
        
        .modal-footer {
            padding: 15px;
            border-top: 1px solid #e9ecef;
            text-align: right;
        }
        
        /* Design name link styles */
        .design-name-link {
            color: #1877f2;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }
        
        .design-name-link:hover {
            color: #0d5aa7;
            text-decoration: underline;
        }
        
        /* Design details modal styles */
        .modal-large {
            max-width: 800px;
        }
        
        .design-details-container {
            display: flex;
            gap: 30px;
            padding: 20px 0;
        }
        
        .design-info-section {
            flex: 1;
        }
        
        .design-image-section {
            flex: 1;
        }
        
        .detail-row {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .detail-label {
            font-weight: bold;
            color: #333;
            display: block;
            margin-bottom: 5px;
        }
        
        .detail-value {
            color: #666;
            font-size: 14px;
        }
        
        .image-container {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #fafafa;
        }
        
        .image-container img {
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .design-details-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .modal-large {
                max-width: 95%;
            }
        }
        
        .clickable-student-name {
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
            font-weight: 500;
            transition: color 0.2s ease;
        }
        
        .clickable-student-name:hover {
            color: #0056b3;
            text-decoration: none;
        }
        
        .appeal-count-badge {
            background-color: #6c757d;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            margin-top: 6px;
        }
        
        .student-info-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .student-name-display {
            font-weight: 600;
            color: #1c1e21;
        }
        
        .appeals-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .appeal-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }
        
        .appeal-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .appeal-number {
            background-color: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .appeal-details {
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            border-left: 3px solid #28a745;
        }
        
        .appeal-details p {
            margin: 5px 0;
            color: #6c757d;
        }
        
        .appeal-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }
        
        .violation-details-header {
            background-color: #e9ecef;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .violation-details-header h4 {
            margin: 0;
            color: #495057;
        }
        
        .violation-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .violation-number {
            background-color: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-right: 8px;
        }
        
        .violation-status {
            margin-left: 10px;
        }
        
        .violation-date {
            background-color: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
            margin: 0 8px;
        }
        
        .date-cell {
            font-weight: 500;
            color: #495057;
            background-color: #f8f9fa;
            padding-left: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9em;
        }
        
        .expand-icon {
            transition: transform 0.2s ease;
            margin-right: 8px;
        }
        
        .expand-icon.expanded {
            transform: rotate(90deg);
        }
        
        .student-name-cell {
            display: flex;
            align-items: center;
        }
        
        .status-text {
            color: #6b7280;
            font-style: italic;
            font-size: 14px;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-advisory {
            background: #ffeaa7;
            color: #d63031;
        }
        
        .status-guidance {
            background: #fab1a0;
            color: #e17055;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-active {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 8px 24px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.8);
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: white;
            margin: 0;
        }
        
        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 28px;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #1c1e21;
            font-size: 14px;
            letter-spacing: 0.2px;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e4e6ea;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e4e6ea;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
            }
            
            .nav-menu {
                display: flex;
                overflow-x: auto;
            }
            
            .nav-item {
                flex-shrink: 0;
            }
            
            .nav-link {
                white-space: nowrap;
                padding: 15px 20px;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .data-table {
                font-size: 14px;
                min-width: 750px;
            }
            
            .data-table th,
            .data-table td {
                padding: 10px 8px;
            }
            
            .table-container {
                margin: 0 -10px;
                padding: 0 10px;
            }
            
            /* Responsive design for violations table */
            #violations .data-table {
                min-width: 750px;
            }
            
            #violations .data-table th,
            #violations .data-table td {
                padding: 8px 6px;
                font-size: 13px;
            }
            
            /* Responsive design for designs table */
            #designs .data-table {
                min-width: 700px;
            }
            
            #designs .data-table th,
            #designs .data-table td {
                padding: 8px 6px;
                font-size: 13px;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 20px;
            }
            
            .header {
                padding: 14px 16px;
            }
            
            .header-content {
                gap: 12px;
                justify-content: space-between;
            }
            
            .dashboard-badge {
                padding: 10px 14px;
                gap: 10px;
            }
            
            .dashboard-badge-icon {
                width: 32px;
                height: 32px;
                font-size: 18px;
            }
            
            .dashboard-badge-text {
                font-size: 12px;
            }
            
            .header-brand {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
            }
            
            .user-info {
                position: absolute;
                right: 0;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .header-logo-container {
                padding: 6px;
            }
            
            .header-logo {
                height: 38px;
            }
            
            .header-brand {
                gap: 12px;
            }
            
            .user-info {
                padding: 6px 12px;
                gap: 10px;
            }
            
            .user-avatar {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
            
            .user-name {
                font-size: 12px;
            }
            
            .user-role {
                font-size: 10px;
            }
            
            .tab-content {
                padding: 20px 15px;
            }
        }
        
        /* Activity Log Styles */
        .activity-log-section {
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            padding: 24px;
            margin-top: 20px;
        }
        
        .activity-log-container {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 12px;
            background: #f8f9fa;
            padding: 8px;
        }
        
        .activity-log-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .activity-log-container::-webkit-scrollbar-track {
            background: #f1f3f5;
            border-radius: 4px;
        }
        
        .activity-log-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
        }
        
        .activity-log-content {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 18px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 4px solid transparent;
        }
        
        .activity-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border-left-color: #667eea;
        }
        
        .activity-item:last-child {
            margin-bottom: 0;
        }
        
        .activity-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 16px;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .activity-icon.add {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .activity-icon.edit {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .activity-icon.delete {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }
        
        .activity-icon.appeal {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .activity-details {
            flex: 1;
            min-width: 0;
        }
        
        .activity-title {
            font-weight: 700;
            color: #1c1e21;
            margin-bottom: 6px;
            font-size: 15px;
            letter-spacing: -0.2px;
        }
        
        .activity-description {
            color: #6c757d;
            font-size: 13px;
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .activity-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 12px;
            color: #8a8d93;
            font-weight: 500;
        }
        
        .activity-time {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .activity-user {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        
        .no-activities {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .no-activities .icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .no-activities h3 {
            margin-bottom: 10px;
            color: #495057;
        }
        
        .no-activities p {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="loading-indicator" id="loadingIndicator" style="display: none;"></div>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="dashboard-badge">
                <div class="dashboard-badge-text">Guidance Counselor Dashboard</div>
            </div>
            <div class="header-brand">
                <div class="header-logo-container">
                    <img src="/static/logo.png" alt="Logo" class="header-logo">
                </div>
                <div class="header-text">
                    <h1>AI Uniform System</h1>
                </div>
            </div>
            <div class="user-info">
                <div class="user-avatar"></div>
                <div class="user-details">
                    {% set full_name = user.name or user.username or 'User' %}
                    {% set name_parts = full_name.split() %}
                    {% if name_parts|length > 1 and name_parts[0].endswith('.') %}
                        {# If name starts with a title (Mr., Mrs., Ms., etc.), keep title and last name #}
                        <div class="user-name">{{ name_parts[0] }} {{ name_parts[-1] }}</div>
                    {% else %}
                        {# Otherwise, just show the name as is #}
                        <div class="user-name">{{ full_name }}</div>
                    {% endif %}
                    <div class="user-role">{{ (user.role or 'Guidance Counselor').title() }}</div>
                </div>
                <div class="dropdown-container">
                    <button class="dropdown-btn" onclick="toggleDropdown()">
                        
                    </button>
                    <div class="dropdown-content" id="userDropdown">
                        <a href="#" class="dropdown-item" onclick="showHelpModal(); return false;">
                            <span class="dropdown-item-icon"></span> <span data-translate="help">Help</span>
                        </a>
                        <a href="#" class="dropdown-item" onclick="showLanguageModal(); return false;">
                            <span class="dropdown-item-icon"></span> <span data-translate="language">Language</span>
                        </a>
                        <a href="/logout" class="dropdown-item">
                            <span class="dropdown-item-icon"></span> <span data-translate="logout">Logout</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2 data-translate="navigation">Navigation</h2>
                <p data-translate="manage-tasks">Manage your tasks</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" onclick="showTab('violations')">
                        <span class="nav-icon"></span>
                        <span data-translate="violations">Violations</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showTab('appeals')">
                        <span class="nav-icon"></span>
                        <span data-translate="appeals">Appeals</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showTab('activity')">
                        <span class="nav-icon"></span>
                        <span data-translate="activity-log">Activity Log</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="container">
                <!-- Statistics Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-number">{{ violations|length }}</div>
                        <div class="stat-label" data-translate="total-violations">Total Violations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-number">{{ appeals|length }}</div>
                        <div class="stat-label" data-translate="pending-appeals">Pending Appeals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-number">{{ appeals|selectattr('status', 'equalto', 'Approved')|list|length }}</div>
                        <div class="stat-label" data-translate="approved-appeals">Approved Appeals</div>
                    </div>
                </div>

                <!-- Content Sections -->
                <div class="content-section">
                    <!-- Violations Tab -->
                    <div id="violations" class="tab-content active">
        <div class="section-header">
            <h3 class="section-title" data-translate="violations-management">Uniform Violations Management</h3>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openViolationModal()"> Add Violation</button>
            </div>
        </div>
        
                        
                        <div class="search-bar">
                            <input type="text" class="search-input" id="violationSearch" data-translate-placeholder="search-violations" placeholder="Search violations...">
                            <button class="btn btn-primary" onclick="searchViolations()" data-translate="search"> Search</button>
                        </div>
                        
                        <div class="violations-table-container">
                            <div class="violations-table-wrapper">
                                <table class="data-table">
                                <thead>
                                    <tr>
                                        <th data-translate="student">Student</th>
                                        <th data-translate="student-id">Student ID</th>
                                        <th data-translate="violation">Violation</th>
                                        <th data-translate="date">Date</th>
                                        <th data-translate="status">Status</th>
                                        <th data-translate="offense">Offense</th>
                                        <th data-translate="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="violationsTableBody">
                                    {% for violation in violations %}
                                    <tr class="violation-row" data-student="{{ violation.student_name or 'Unknown' }}" data-violation-id="{{ violation.id or 'unknown' }}">
                                        <td class="student-name-cell">
                                            {{ violation.student_name or 'Unknown Student' }}
                                        </td>
                                        <td class="student-id-cell">
                                            {{ violation.student_id or 'No ID' }}
                                        </td>
                                        <td>{{ violation.violation_type or 'Unknown Type' }}</td>
                                        <td><span class="status-badge status-{{ (violation.status or 'Pending').lower() }}">{{ violation.status or 'Pending' }}</span></td>
                                        <td class="count-cell">
                                            <span class="violation-count-badge">
                                                <!-- Offense will be populated by JavaScript -->
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-success" onclick="completeViolation('{{ violation.student_name or 'Unknown' }}')" data-translate="complete">Complete</button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Appeals Tab -->
                    <div id="appeals" class="tab-content">
                        <div class="section-header">
                            <h3 class="section-title">Appeals Management</h3>
                        </div>
                        
                        <div class="search-bar">
                            <input type="text" class="search-input" id="appealSearch" placeholder="Search appeals...">
                            <button class="btn btn-primary" onclick="searchAppeals()"> Search</button>
                        </div>
                        
                        <div class="appeals-table-container">
                            <div class="appeals-table-wrapper">
                        <table class="data-table appeals-table">
                            <thead>
                                <tr>
                                            <th style="text-align: left;">Student Name</th>
                                            <th style="text-align: left; width: 120px;">Student ID</th>
                                            <th style="text-align: center; width: 100px;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="appealsTableBody">
                                {% for appeal in appeals %}
                                <tr class="appeal-row">
                                    <td style="text-align: left; vertical-align: middle; padding-right: 8px;">
                                        <div class="student-info">
                                            <span class="clickable-student-name" onclick="console.log('Student name clicked for appeal ID:', '{{ appeal.id or 'unknown' }}'); viewAppealDetails('{{ appeal.id or 'unknown' }}')" title="Click to view appeal details for {{ appeal.student_name or 'Unknown' }}">
                                                {{ appeal.student_name or 'Unknown Student' }}
                                            </span>
                                            {% if appeal.created_automatically %}
                                            <span class="auto-badge" title="Auto-created from violation"></span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td style="text-align: left; vertical-align: middle; padding-left: 8px;">
                                        <span style="color: #666; font-size: 14px;">{{ appeal.student_id or 'N/A' }}</span>
                                    </td>
                                    <td style="text-align: center; vertical-align: middle;">
                                        <button class="btn btn-primary btn-sm view-btn" onclick="viewAppealDetails('{{ appeal.id or 'unknown' }}')" title="View appeal details">
                                            View
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Activity Log Tab -->
                    <div id="activity" class="tab-content">
                        <div class="section-header">
                            <h3 class="section-title"> Activity Log</h3>
                            <div class="action-buttons">
                                <button class="btn btn-danger" onclick="clearActivityLog()"> Clear Log</button>
                            </div>
                        </div>
                        
                        <div class="search-bar">
                            <input type="text" class="search-input" id="activitySearch" placeholder="Search activities...">
                            <button class="btn btn-primary" onclick="searchActivities()"> Search</button>
                        </div>
                        
                        <div class="activity-log-container">
                            <div id="activityLogContent" class="activity-log-content">
                                <div class="loading-spinner">Loading activity log...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Violation Modal -->
    <div id="violationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Violation</h3>
                <button class="close-btn" onclick="closeModal('violationModal')">&times;</button>
            </div>
            <div class="modal-body">
            <form id="violationForm">
                <div class="form-group">
                    <label class="form-label">Student Name</label>
                    <input type="text" class="form-input" name="student_name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Student ID</label>
                    <input type="text" class="form-input" name="student_id" pattern="[0-9]+" title="Please enter numbers only" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Violation Type</label>
                    <select class="form-select" name="violation_type" required>
                        <option value="Incomplete Uniform">Incomplete Uniform</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" name="date" id="violationDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Missing Items</label>
                    <textarea class="form-input form-textarea" name="description" required placeholder="Enter missing items (e.g., ID, Belt, Shoes)"></textarea>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">Save Violation</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('violationModal')">Cancel</button>
                </div>
            </form>
            </div>
        </div>
    </div>

    <!-- Appeal Modal -->
    <div id="appealModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Appeal</h3>
                <button class="close-btn" onclick="closeModal('appealModal')">&times;</button>
            </div>
            <div class="modal-body">
            <form id="appealForm">
                <div class="form-group">
                    <label class="form-label">Student Name</label>
                    <input type="text" class="form-input" name="student_name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Student ID</label>
                    <input type="text" class="form-input" name="student_id" pattern="[0-9]+" title="Please enter numbers only" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Reason Type</label>
                    <select class="form-select" name="reason_type" required>
                        <option value="">Select reason type</option>
                        <option value="Excused">Excused</option>
                        <option value="Unexcused">Unexcused</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Appeal Date</label>
                    <input type="date" class="form-input" name="appeal_date" required>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-success">Approve</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('appealModal')">Cancel</button>
                </div>
            </form>
            </div>
        </div>
    </div>

    <!-- Edit Violation Modal -->
    <div id="editViolationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Violation</h3>
                <button class="close-btn" onclick="closeModal('editViolationModal')">&times;</button>
            </div>
            <div class="modal-body">
            <form id="editViolationForm">
                <input type="hidden" id="editViolationId" name="id">
                <div class="form-group">
                    <label class="form-label">Student Name</label>
                    <input type="text" class="form-input" id="editStudentName" name="student_name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Student ID</label>
                    <input type="text" class="form-input" id="editStudentId" name="student_id" pattern="[0-9]+" title="Please enter numbers only" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" id="editEmailAddress" name="email_address" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Violation Type</label>
                    <select class="form-select" id="editViolationType" name="violation_type" required>
                        <option value="Incomplete Uniform">Incomplete Uniform</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input form-textarea" id="editDescription" name="description" required placeholder="Describe the violation details..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="editStatus" name="status" required>
                        <option value="">Select Status</option>
                        <option value="Warning">Warning</option>
                        <option value="Advisory">Advisory</option>
                        <option value="Guidance">Guidance</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">Update Violation</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editViolationModal')">Cancel</button>
                </div>
            </form>
            </div>
        </div>
    </div>

    <!-- Edit Appeal Modal -->
    <div id="editAppealModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Appeal</h3>
                <button class="close-btn" onclick="closeModal('editAppealModal')">&times;</button>
            </div>
            <div class="modal-body">
            <form id="editAppealForm">
                <input type="hidden" id="editAppealId" name="id">
                <div class="form-group">
                    <label class="form-label">Student Name</label>
                    <input type="text" class="form-input" id="editAppealStudentName" name="student_name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Reason Type</label>
                    <select class="form-select" id="editAppealReasonType" name="reason_type" required>
                        <option value="">Select reason type</option>
                        <option value="Excused">Excused</option>
                        <option value="Unexcused">Unexcused</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Reason Details</label>
                    <textarea class="form-input form-textarea" id="editAppealReason" name="reason" required placeholder="Describe the reason for the appeal..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Resolution Notes</label>
                    <textarea class="form-input form-textarea" id="editAppealResolutionNotes" name="resolution_notes" placeholder="Add resolution notes or follow-up actions..."></textarea>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">Update Appeal</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editAppealModal')">Cancel</button>
                </div>
            </form>
            </div>
        </div>
    </div>


    <!-- Alert Messages -->
    <div id="alertContainer"></div>

    <script>
        // Pass server-side data to JavaScript
        window.violationsData = {{ violations | tojson }};
        window.appealsData = {{ appeals | tojson }};
        
        console.log('Server data loaded:', {
            violations: window.violationsData,
            appeals: window.appealsData
        });
    </script>
    
    <script>
        // Tab functionality
        function showTab(tabName) {
            console.log('=== SHOWING TAB ===');
            console.log('Tab name:', tabName);
            
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            console.log('Found tab contents:', tabContents.length);
            tabContents.forEach(content => {
                console.log('Hiding tab:', content.id);
                content.classList.remove('active');
            });
            
            // Remove active class from all nav links
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => link.classList.remove('active'));
            
            // Show selected tab content
            const targetTab = document.getElementById(tabName);
            console.log('Target tab element:', targetTab);
            if (targetTab) {
                targetTab.classList.add('active');
                console.log('Added active class to:', tabName);
                
            } else {
                console.error('Tab not found:', tabName);
            }
            
            // Add active class to clicked nav link
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Load activities if activity tab is selected
            if (tabName === 'activity') {
                loadActivityLog();
            }
            
            // DISABLED: Appeals observer management - causing console messages
            // Observer functionality completely disabled
            window.appealsObserverActive = false;
            console.log('Appeals observer disabled for all tabs');
        }

        // Modal functionality
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            
            // Set today's date for violation form when modal opens
            if (modalId === 'violationModal') {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('violationDate').value = today;
            }
            
            // Set today's date for appeal form when modal opens
            if (modalId === 'appealModal') {
                setTimeout(() => {
                    const today = new Date().toISOString().split('T')[0];
                    const appealDateInput = document.querySelector('input[name="appeal_date"]');
                    if (appealDateInput) {
                        appealDateInput.value = today;
                    }
                }, 100);
            }
        }

        // Open violation modal function
        function openViolationModal() {
            openModal('violationModal');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            // Close dropdown when clicking outside
            if (!event.target.matches('.dropdown-btn') && !event.target.closest('.dropdown-container')) {
                const dropdown = document.getElementById('userDropdown');
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
            }
        }
        
        // Dropdown menu functions
        function toggleDropdown() {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }
        
        // Help modal function
        function showHelpModal() {
            // Close dropdown first
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
            
            // Remove existing help modal if any
            const existingModal = document.getElementById('helpModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const helpModalHtml = `
                <div id="helpModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 700px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Help & Navigation Guide</h3>
                            <button class="close-btn" onclick="closeModal('helpModal')">&times;</button>
                        </div>
                        <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                            <div style="padding: 20px;">
                                <h4 style="color: #1877f2; margin-bottom: 15px;"> Web Functionalities Guide</h4>
                                
                                <div style="margin-bottom: 25px;">
                                    <h5 style="color: #1c1e21; margin-bottom: 10px;"> Violations Management</h5>
                                    <ul style="line-height: 1.8; color: #65676b;">
                                        <li><strong>Add Violation:</strong> Click the " Add Violation" button to record a new uniform violation</li>
                                        <li><strong>View Violations:</strong> Click on a student name or the "View" button to see all violations for that student</li>
                                        <li><strong>Search:</strong> Use the search bar to find specific violations by student name or ID</li>
                                        <li><strong>Delete:</strong> Click the "Delete" button in the violations modal to remove a violation</li>
                                        <li><strong>Grouping:</strong> Violations are automatically grouped by student name</li>
                                    </ul>
                                </div>
                                
                                <div style="margin-bottom: 25px;">
                                    <h5 style="color: #1c1e21; margin-bottom: 10px;"> Appeals Management</h5>
                                    <ul style="line-height: 1.8; color: #65676b;">
                                        <li><strong>Add Appeal:</strong> Click the " Add Appeal" button to create a new appeal</li>
                                        <li><strong>View Appeals:</strong> Click on a student name or the "View" button to see all appeals for that student</li>
                                        <li><strong>Approve Appeals:</strong> Click "View Details" on an appeal, then click " Approve Appeal"</li>
                                        <li><strong>Reason Type:</strong> Select "Excused" or "Unexcused" when approving an appeal</li>
                                        <li><strong>Status:</strong> Appeals show as "Pending Review" until approved</li>
                                    </ul>
                                </div>
                                
                                <div style="margin-bottom: 25px;">
                                    <h5 style="color: #1c1e21; margin-bottom: 10px;"> Dashboard Features</h5>
                                    <ul style="line-height: 1.8; color: #65676b;">
                                        <li><strong>Statistics Cards:</strong> View total violations, pending appeals, and approved appeals at the top</li>
                                        <li><strong>Activity Log:</strong> Switch to the "Activity Log" tab to see all system activities</li>
                                        <li><strong>Navigation:</strong> Use the sidebar to switch between Violations, Appeals, and Activity Log</li>
                                    </ul>
                                </div>
                                
                                <div style="margin-bottom: 25px;">
                                    <h5 style="color: #1c1e21; margin-bottom: 10px;"> Tips & Shortcuts</h5>
                                    <ul style="line-height: 1.8; color: #65676b;">
                                        <li>Use the search functionality to quickly find students</li>
                                        <li>Click on student names to view their complete violation/appeal history</li>
                                        <li>All data is automatically saved and synced</li>
                                        <li>Scroll through tables when there are many entries</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('helpModal')">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', helpModalHtml);
        }
        
        // Translation dictionary
        const translations = {
            en: {
                'dashboard-title': 'Guidance Counselor Dashboard',
                'navigation': 'Navigation',
                'manage-tasks': 'Manage your tasks',
                'violations': 'Violations',
                'appeals': 'Appeals',
                'activity-log': 'Activity Log',
                'total-violations': 'Total Violations',
                'pending-appeals': 'Pending Appeals',
                'approved-appeals': 'Approved Appeals',
                'violations-management': 'Uniform Violations Management',
                'add-violation': 'Add Violation',
                'clear-all': 'Clear All',
                'search-violations': 'Search violations...',
                'search': 'Search',
                'student': 'Student',
                'student-id': 'Student ID',
                'violation': 'Violation',
                'status': 'Status',
                'offense': 'Offense',
                'actions': 'Actions',
                'delete': 'Delete',
                'edit': 'Edit',
                'view': 'View',
                'help': 'Help',
                'language': 'Language',
                'logout': 'Logout',
                'select-language': 'Select Language',
                'choose-language': 'Choose your preferred language:',
                'save-language': 'Save Language',
                'cancel': 'Cancel',
                'language-saved': 'Language changed successfully!',
                'appeals-management': 'Appeals Management',
                'add-appeal': 'Add Appeal',
                'appeal-date': 'Appeal Date',
                'reason': 'Reason',
                'submitted-by': 'Submitted By'
            },
            es: {
                'dashboard-title': 'Panel de Consejero de Orientacin',
                'navigation': 'Navegacin',
                'manage-tasks': 'Administra tus tareas',
                'violations': 'Violaciones',
                'appeals': 'Apelaciones',
                'activity-log': 'Registro de Actividad',
                'total-violations': 'Violaciones Totales',
                'pending-appeals': 'Apelaciones Pendientes',
                'approved-appeals': 'Apelaciones Aprobadas',
                'violations-management': 'Gestin de Violaciones de Uniforme',
                'add-violation': 'Agregar Violacin',
                'clear-all': 'Limpiar Todo',
                'search-violations': 'Buscar violaciones...',
                'search': 'Buscar',
                'student': 'Estudiante',
                'student-id': 'ID del Estudiante',
                'violation': 'Violacin',
                'status': 'Estado',
                'offense': 'Infraccin',
                'actions': 'Acciones',
                'delete': 'Eliminar',
                'edit': 'Editar',
                'view': 'Ver',
                'help': 'Ayuda',
                'language': 'Idioma',
                'logout': 'Cerrar Sesin',
                'select-language': 'Seleccionar Idioma',
                'choose-language': 'Elige tu idioma preferido:',
                'save-language': 'Guardar Idioma',
                'cancel': 'Cancelar',
                'language-saved': 'Idioma cambiado exitosamente!',
                'appeals-management': 'Gestin de Apelaciones',
                'add-appeal': 'Agregar Apelacin',
                'appeal-date': 'Fecha de Apelacin',
                'reason': 'Razn',
                'submitted-by': 'Enviado Por'
            },
            tl: {
                'dashboard-title': 'Dashboard ng Guidance Counselor',
                'navigation': 'Navegasyon',
                'manage-tasks': 'Pamahalaan ang iyong mga gawain',
                'violations': 'Mga Paglabag',
                'appeals': 'Mga Apela',
                'activity-log': 'Activity Log',
                'total-violations': 'Kabuuang Paglabag',
                'pending-appeals': 'Mga Pending na Apela',
                'approved-appeals': 'Mga Naaprubahang Apela',
                'violations-management': 'Pamamahala ng Uniform Violations',
                'add-violation': 'Magdagdag ng Paglabag',
                'clear-all': 'Linisin Lahat',
                'search-violations': 'Maghanap ng paglabag...',
                'search': 'Maghanap',
                'student': 'Estudyante',
                'student-id': 'ID ng Estudyante',
                'violation': 'Paglabag',
                'status': 'Estado',
                'offense': 'Paglabag',
                'actions': 'Mga Aksyon',
                'delete': 'Tanggalin',
                'edit': 'I-edit',
                'view': 'Tingnan',
                'help': 'Tulong',
                'language': 'Wika',
                'logout': 'Mag-logout',
                'select-language': 'Pumili ng Wika',
                'choose-language': 'Piliin ang iyong gustong wika:',
                'save-language': 'I-save ang Wika',
                'cancel': 'Kanselahin',
                'language-saved': 'Matagumpay na napalitan ang wika!',
                'appeals-management': 'Pamamahala ng Apela',
                'add-appeal': 'Magdagdag ng Apela',
                'appeal-date': 'Petsa ng Apela',
                'reason': 'Dahilan',
                'submitted-by': 'Isinumite Ni'
            },
            zh: {
                'dashboard-title': '',
                'navigation': '',
                'manage-tasks': '',
                'violations': '',
                'appeals': '',
                'activity-log': '',
                'total-violations': '',
                'pending-appeals': '',
                'approved-appeals': '',
                'violations-management': '',
                'add-violation': '',
                'clear-all': '',
                'search-violations': '...',
                'search': '',
                'student': '',
                'student-id': 'ID',
                'violation': '',
                'status': '',
                'offense': '',
                'actions': '',
                'delete': '',
                'edit': '',
                'view': '',
                'help': '',
                'language': '',
                'logout': '',
                'select-language': '',
                'choose-language': ':',
                'save-language': '',
                'cancel': '',
                'language-saved': '',
                'appeals-management': '',
                'add-appeal': '',
                'appeal-date': '',
                'reason': '',
                'submitted-by': ''
            },
            ja: {
                'dashboard-title': '',
                'navigation': '',
                'manage-tasks': '',
                'violations': '',
                'appeals': '',
                'activity-log': '',
                'total-violations': '',
                'pending-appeals': '',
                'approved-appeals': '',
                'violations-management': '',
                'add-violation': '',
                'clear-all': '',
                'search-violations': '...',
                'search': '',
                'student': '',
                'student-id': 'ID',
                'violation': '',
                'status': '',
                'offense': '',
                'actions': '',
                'delete': '',
                'edit': '',
                'view': '',
                'help': '',
                'language': '',
                'logout': '',
                'select-language': '',
                'choose-language': ':',
                'save-language': '',
                'cancel': '',
                'language-saved': '',
                'appeals-management': '',
                'add-appeal': '',
                'appeal-date': '',
                'reason': '',
                'submitted-by': ''
            }
        };
        
        // Apply translations to the page
        function applyTranslations(lang) {
            const langTranslations = translations[lang] || translations['en'];
            
            // Update elements with data-translate attribute
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (langTranslations[key]) {
                    element.textContent = langTranslations[key];
                }
            });
            
            // Update placeholders
            document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
                const key = element.getAttribute('data-translate-placeholder');
                if (langTranslations[key]) {
                    element.placeholder = langTranslations[key];
                }
            });
            
            // Update title attributes
            document.querySelectorAll('[data-translate-title]').forEach(element => {
                const key = element.getAttribute('data-translate-title');
                if (langTranslations[key]) {
                    element.title = langTranslations[key];
                }
            });
        }
        
        // Language modal function
        function showLanguageModal() {
            // Close dropdown first
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
            
            // Remove existing language modal if any
            const existingModal = document.getElementById('languageModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Get current language from localStorage or default to English
            const currentLanguage = localStorage.getItem('selectedLanguage') || 'en';
            
            const languageModalHtml = `
                <div id="languageModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 class="modal-title" data-translate="select-language">Select Language</h3>
                            <button class="close-btn" onclick="closeModal('languageModal')">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 20px;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #1c1e21;" data-translate="choose-language">Choose your preferred language:</label>
                                <select id="languageSelect" style="width: 100%; padding: 10px; border: 2px solid #e4e6ea; border-radius: 6px; font-size: 14px; background: white; cursor: pointer;" onchange="changeLanguageImmediately(this.value)">
                                    <option value="en" ${currentLanguage === 'en' ? 'selected' : ''}> English</option>
                                    <option value="es" ${currentLanguage === 'es' ? 'selected' : ''}> Espaol (Spanish)</option>
                                    <option value="tl" ${currentLanguage === 'tl' ? 'selected' : ''}> Tagalog (Filipino)</option>
                                    <option value="zh" ${currentLanguage === 'zh' ? 'selected' : ''}>  (Chinese)</option>
                                    <option value="ja" ${currentLanguage === 'ja' ? 'selected' : ''}>  (Japanese)</option>
                                </select>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 15px;">
                                <p style="margin: 0; color: #65676b; font-size: 13px;">
                                    <strong>Note:</strong> <span data-translate="language-saved">Language changes will be applied immediately.</span>
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="saveLanguage()" data-translate="save-language">Save Language</button>
                            <button class="btn btn-secondary" onclick="closeModal('languageModal')" data-translate="cancel">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', languageModalHtml);
            
            // Apply translations to modal
            const savedLang = localStorage.getItem('selectedLanguage') || 'en';
            applyTranslations(savedLang);
        }
        
        // Change language immediately when dropdown changes
        function changeLanguageImmediately(lang) {
            localStorage.setItem('selectedLanguage', lang);
            applyTranslations(lang);
            showAlert(translations[lang]?.['language-saved'] || 'Language changed successfully!', 'success');
        }
        
        // Save language selection
        function saveLanguage() {
            const languageSelect = document.getElementById('languageSelect');
            if (languageSelect) {
                const selectedLanguage = languageSelect.value;
                changeLanguageImmediately(selectedLanguage);
                closeModal('languageModal');
            }
        }

        // Form submissions
        document.getElementById('violationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Prevent double submission
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn.disabled) {
                return; // Already processing
            }
            
            // Disable submit button and show loading
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            fetch('/api/violations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert('Violation added successfully!', 'success');
                    closeModal('violationModal');
                    
                    // Log activity
                    logActivity('add', 'violation', 'Violation Added', `New violation added for ${data.student_name}`, `Offense: ${data.offense || 'Unknown'}, Date: ${data.date || 'Unknown'}`);
                    
                    // Reset form
                    this.reset();
                    
                    // Automatically refresh the table to show the new violation
                    console.log('Violation added successfully, refreshing data...');
                    // Add a small delay to ensure server cache is cleared and modal is closed
                    setTimeout(() => {
                        console.log('Starting refresh after add violation...');
                        refreshDataOnly();
                    }, 1500); // Wait 1.5 seconds to ensure everything is processed
                } else {
                    // Handle duplicate error specifically
                    if (result.duplicate) {
                        showAlert(' Duplicate Violation: ' + result.error, 'warning');
                    } else {
                        showAlert('Error adding violation: ' + (result.error || result.message || 'Unknown error'), 'error');
                    }
                }
            })
            .catch(error => {
                showAlert('Error adding violation: ' + error.message, 'error');
            })
            .finally(() => {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Violation';
            });
        });


        document.getElementById('appealForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            // Validate required fields
            if (!data.reason_type) {
                showAlert('Please select a reason type (Excused or Unexcused)', 'error');
                return;
            }
            
            // Automatically set status to approved
            data.status = 'Approved';
            data.approved_date = new Date().toISOString();
            data.approved_by = 'Guidance Counselor'; // You can modify this to get actual user
            
            fetch('/api/appeals', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert('Appeal approved and saved successfully!', 'success');
                    
                    // Log activity
                    logActivity('add', 'appeal', 'Appeal Added', `New appeal submitted by ${data.student_name}`, `Reason: ${data.reason_type}, Student ID: ${data.student_id || 'N/A'}`);
                    
                    closeModal('appealModal');
                    
                    // Reset form
                    this.reset();
                    
                    // Automatically refresh the table to show the new appeal
                    setTimeout(() => {
                        refreshDataOnly();
                    }, 500); // Wait 500ms to show the success message
                    
                    // Also refresh after a longer delay to ensure data is updated
                    setTimeout(() => {
                        refreshDataOnly();
                    }, 2000);
                } else {
                    showAlert('Error adding appeal: ' + (result.error || result.message || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showAlert('Error adding appeal: ' + error.message, 'error');
            });
        });


        // Edit Violation Form Handler
        document.getElementById('editViolationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            const violationId = data.id;
            
            // Remove the id from the data object as it's not needed in the update
            delete data.id;
            
            fetch(`/api/violations/${violationId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert('Violation updated successfully!', 'success');
                    
                    // Log activity
                    logActivity('edit', 'violation', 'Violation Updated', `Violation for ${data.student_name} has been updated`, `Student: ${data.student_name}, Type: ${data.violation_type}, Status: ${data.status}`);
                    
                    closeModal('editViolationModal');
                    
                    // Automatically refresh the table to show the updated violation
                    setTimeout(() => {
                        refreshDataOnly();
                    }, 1000); // Wait 1 second to show the success message
                } else {
                    showAlert('Error updating violation: ' + (result.error || result.message || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showAlert('Error updating violation: ' + error.message, 'error');
            });
        });

        // Edit Appeal Form Handler
        document.getElementById('editAppealForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            const appealId = data.id;
            
            // Validate required fields
            if (!data.reason_type) {
                showAlert('Please select a reason type (Excused or Unexcused)', 'error');
                return;
            }
            
            if (!data.reason || data.reason.trim() === '') {
                showAlert('Please provide reason details', 'error');
                return;
            }
            
            // Remove the id from the data object as it's not needed in the update
            delete data.id;
            
            fetch(`/api/appeals/${appealId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert('Appeal updated successfully!', 'success');
                    
                    // Log activity
                    logActivity('edit', 'appeal', 'Appeal Updated', `Appeal for ${data.student_name} has been updated`, `Status: ${data.status}, Reason: ${data.reason_type}`);
                    
                    closeModal('editAppealModal');
                    location.reload();
                } else {
                    showAlert('Error updating appeal: ' + (result.error || result.message || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showAlert('Error updating appeal: ' + error.message, 'error');
            });
        });



        // Search functionality
        // Store current search term for violations
        let currentViolationSearchTerm = '';

        function searchViolations() {
            const searchTerm = document.getElementById('violationSearch').value.toLowerCase();
            currentViolationSearchTerm = searchTerm;
            const rows = document.querySelectorAll('#violationsTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
            
            // Recalculate counts after search
            refreshViolationCounts();
        }
        
        // Reapply search filter after table rebuild
        function reapplyViolationSearch() {
            if (currentViolationSearchTerm) {
                const rows = document.querySelectorAll('#violationsTableBody tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(currentViolationSearchTerm) ? '' : 'none';
                });
            }
        }

        function searchAppeals() {
            const searchTerm = document.getElementById('appealSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#appealsTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }


        function groupAppealRows() {
            const tableBody = document.getElementById('appealsTableBody');
            if (!tableBody) return;

            const rows = Array.from(tableBody.querySelectorAll('tr'));
            if (rows.length === 0) return;

            // console.log('Found appeal rows:', rows.length); // Disabled to prevent console messages

            // Check if already grouped (has appeal-count-badge)
            const hasGroupedStructure = tableBody.querySelector('.appeal-count-badge');
            if (hasGroupedStructure) {
                // console.log('Appeals already grouped, but checking for duplicates...'); // Disabled to prevent console messages
                // Check if there are still duplicate student names
                const studentNames = Array.from(tableBody.querySelectorAll('.clickable-student-name')).map(el => el.textContent.trim());
                const uniqueNames = new Set(studentNames);
                if (studentNames.length === uniqueNames.size) {
                    // console.log('No duplicates found, keeping current structure'); // Disabled to prevent console messages
                    return;
                } else {
                    // console.log('Duplicates found, re-grouping...'); // Disabled to prevent console messages
                }
            }

            // Group rows by student name
            const groupedRows = {};
            rows.forEach(row => {
                const studentNameElement = row.querySelector('.clickable-student-name');
                if (studentNameElement) {
                    const studentName = studentNameElement.textContent.trim();
                    if (!groupedRows[studentName]) {
                        groupedRows[studentName] = [];
                    }
                    groupedRows[studentName].push(row);
                } else {
                    // If no clickable-student-name found, try to get from data attribute or text content
                    const studentName = row.dataset.student || row.querySelector('td:first-child')?.textContent.trim();
                    if (studentName) {
                        if (!groupedRows[studentName]) {
                            groupedRows[studentName] = [];
                        }
                        groupedRows[studentName].push(row);
                    }
                }
            });

            // console.log('Grouped appeals by student:', Object.keys(groupedRows)); // Disabled to prevent console messages

            // Always group by student name to show one row per student
            // Clear table body completely
            tableBody.innerHTML = '';

            // Create one row per student
            Object.keys(groupedRows).forEach(studentName => {
                const studentAppeals = groupedRows[studentName];
                const count = studentAppeals.length;
                
                console.log(`Student: ${studentName}, Appeals: ${count}`);
                
                // Extract student ID from the first row (second td contains student_id)
                const firstRow = studentAppeals[0];
                const studentIdCell = firstRow.querySelector('td:nth-child(2)');
                const studentId = studentIdCell ? (studentIdCell.textContent.trim() || 'N/A') : 'N/A';
                
                // Create main student row
                const studentRow = document.createElement('tr');
                studentRow.className = 'student-row';
                
                studentRow.innerHTML = `
                    <td style="text-align: left; vertical-align: middle; padding-right: 8px;">
                        <div class="student-info-container">
                            <span class="clickable-student-name student-name-display" onclick="viewStudentAppeals('${studentName}')" title="Click to view all appeals for ${studentName}">
                                ${studentName}
                            </span>
                            <span class="appeal-count-badge">${count} appeal${count > 1 ? 's' : ''}</span>
                        </div>
                    </td>
                    <td style="text-align: left; vertical-align: middle; padding-left: 8px; width: 120px;">
                        <span style="color: #666; font-size: 14px;">${studentId}</span>
                    </td>
                    <td style="text-align: center; vertical-align: middle;">
                        <button class="btn btn-primary btn-sm view-btn" onclick="viewStudentAppeals('${studentName}')" title="View all appeals for ${studentName}">
                            View
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(studentRow);
            });
        }

        function reapplyGrouping() {
            // Re-apply grouping after data changes
            setTimeout(() => {
                calculateViolationCounts();
                groupAppealRows();
            }, 1000); // Wait a bit longer for data to load
        }

        function forceGrouping() {
            // Force grouping regardless of current state
            // console.log('Force grouping appeals...'); // Disabled to prevent console messages
            const tableBody = document.getElementById('appeals').querySelector('tbody');
            if (!tableBody) return;

            // Clear any existing grouping
            const existingRows = Array.from(tableBody.querySelectorAll('tr'));
            if (existingRows.length === 0) return;

            // Always re-group
            tableBody.innerHTML = '';
            
            // Group rows by student name
            const groupedRows = {};
            existingRows.forEach(row => {
                const studentNameElement = row.querySelector('.clickable-student-name');
                if (studentNameElement) {
                    const studentName = studentNameElement.textContent.trim();
                    if (!groupedRows[studentName]) {
                        groupedRows[studentName] = [];
                    }
                    groupedRows[studentName].push(row);
                } else {
                    // If no clickable-student-name found, try to get from data attribute or text content
                    const studentName = row.dataset.student || row.querySelector('td:first-child')?.textContent.trim();
                    if (studentName) {
                        if (!groupedRows[studentName]) {
                            groupedRows[studentName] = [];
                        }
                        groupedRows[studentName].push(row);
                    }
                }
            });

            // Create one row per student
            Object.keys(groupedRows).forEach(studentName => {
                const studentAppeals = groupedRows[studentName];
                const count = studentAppeals.length;
                
                // Extract student ID from the first row (second td contains student_id)
                const firstRow = studentAppeals[0];
                const studentIdCell = firstRow.querySelector('td:nth-child(2)');
                const studentId = studentIdCell ? (studentIdCell.textContent.trim() || 'N/A') : 'N/A';
                
                // Create main student row
                const studentRow = document.createElement('tr');
                studentRow.className = 'student-row';
                
                studentRow.innerHTML = `
                    <td style="text-align: left; vertical-align: middle; padding-right: 8px;">
                        <div class="student-info-container">
                            <span class="clickable-student-name student-name-display" onclick="viewStudentAppeals('${studentName}')" title="Click to view all appeals for ${studentName}">
                                ${studentName}
                            </span>
                            <span class="appeal-count-badge">${count} appeal${count > 1 ? 's' : ''}</span>
                        </div>
                    </td>
                    <td style="text-align: left; vertical-align: middle; padding-left: 8px; width: 120px;">
                        <span style="color: #666; font-size: 14px;">${studentId}</span>
                    </td>
                    <td style="text-align: center; vertical-align: middle;">
                        <button class="btn btn-primary btn-sm view-btn" onclick="viewStudentAppeals('${studentName}')" title="View all appeals for ${studentName}">
                            View
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(studentRow);
            });
        }


        // Activity Log Functions
        function showActivityLog() {
            // This function is now handled by the tab system
            showTab('activity');
        }

        function loadActivityLog() {
            console.log('Loading activity log...');
            const content = document.getElementById('activityLogContent');
            if (!content) {
                console.error('Activity log content element not found');
                return;
            }
            
            content.innerHTML = '<div class="loading-spinner">Loading activity log...</div>';
            
            // Load activities from localStorage
            setTimeout(() => {
                console.log('Loading activities...');
                const storedActivities = JSON.parse(localStorage.getItem('activities') || '[]');
                console.log('Stored activities:', storedActivities);
                
                // Ensure all activities have proper timestamps
                const validActivities = storedActivities.filter(activity => {
                    if (!activity.timestamp) {
                        console.warn('Activity missing timestamp:', activity);
                        return false;
                    }
                    return true;
                });
                
                // Sort by timestamp (newest first)
                const sortedActivities = validActivities.sort((a, b) => {
                    const timeA = new Date(a.timestamp);
                    const timeB = new Date(b.timestamp);
                    return timeB - timeA;
                });
                
                console.log('Valid activities:', validActivities.length);
                console.log('Sorted activities:', sortedActivities);
                displayActivities(sortedActivities);
            }, 100);
        }


        function displayActivities(activities) {
            console.log('Displaying activities:', activities);
            const content = document.getElementById('activityLogContent');
            
            if (!content) {
                console.error('Activity log content element not found in displayActivities');
                return;
            }
            
            if (activities.length === 0) {
                console.log('No activities to display');
                content.innerHTML = `
                    <div class="no-activities">
                        <div class="icon"></div>
                        <h3>No Activities Found</h3>
                        <p>No activities have been recorded yet.</p>
                    </div>
                `;
                return;
            }
            
            const activitiesHtml = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-icon ${activity.type}">
                        ${getActivityIcon(activity.type, activity.category)}
                    </div>
                    <div class="activity-details">
                        <div class="activity-title">${activity.title}</div>
                        <div class="activity-description">${activity.description}</div>
                        <div class="activity-meta">
                            <div class="activity-time">
                                <span></span>
                                <span>${formatTimestamp(activity.timestamp)}</span>
                            </div>
                            <div class="activity-user">
                                <span></span>
                                <span>${activity.user}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            content.innerHTML = activitiesHtml;
        }

        function getActivityIcon(type, category) {
            const icons = {
                add: { violation: '', appeal: '', design: '', system: '' },
                edit: { violation: '', appeal: '', design: '', system: '' },
                delete: { violation: '', appeal: '', design: '', system: '' }
            };
            return icons[type]?.[category] || '';
        }

        function formatTimestamp(timestamp) {
            const now = new Date();
            const activityTime = new Date(timestamp);
            
            // Check if timestamp is valid
            if (isNaN(activityTime.getTime())) {
                return 'Unknown time';
            }
            
            const diff = now - activityTime;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            
            return activityTime.toLocaleDateString();
        }

        function refreshActivityLog() {
            loadActivityLog();
        }
        
        
        function filterStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const studentItems = document.querySelectorAll('.student-item');
            
            studentItems.forEach(item => {
                const studentName = item.getAttribute('data-student').toLowerCase();
                if (studentName.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function viewLatestAppeal(appealId) {
            viewAppeal(appealId);
        }
        
        function addInitialActivities() {
            // Check if activities already exist
            const existingActivities = JSON.parse(localStorage.getItem('activities') || '[]');
            if (existingActivities.length > 0) {
                console.log('Activities already exist, skipping initial setup');
                return;
            }
            
            // Create some initial activities
            const initialActivities = [
                {
                    id: 'welcome_1',
                    type: 'add',
                    category: 'system',
                    title: 'System Initialized',
                    description: 'Uniform Guard system has been started',
                    details: 'Welcome to the Uniform Guard management system',
                    timestamp: new Date(),
                    user: 'System'
                },
                {
                    id: 'welcome_2',
                    type: 'add',
                    category: 'system',
                    title: 'Dashboard Loaded',
                    description: 'Guidance counselor dashboard is ready for use',
                    details: 'All systems operational and ready for data entry',
                    timestamp: new Date(Date.now() - 30000),
                    user: 'System'
                }
            ];
            
            localStorage.setItem('activities', JSON.stringify(initialActivities));
            console.log('Initial activities created');
        }

        function exportActivityLog() {
            const activities = JSON.parse(localStorage.getItem('activities') || '[]');
            const csvContent = [
                ['Timestamp', 'Type', 'Category', 'Title', 'Description', 'User'],
                ...activities.map(activity => [
                    activity.timestamp.toISOString(),
                    activity.type,
                    activity.category,
                    activity.title,
                    activity.description,
                    activity.user
                ])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'activity_log.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function clearActivityLog() {
            if (confirm('Are you sure you want to clear the activity log? This action cannot be undone.')) {
                const content = document.getElementById('activityLogContent');
                content.innerHTML = `
                    <div class="no-activities">
                        <div class="icon"></div>
                        <h3>Activity Log Cleared</h3>
                        <p>All activities have been cleared from the log.</p>
                    </div>
                `;
            }
        }

        function searchActivities() {
            const searchTerm = document.getElementById('activitySearch').value.toLowerCase();
            const activityItems = document.querySelectorAll('.activity-item');
            
            activityItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        // Test function to add sample activities

        // Test function to test appeal modal

        // Get current user function
        function getCurrentUser() {
            // Try to get user from session data or use a default
            const userElement = document.querySelector('.user-info .user-name');
            if (userElement) {
                return userElement.textContent.trim();
            }
            // Fallback to session data if available
            return '{{ user.name }}' || 'Unknown User';
        }

        // Activity logging function
        function logActivity(type, category, title, description, details = '') {
            console.log(`[ACTIVITY LOG] Logging activity: ${type} - ${category} - ${title}`);
            
            const activity = {
                id: `${category}_${Date.now()}`,
                type: type,
                category: category,
                title: title,
                description: description,
                details: details,
                timestamp: new Date(),
                user: getCurrentUser() // Get actual current user
            };
            
            // Store in localStorage for persistence
            let activities = JSON.parse(localStorage.getItem('activities') || '[]');
            activities.unshift(activity); // Add to beginning
            activities = activities.slice(0, 100); // Keep only last 100 activities
            localStorage.setItem('activities', JSON.stringify(activities));
            
            console.log(`[ACTIVITY LOG] Activity stored. Total activities: ${activities.length}`);
            
            // If activity log tab is active, refresh it
            const activityTab = document.getElementById('activity');
            if (activityTab && activityTab.classList.contains('active')) {
                console.log('[ACTIVITY LOG] Activity tab is active, refreshing...');
                loadActivityLog();
            } else {
                console.log('[ACTIVITY LOG] Activity tab is not active');
            }
            
            // Activity logged successfully
        }

        // Function to check and log new violations from student_violations
        function checkAndLogNewViolations(violations) {
            if (!violations || !Array.isArray(violations)) {
                return;
            }

            // Get tracked violation IDs from localStorage
            const trackedViolations = JSON.parse(localStorage.getItem('trackedStudentViolations') || '[]');
            const trackedIds = new Set(trackedViolations);

            // Find new violations from student_violations collection
            const newViolations = violations.filter(violation => {
                // Check if violation is from student_violations collection
                // Violations from student_violations have source='student_violations' or reported_by='System'
                const isFromStudentViolations = violation.source === 'student_violations' || 
                                               violation.reported_by === 'System' ||
                                               (violation.id && !violation.reported_by);
                
                // Check if we haven't logged this violation yet
                const isNew = violation.id && !trackedIds.has(violation.id);
                
                return isFromStudentViolations && isNew;
            });

            // Log each new violation
            newViolations.forEach(violation => {
                const studentName = violation.student_name || 'Unknown Student';
                const studentId = violation.student_id || 'N/A';
                const violationType = violation.violation_type || 'Uniform Violation';
                const violationDate = violation.date || new Date().toLocaleDateString();

                logActivity(
                    'add',
                    'violation',
                    'Automatic Violation Detected',
                    `New violation automatically detected for ${studentName}`,
                    `Student: ${studentName} (ID: ${studentId}), Type: ${violationType}, Date: ${violationDate}, Source: Guard Detection System`
                );

                // Add to tracked violations
                trackedIds.add(violation.id);
                console.log(`[ACTIVITY LOG] Logged new automatic violation: ${violation.id} for ${studentName}`);
            });

            // Update tracked violations list (keep last 500 IDs)
            const updatedTracked = Array.from(trackedIds).slice(-500);
            localStorage.setItem('trackedStudentViolations', JSON.stringify(updatedTracked));

            if (newViolations.length > 0) {
                console.log(`[ACTIVITY LOG] Logged ${newViolations.length} new automatic violation(s) from student_violations collection`);
            }
        }

        function updateActivityCount() {
            const activities = JSON.parse(localStorage.getItem('activities') || '[]');
            const totalActivities = activities.length;
            
            const activityCountElement = document.getElementById('activityCount');
            if (activityCountElement) {
                activityCountElement.textContent = totalActivities;
            }
        }

        // Action functions
        function editViolation(id) {
            // Find the violation data from the table
            const table = document.getElementById('violationsTableBody');
            const rows = table.querySelectorAll('tr');
            
            for (let row of rows) {
                const editBtn = row.querySelector('button[onclick*="editViolation"]');
                if (editBtn && editBtn.getAttribute('onclick').includes(id)) {
                    const cells = row.querySelectorAll('td');
                    
                    // Populate the edit form with current data
                    document.getElementById('editViolationId').value = id;
                    document.getElementById('editStudentName').value = cells[0].textContent.trim();
                    document.getElementById('editStudentId').value = cells[1].textContent.trim();
                    document.getElementById('editEmailAddress').value = ''; // Default empty email
                    document.getElementById('editViolationType').value = cells[2].textContent.trim();
                    document.getElementById('editDescription').value = 'Violation details...'; // Default description
                    
                    // Extract status from the badge
                    const statusBadge = cells[3].querySelector('.status-badge');
                    const status = statusBadge ? statusBadge.textContent.trim() : 'Warning';
                    document.getElementById('editStatus').value = status;
                    
                    // Open the edit modal
                    openModal('editViolationModal');
                    break;
                }
            }
        }

        function deleteViolation(id) {
            if (confirm('Are you sure you want to delete this violation?')) {
                fetch(`/api/violations/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showAlert('Violation deleted successfully!', 'success');
                        
                        // Log activity
                        logActivity('delete', 'violation', 'Violation Deleted', `Violation ${id} deleted from system`, `ID: ${id}`);
                        
                        // Refresh the table immediately
                        refreshDataOnly();
                        
                        // Also refresh activity log if it's currently active
                        const activityTab = document.getElementById('activity');
                        if (activityTab && activityTab.classList.contains('active')) {
                            setTimeout(() => {
                                loadActivityLog();
                            }, 500);
                        }
                    } else {
                        showAlert('Error deleting violation: ' + (result.error || result.message || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    showAlert('Error deleting violation: ' + error.message, 'error');
                });
            }
        }

        function completeViolation(studentName) {
            if (confirm(`Are you sure you want to complete all violations for ${studentName}?\n\nThis will clear all violations for this student.`)) {
                // Show loading indicator
                showLoading();
                
                // Call the API to delete all violations for this student
                fetch(`/api/violations/student/${encodeURIComponent(studentName)}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(result => {
                    hideLoading();
                    
                    if (result.success) {
                        const deletedViolations = result.deleted_violations || 0;
                        
                        if (deletedViolations > 0) {
                            showAlert(` Successfully completed all violations for ${studentName}! (${deletedViolations} violation(s) cleared)`, 'success');
                            
                            // Log the activity
                            logActivity('complete', 'violation', 'Student Violations Completed', 
                                `All violations completed for student: ${studentName}`, 
                                `Student: ${studentName}, Violations cleared: ${deletedViolations}, Completed by: ${getCurrentUser()}`);
                            
                            // Refresh the table immediately
                            refreshDataOnly();
                            
                            // Also refresh activity log if it's currently active
                            const activityTab = document.getElementById('activity');
                            if (activityTab && activityTab.classList.contains('active')) {
                                setTimeout(() => {
                                    loadActivityLog();
                                }, 500);
                            }
                        } else {
                            showAlert(` No violations found for ${studentName}`, 'info');
                        }
                    } else {
                        showAlert(` Error completing violations: ${result.error || 'Unknown error'}`, 'error');
                    }
                })
                .catch(error => {
                    hideLoading();
                    showAlert(` Error completing violations: ${error.message}`, 'error');
                    console.error('Complete violations error:', error);
                });
            }
        }

        function clearAllViolations() {
            if (confirm(' WARNING: This will delete ALL violations permanently!\n\nAre you absolutely sure you want to continue?')) {
                if (confirm('This action cannot be undone. Type "DELETE ALL" to confirm:')) {
                    // Get all violations first
                    fetch('/api/violations', {
                        credentials: 'same-origin'
                    })
                        .then(response => response.json())
                        .then(result => {
                            if (!result.success) {
                                showAlert('Error fetching violations: ' + (result.error || 'Unknown error'), 'error');
                                return;
                            }
                            
                            const violations = result.data || result;
                            if (!violations || !Array.isArray(violations) || violations.length === 0) {
                                showAlert('No violations to delete.', 'info');
                                return;
                            }
                            
                            // Delete all violations one by one
                            let deletePromises = violations.map(violation => 
                                fetch(`/api/violations/${violation.id}`, {
                                    method: 'DELETE'
                                })
                            );
                            
                            Promise.all(deletePromises)
                                .then(responses => {
                                    const results = responses.map(response => response.json());
                                    return Promise.all(results);
                                })
                                .then(results => {
                                    const successCount = results.filter(result => result.success).length;
                                    if (successCount === violations.length) {
                                        showAlert(`Successfully deleted ${successCount} violations!`, 'success');
                                        
                                        // Log activity
                                        logActivity('delete', 'violation', 'Bulk Violation Deletion', `All ${successCount} violations have been deleted`, `Total deleted: ${successCount} violations`);
                                        
                                        refreshDataOnly();
                                    } else {
                                        showAlert(`Deleted ${successCount} out of ${violations.length} violations. Some may have failed.`, 'warning');
                                        
                                        // Log activity
                                        logActivity('delete', 'violation', 'Partial Violation Deletion', `${successCount} out of ${violations.length} violations deleted`, `Successfully deleted: ${successCount}, Failed: ${violations.length - successCount}`);
                                        
                                        refreshDataOnly();
                                    }
                                })
                                .catch(error => {
                                    showAlert('Error clearing violations: ' + error.message, 'error');
                                });
                        })
                        .catch(error => {
                            showAlert('Error fetching violations: ' + error.message, 'error');
                        });
                }
            }
        }

        function clearAllAppeals() {
            if (confirm(' WARNING: This will delete ALL appeals permanently!\n\nAre you absolutely sure you want to continue?')) {
                if (confirm('This action cannot be undone. Type "DELETE ALL" to confirm:')) {
                    // Get all appeals first
                    fetch('/api/appeals', {
                        credentials: 'same-origin'
                    })
                        .then(response => response.json())
                        .then(result => {
                            if (!result.success) {
                                showAlert('Error fetching appeals: ' + (result.error || 'Unknown error'), 'error');
                                return;
                            }
                            
                            const appeals = result.data || result;
                            if (!appeals || !Array.isArray(appeals) || appeals.length === 0) {
                                showAlert('No appeals to delete.', 'info');
                                return;
                            }
                            
                            // Delete all appeals one by one
                            let deletePromises = appeals.map(appeal => 
                                fetch(`/api/appeals/${appeal.id}`, {
                                    method: 'DELETE'
                                })
                            );
                            
                            Promise.all(deletePromises)
                                .then(responses => {
                                    const results = responses.map(response => response.json());
                                    return Promise.all(results);
                                })
                                .then(results => {
                                    const successCount = results.filter(result => result.success).length;
                                    if (successCount === appeals.length) {
                                        showAlert(`Successfully deleted ${successCount} appeals!`, 'success');
                                        
                                        // Log activity
                                        logActivity('delete', 'appeal', 'Bulk Appeal Deletion', `All ${successCount} appeals have been deleted`, `Total deleted: ${successCount} appeals`);
                                        
                                        location.reload();
                                    } else {
                                        showAlert(`Deleted ${successCount} out of ${appeals.length} appeals. Some may have failed.`, 'warning');
                                        
                                        // Log activity
                                        logActivity('delete', 'appeal', 'Partial Appeal Deletion', `${successCount} out of ${appeals.length} appeals deleted`, `Successfully deleted: ${successCount}, Failed: ${appeals.length - successCount}`);
                                        
                                        location.reload();
                                    }
                                })
                                .catch(error => {
                                    showAlert('Error clearing appeals: ' + error.message, 'error');
                                });
                        })
                        .catch(error => {
                            showAlert('Error fetching appeals: ' + error.message, 'error');
                        });
                }
            }
        }


        function clearAllData() {
            if (confirm(' CRITICAL WARNING: This will delete ALL data permanently!\n\nThis includes:\n- All Violations\n- All Appeals\n- All Designs\n\nAre you absolutely sure you want to continue?')) {
                if (confirm('This action cannot be undone and will clear your entire database!\n\nType "DELETE EVERYTHING" to confirm:')) {
                    // Clear all violations
                    fetch('/api/violations', {
                        credentials: 'same-origin'
                    })
                        .then(response => response.json())
                        .then(violationResult => {
                            const violations = violationResult.data || violationResult;
                            const violationPromises = Array.isArray(violations) ? violations.map(violation => 
                                fetch(`/api/violations/${violation.id}`, { method: 'DELETE', credentials: 'same-origin' })
                            ) : [];
                            
                            // Clear all appeals
                            return fetch('/api/appeals', {
                                credentials: 'same-origin'
                            })
                                .then(response => response.json())
                                .then(appealResult => {
                                    const appeals = appealResult.data || appealResult;
                                    const appealPromises = Array.isArray(appeals) ? appeals.map(appeal => 
                                        fetch(`/api/appeals/${appeal.id}`, { method: 'DELETE', credentials: 'same-origin' })
                                    ) : [];
                                    
                                    // Clear all designs
                                    return fetch('/api/designs', {
                                        credentials: 'same-origin'
                                    })
                                        .then(response => response.json())
                                        .then(designResult => {
                                            const designs = designResult.data || designResult;
                                            const designPromises = Array.isArray(designs) ? designs.map(design => 
                                                fetch(`/api/designs/${design.id}`, { method: 'DELETE', credentials: 'same-origin' })
                                            ) : [];
                                            
                                            // Execute all deletions
                                            return Promise.all([
                                                ...violationPromises,
                                                ...appealPromises,
                                                ...designPromises
                                            ]);
                                        });
                                });
                        })
                        .then(() => {
                            showAlert('All data has been cleared successfully!', 'success');
                            location.reload();
                        })
                        .catch(error => {
                            showAlert('Error clearing data: ' + error.message, 'error');
                        });
                }
            }
        }

        function approveAppeal(id) {
            if (confirm('Are you sure you want to approve this appeal?')) {
                fetch(`/api/appeals/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ status: 'Approved' })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        if (result.violation_deleted) {
                            showAlert('Appeal approved successfully! Related violation has been automatically deleted.', 'success');
                            
                            // Log activity
                            logActivity('edit', 'appeal', 'Appeal Approved', `Appeal with ID ${id} has been approved`, `Status: Approved, Related violation deleted`);
                        } else {
                            showAlert('Appeal approved successfully!', 'success');
                            
                            // Log activity
                            logActivity('edit', 'appeal', 'Appeal Approved', `Appeal with ID ${id} has been approved`, `Status: Approved`);
                        }
                        reapplyGrouping();
                        refreshDataOnly(); // Use the new refresh function that maintains current tab
                    } else {
                        showAlert('Error approving appeal: ' + (result.error || result.message || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    showAlert('Error approving appeal: ' + error.message, 'error');
                });
            }
        }



        function viewAppeal(id) {
            console.log('View appeal called with ID:', id);
            
            // Get appeals data
            let appealsData = window.currentAppealsData || [];
            
            // Find appeal by ID
            let appeal = appealsData.find(a => a.id === id || a.id === String(id));
            
            if (appeal) {
                showAppealDetailsModal(appeal);
            } else {
                alert('Appeal not found. Please refresh the page to load data.');
            }
        }
        

        // Function to load appeals data
        function loadAppealsData() {
            console.log('Loading appeals data...');
            return fetch('/api/appeals', {
                credentials: 'same-origin',
                cache: 'no-cache'
            })
            .then(response => {
                console.log('Appeals API response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('Appeals API response data:', result);
                let appealsData = null;
                if (result.success && result.data) {
                    appealsData = result.data;
                } else if (Array.isArray(result)) {
                    appealsData = result;
                }
                
                // Store appeals data globally
                window.currentAppealsData = appealsData || [];
                console.log('Stored appeals data:', window.currentAppealsData);
                return window.currentAppealsData;
            })
            .catch(error => {
                console.error('Error loading appeals data:', error);
                window.currentAppealsData = [];
                return [];
            });
        }

        // Debug function to show appeals data
        function debugAppealsData() {
            console.log('=== DEBUG: Appeals Data ===');
            console.log('Current appeals data:', window.currentAppealsData);
            console.log('Number of appeals:', window.currentAppealsData ? window.currentAppealsData.length : 0);
            if (window.currentAppealsData && window.currentAppealsData.length > 0) {
                console.log('First appeal:', window.currentAppealsData[0]);
                console.log('All appeal IDs:', window.currentAppealsData.map(a => a.id));
            }
            
            // Also check the actual table buttons
            const viewButtons = document.querySelectorAll('.view-btn');
            console.log('Found view buttons in table:', viewButtons.length);
            viewButtons.forEach((btn, index) => {
                console.log(`Button ${index} onclick:`, btn.getAttribute('onclick'));
            });
        }

        // Test function to verify viewAppeal is working
        function testViewAppeal() {
            console.log('Testing viewAppeal function...');
            debugAppealsData();
            
            // First try to use existing data
            let appealsData = window.currentAppealsData || [];
            
            if (appealsData.length > 0) {
                const testId = appealsData[0].id;
                console.log('Testing with existing appeal ID:', testId);
                viewAppeal(testId);
            } else {
                console.log('No appeals data in memory, loading from API...');
                // Load data from API
                loadAppealsData().then(loadedData => {
                    console.log('Loaded data:', loadedData);
                    debugAppealsData();
                    if (loadedData.length > 0) {
                        const testId = loadedData[0].id;
                        console.log('Testing with loaded appeal ID:', testId);
                        viewAppeal(testId);
                    } else {
                        console.log('No appeals data available for testing');
                        alert('No appeals data available for testing. Please add some appeals first.');
                    }
                });
            }
        }
        
        
        function showAppealDetailsModal(appeal) {
            console.log('Showing appeal details modal for:', appeal);
            
            // Remove any existing modal
            const existingModal = document.getElementById('appealDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal HTML
            const modalHtml = `
                <div id="appealDetailsModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    z-index: 9999;
                    display: block;
                ">
                    <div style="
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border-radius: 10px;
                        max-width: 600px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    ">
                        <!-- Header -->
                        <div style="
                            background: #1877f2;
                            color: white;
                            padding: 20px;
                            border-radius: 10px 10px 0 0;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h3 style="margin: 0; font-size: 20px;"> Appeal Details</h3>
                            <button onclick="closeAppealDetailsModal()" style="
                                background: rgba(255,255,255,0.2);
                                color: white;
                                border: none;
                                width: 30px;
                                height: 30px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 18px;
                            ">&times;</button>
                        </div>
                        
                        <!-- Content -->
                        <div style="padding: 15px;">
                            <!-- Student Info -->
                            <div style="background: #e3f2fd; padding: 12px 15px; border-radius: 6px; border-left: 4px solid #1877f2; margin-bottom: 15px;">
                                <div style="font-size: 12px; color: #1877f2; font-weight: 600; margin-bottom: 4px;">STUDENT</div>
                                <div style="font-size: 15px; font-weight: 600; color: #333;">${appeal.student_name || 'N/A'}</div>
                                <div style="font-size: 12px; color: #666; margin-top: 2px;">ID: ${appeal.student_id || 'N/A'}</div>
                            </div>
                            
                            <!-- Status and Reason Type Side by Side -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <!-- Status -->
                                <div style="background: #f8f9fa; padding: 12px 15px; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #1877f2; font-weight: 600; margin-bottom: 8px;">STATUS</div>
                                    <span style="padding: 6px 12px; border-radius: 12px; font-size: 13px; font-weight: 600; 
                                        background: ${appeal.status === 'Approved' ? '#d4edda' : appeal.status === 'Rejected' ? '#f8d7da' : '#fff3cd'}; 
                                        color: ${appeal.status === 'Approved' ? '#155724' : appeal.status === 'Rejected' ? '#721c24' : '#856404'};">
                                        ${appeal.status || 'Pending Review'}
                                    </span>
                                </div>
                                
                                <!-- Reason Type -->
                                <div style="background: #f8f9fa; padding: 12px 15px; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #1877f2; font-weight: 600; margin-bottom: 8px;">REASON TYPE</div>
                                    ${appeal.status === 'Approved' ? 
                                        `<span style="padding: 6px 12px; border-radius: 4px; font-size: 13px; font-weight: 600;
                                            background: ${(appeal.reason_type || 'Unexcused') === 'Excused' ? '#d4edda' : '#f8d7da'}; 
                                            color: ${(appeal.reason_type || 'Unexcused') === 'Excused' ? '#155724' : '#721c24'};">
                                            ${appeal.reason_type || 'Unexcused'}
                                        </span>` :
                                        `<select id="appealReasonTypeSelect" style="
                                            width: 100%;
                                            padding: 8px 10px;
                                            border: 2px solid #e3f2fd;
                                            border-radius: 5px;
                                            font-size: 14px;
                                            background: white;
                                            color: #333;
                                            cursor: pointer;
                                        ">
                                            <option value="Excused" ${(appeal.reason_type || 'Unexcused') === 'Excused' ? 'selected' : ''}>Excused</option>
                                            <option value="Unexcused" ${(appeal.reason_type || 'Unexcused') === 'Unexcused' ? 'selected' : ''}>Unexcused</option>
                                        </select>`
                                    }
                                </div>
                            </div>
                            
                            <!-- Reason Description -->
                            <div style="background: #f8f9fa; padding: 12px 15px; border-radius: 6px; border-left: 3px solid #1877f2; margin-bottom: 15px;">
                                <div style="font-size: 12px; color: #1877f2; font-weight: 600; margin-bottom: 8px;">REASON DESCRIPTION</div>
                                <p style="margin: 0; line-height: 1.5; color: #333; font-size: 14px; white-space: pre-wrap;">${appeal.appeal_reason || appeal.reason || 'No reason provided'}</p>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div style="
                            background: #f8f9fa;
                            padding: 15px 20px;
                            border-top: 1px solid #e4e6ea;
                            text-align: center;
                            border-radius: 0 0 10px 10px;
                            display: flex;
                            gap: 10px;
                            justify-content: center;
                        ">
                            ${appeal.status !== 'Approved' ? `
                                <button onclick="approveAppealFromModal('${appeal.id}')" style="
                                    background: #28a745;
                                    color: white;
                                    border: none;
                                    padding: 10px 20px;
                                    border-radius: 5px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 600;
                                "> Approve Appeal</button>
                            ` : ''}
                            <button onclick="closeAppealDetailsModal()" style="
                                background: #6c757d;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 14px;
                            ">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            console.log('Appeal details modal created and displayed');
        }

        function closeAppealDetailsModal() {
            const modal = document.getElementById('appealDetailsModal');
            if (modal) {
                modal.remove();
            }
        }
        
        


        function editAppeal(id) {
            console.log('editAppeal function called with id:', id);
            
            // Close details modal if open
            closeAppealDetailsModal();
            
            // Fetch appeal data from API
            fetch('/api/appeals', {
                credentials: 'same-origin'
            })
                .then(response => response.json())
                .then(result => {
                    let appealsData = null;
                    if (result.success && result.data) {
                        appealsData = result.data;
                    } else if (Array.isArray(result)) {
                        appealsData = result;
                    }
                    
                    if (appealsData) {
                        const appeal = appealsData.find(a => a.id === id);
                        if (appeal) {
                            // Populate the edit form with current data
                            document.getElementById('editAppealId').value = id;
                            document.getElementById('editAppealStudentName').value = appeal.student_name || '';
                            document.getElementById('editAppealReasonType').value = appeal.reason_type || 'Unexcused';
                            document.getElementById('editAppealReason').value = appeal.appeal_reason || appeal.reason || '';
                            document.getElementById('editAppealStatus').value = appeal.status || 'Pending Review';
                            document.getElementById('editAppealDate').value = appeal.submitted_date || appeal.appeal_date || '';
                            document.getElementById('editAppealSubmittedBy').value = appeal.submitted_by || '';
                            
                            // Open the edit modal
                            openModal('editAppealModal');
                        } else {
                            showAlert('Appeal not found', 'error');
                        }
                    } else {
                        showAlert('Error fetching appeal data', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error fetching appeal:', error);
                    showAlert('Error fetching appeal: ' + error.message, 'error');
                });
        }


        function exportData(type) {
            showAlert('Export functionality coming soon!', 'success');
        }

        // Alert system
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function refreshCurrentTab() {
            // Get the currently active tab
            const activeTab = document.querySelector('.tab-content.active');
            if (!activeTab) return;

            const tabId = activeTab.id;
            
            // Store the current tab in sessionStorage
            sessionStorage.setItem('activeTab', tabId);
            
            // Reload immediately without additional loading screens
            location.reload();
        }

        function refreshViolationCounts() {
            // Recalculate violation counts after data changes
            setTimeout(() => {
                calculateViolationCounts();
            }, 300);
        }

        function refreshDataOnly() {
            // Refresh data without page reload
            console.log('Refreshing data without page reload...');
            console.log('Current time:', new Date().toISOString());
            
            // Show loading indicator
            showLoading();
            
            // Track if any requests fail
            let hasErrors = false;
            
            // Force clear any existing cache
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    names.forEach(function(name) {
                        caches.delete(name);
                    });
                });
            }
            
            // Fetch fresh violations data with cache busting
            fetch('/api/violations?t=' + Date.now(), {
                credentials: 'same-origin',
                cache: 'no-cache'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.success && result.data) {
                        console.log('Fresh violations data:', result.data);
                        console.log('Updating violations table with', result.data.length, 'violations');
                        // Update the violations table with grouped violations (one row per student)
                        buildGroupedViolationsTable(result.data);
                        // Reapply search filter after table update
                        setTimeout(() => reapplyViolationSearch(), 100);
                    } else if (Array.isArray(result)) {
                        console.log('Fresh violations data (array):', result);
                        buildGroupedViolationsTable(result);
                        // Reapply search filter after table update
                        setTimeout(() => reapplyViolationSearch(), 100);
                    }
                })
                .catch(error => {
                    console.error('Error refreshing uniform violations data:', error);
                    // Fallback to old API
                    fetch('/api/violations?t=' + Date.now(), {
                        credentials: 'same-origin',
                        cache: 'no-cache'
                    })
                    .then(response => response.json())
                    .then(fallbackResult => {
                        if (fallbackResult.success && fallbackResult.data) {
                            buildGroupedViolationsTable(fallbackResult.data);
                        } else if (Array.isArray(fallbackResult)) {
                            buildGroupedViolationsTable(fallbackResult);
                        }
                    })
                    .catch(fallbackError => {
                        console.error('Error refreshing violations data:', fallbackError);
                        hasErrors = true;
                    });
                });
            
            // Also fetch fresh appeals data with cache busting
            fetch('/api/appeals?t=' + Date.now(), {
                credentials: 'same-origin',
                cache: 'no-cache'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.success && result.data) {
                        console.log('Fresh appeals data:', result.data);
                        console.log('Updating appeals table with', result.data.length, 'appeals');
                        // Update the appeals table
                        updateAppealsTable(result.data);
                        groupAppealRows();
                    } else if (Array.isArray(result)) {
                        console.log('Fresh appeals data (array):', result);
                        updateAppealsTable(result);
                        groupAppealRows();
                    }
                })
                .catch(error => {
                    console.error('Error refreshing appeals data:', error);
                    hasErrors = true;
                })
                .finally(() => {
                    hideLoading();
                    console.log('Data refresh completed');
                    showAlert('Data refreshed successfully!', 'success');
                });
        }

        function updateUniformViolationsTable(managementData) {
            console.log('updateUniformViolationsTable called with:', managementData);
            console.log('Number of students to display:', managementData ? managementData.length : 0);
            
            const tableBody = document.getElementById('violationsTableBody');
            if (!tableBody) {
                console.error('Violations table body not found');
                return;
            }
            
            console.log('Found violations table body, updating...');
            
            // Clear existing content
            tableBody.innerHTML = '';
            
            // Add rows for each student (already grouped)
            managementData.forEach(studentData => {
                const row = document.createElement('tr');
                row.className = 'violation-row';
                row.setAttribute('data-student-id', studentData.student_id);
                row.setAttribute('data-student-name', studentData.student_name);
                
                const statusClass = studentData.status.toLowerCase().replace(/\s+/g, '-');
                
                // Calculate latest date from studentData
                let latestDate = 'No Date';
                if (studentData.latest_date || studentData.last_updated || studentData.date) {
                    const dateValue = studentData.latest_date || studentData.last_updated || studentData.date;
                    const dateObj = new Date(dateValue);
                    if (!isNaN(dateObj.getTime())) {
                        latestDate = (dateObj.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                                    dateObj.getDate().toString().padStart(2, '0') + '/' + 
                                    dateObj.getFullYear();
                    }
                }
                
                row.innerHTML = `
                    <td class="student-name-cell">
                        ${studentData.student_name || 'Unknown Student'}
                    </td>
                    <td class="student-id-cell">
                        ${studentData.student_id || 'No ID'}
                    </td>
                    <td>${studentData.violation_type || 'Incomplete Uniform'}</td>
                    <td>${latestDate}</td>
                    <td><span class="status-badge status-${statusClass}">${studentData.status || 'Warning'}</span></td>
                    <td class="count-cell">
                        <span class="violation-count-badge">${studentData.offense_count || 0}</span>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewStudentViolationsByStudentId('${studentData.student_id}')">View</button>
                        <button class="btn btn-success btn-sm" onclick="completeViolation('${studentData.student_name}')">Complete</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            console.log(`Updated violations table with ${managementData.length} students`);
            
            // Reapply search filter after table update
            setTimeout(() => reapplyViolationSearch(), 100);
        }

        function updateViolationsTable(violations) {
            console.log('updateViolationsTable called with:', violations);
            console.log('Number of violations to display:', violations ? violations.length : 0);
            console.log('Timestamp:', new Date().toISOString());
            
            // Check and log new violations from student_violations (if not already checked)
            if (violations && Array.isArray(violations)) {
                checkAndLogNewViolations(violations);
            }
            
            const tableBody = document.getElementById('violationsTableBody');
            if (!tableBody) {
                console.error('Violations table body not found');
                return;
            }
            
            console.log('Found violations table body, updating...');
            
            // Clear existing content
            tableBody.innerHTML = '';
            
            // Group violations by student to calculate counts
            const studentViolationCounts = {};
            violations.forEach(violation => {
                const studentName = violation.student_name;
                studentViolationCounts[studentName] = (studentViolationCounts[studentName] || 0) + 1;
            });
            
            // Add new rows
            violations.forEach(violation => {
                const row = document.createElement('tr');
                row.className = 'violation-row';
                row.setAttribute('data-student', violation.student_name);
                row.setAttribute('data-violation-id', violation.id);
                
                // Calculate status based on student's total violation count
                const studentCount = studentViolationCounts[violation.student_name] || 1;
                const status = getViolationStatus(studentCount);
                const statusClass = status.toLowerCase().replace(/\s+/g, '-');
                
                row.innerHTML = `
                    <td class="student-name-cell">
                        ${violation.student_name}
                    </td>
                    <td class="student-id-cell">
                        ${violation.student_id || 'No ID'}
                    </td>
                    <td>${violation.violation_type || 'Incomplete Uniform'}</td>
                    <td><span class="status-badge status-${statusClass}">${status}</span></td>
                    <td class="count-cell">
                        <span class="violation-count-badge ${getCountClass(studentCount)}">${getCountText(studentCount)}</span>
                    </td>
                    <td>
                        <button class="btn btn-success" onclick="completeViolation('${violation.student_name}')">Complete</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            console.log(`Updated violations table with ${violations.length} violations`);
            
            // Reapply search filter after table update
            setTimeout(() => reapplyViolationSearch(), 100);
        }

        function updateAppealsTable(appeals) {
            console.log('Updating appeals table with:', appeals);
            console.log('Appeals data structure:', appeals.map(a => ({id: a.id, student_name: a.student_name, has_id: !!a.id})));
            
            // Store appeals data globally for testing
            window.currentAppealsData = appeals;
            
            const tableBody = document.getElementById('appealsTableBody');
            if (!tableBody) {
                console.error('Appeals table body not found');
                return;
            }
            
            // Clear existing content
            tableBody.innerHTML = '';
            
            // Add new rows
            appeals.forEach((appeal, index) => {
                console.log(`Processing appeal ${index}:`, {id: appeal.id, student_name: appeal.student_name, has_id: !!appeal.id});
                const row = document.createElement('tr');
                row.className = 'appeal-row';
                row.setAttribute('data-student', appeal.student_name);
                row.setAttribute('data-appeal-id', appeal.id);
                
                row.innerHTML = `
                    <td style="text-align: left; vertical-align: middle; padding-right: 8px;">
                        <div class="student-info">
                            <span class="clickable-student-name" onclick="console.log('Dynamic student name clicked for appeal ID:', '${appeal.id || 'unknown'}'); viewAppealDetails('${appeal.id || 'unknown'}')" title="Click to view appeal details for ${appeal.student_name}">
                                ${appeal.student_name}
                            </span>
                            ${appeal.created_automatically ? '<span class="auto-badge" title="Auto-created from violation"></span>' : ''}
                        </div>
                    </td>
                    <td style="text-align: left; vertical-align: middle; padding-left: 8px; width: 120px;">
                        <span style="color: #666; font-size: 14px;">${appeal.student_id || 'N/A'}</span>
                    </td>
                    <td style="text-align: center; vertical-align: middle;">
                        <button class="btn btn-primary btn-sm view-btn" onclick="viewAppealDetails('${appeal.id || 'unknown'}')" title="View appeal details">
                            View
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            console.log(`Updated appeals table with ${appeals.length} appeals`);
            
            // Group appeals by student name to show one row per student
            setTimeout(() => {
                groupAppealRows();
            }, 100);
        }

        function calculateViolationCounts() {
            // Calculate and populate violation count badges without transforming the table structure
            const tableBody = document.getElementById('violationsTableBody');
            if (!tableBody) {
                console.log('Violations table body not found for count calculation');
                return;
            }

            const rows = Array.from(tableBody.querySelectorAll('.violation-row'));
            if (rows.length === 0) {
                console.log('No violation rows found for count calculation');
                return;
            }

            // Count violations per student
            const studentViolationCounts = {};
            rows.forEach(row => {
                const studentName = row.dataset.student || row.querySelector('.student-name-cell')?.textContent?.trim();
                if (studentName) {
                    studentViolationCounts[studentName] = (studentViolationCounts[studentName] || 0) + 1;
                }
            });

            // Populate count badges for each row
            rows.forEach(row => {
                const studentName = row.dataset.student || row.querySelector('.student-name-cell')?.textContent?.trim();
                if (studentName) {
                    const count = studentViolationCounts[studentName] || 1;
                    const countBadge = row.querySelector('.violation-count-badge');
                    if (countBadge) {
                        countBadge.textContent = getCountText(count);
                        countBadge.className = `violation-count-badge ${getCountClass(count)}`;
                    }
                }
            });

            console.log('Calculated violation counts for', Object.keys(studentViolationCounts).length, 'students');
        }

        function groupViolationRows() {
            const tableBody = document.getElementById('violationsTableBody');
            if (!tableBody) return;

            const rows = Array.from(tableBody.querySelectorAll('.violation-row'));
            if (rows.length === 0) return;

            console.log('Found violation rows:', rows.length);

            // Group rows by student name
            const groupedRows = {};
            rows.forEach(row => {
                const studentName = row.dataset.student;
                if (!groupedRows[studentName]) {
                    groupedRows[studentName] = [];
                }
                groupedRows[studentName].push(row);
            });

            console.log('Grouped by student:', Object.keys(groupedRows));

            // Clear table body completely
            tableBody.innerHTML = '';

            // Sort students by violation count (highest to lowest)
            const sortedStudents = Object.keys(groupedRows).sort((a, b) => {
                const countA = groupedRows[a].length;
                const countB = groupedRows[b].length;
                return countB - countA; // Descending order (3rd offense first)
            });

            console.log('Sorted students by violation count:', sortedStudents);

            // Create one row per student in sorted order
            sortedStudents.forEach(studentName => {
                const studentViolations = groupedRows[studentName];
                const count = studentViolations.length;
                
                console.log(`Student: ${studentName}, Violations: ${count}`);
                
                // Get the most recent violation for display
                const latestViolation = studentViolations[studentViolations.length - 1];
                const latestCells = latestViolation.querySelectorAll('td');
                
                // Create main student row (non-clickable)
                const studentRow = document.createElement('tr');
                studentRow.className = `student-row ${getRowClass(count)}`;
                
                // Try to get date from data attributes or cells
                let latestDate = 'No Date';
                // Check if we can get date from the latest violation row's data attributes
                const latestRowData = latestViolation.dataset;
                if (latestRowData && latestRowData.date) {
                    const dateObj = new Date(latestRowData.date);
                    if (!isNaN(dateObj.getTime())) {
                        latestDate = (dateObj.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                                    dateObj.getDate().toString().padStart(2, '0') + '/' + 
                                    dateObj.getFullYear();
                    }
                }
                
                studentRow.innerHTML = `
                    <td class="student-name-cell">
                        <strong>${studentName}</strong>
                    </td>
                    <td class="student-id-cell">${latestCells[1]?.textContent?.trim() || 'No ID'}</td>
                    <td>${latestCells[2]?.textContent?.trim() || 'Multiple Types'}</td>
                    <td>${latestDate}</td>
                    <td>${latestCells[3]?.innerHTML || '<span class="status-badge status-active">Active</span>'}</td>
                    <td class="count-cell">
                        <span class="violation-count-badge ${getCountClass(count)}">${getCountText(count)}</span>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); viewStudentViolations('${studentName}')">View</button>
                        <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); completeViolation('${studentName}')">Complete</button>
                    </td>
                `;
                
                tableBody.appendChild(studentRow);
            });
            
            // Reapply search filter after grouping
            reapplyViolationSearch();
        }

        function buildGroupedViolationsTable(violations) {
            console.log('Building grouped violations table with:', violations);
            const tableBody = document.getElementById('violationsTableBody');
            if (!tableBody) {
                console.error('Table body not found!');
                return;
            }

            // Group violations by student
            const groupedViolations = {};
            violations.forEach(violation => {
                const studentName = violation.student_name;
                if (!groupedViolations[studentName]) {
                    groupedViolations[studentName] = [];
                }
                groupedViolations[studentName].push(violation);
            });

            console.log('Grouped violations:', groupedViolations);

            // Clear existing content
            tableBody.innerHTML = '';

            // Sort students by violation count (highest to lowest)
            const sortedStudents = Object.keys(groupedViolations).sort((a, b) => {
                const countA = groupedViolations[a].length;
                const countB = groupedViolations[b].length;
                return countB - countA; // Descending order (3rd offense first)
            });

            console.log('Sorted students by violation count:', sortedStudents);

            // Create rows for each student in sorted order
            sortedStudents.forEach(studentName => {
                const studentViolations = groupedViolations[studentName];
                const count = studentViolations.length;
                
                // Create student row
                const studentRow = document.createElement('tr');
                studentRow.className = `student-row ${getRowClass(count)}`;
                
                // Get latest violation for summary
                const latestViolation = studentViolations[studentViolations.length - 1];
                
                // Calculate latest violation date for this student
                let latestDate = 'No Date';
                const dates = studentViolations.map(v => {
                    return v.last_updated || v.date || v.created_at || v.timestamp || null;
                }).filter(d => d !== null);
                
                if (dates.length > 0) {
                    // Sort dates to get the latest one
                    dates.sort((a, b) => {
                        const dateA = new Date(a);
                        const dateB = new Date(b);
                        return dateB - dateA; // Descending order
                    });
                    const latestDateObj = new Date(dates[0]);
                    if (!isNaN(latestDateObj.getTime())) {
                        // Format as MM/DD/YYYY
                        latestDate = (latestDateObj.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                                    latestDateObj.getDate().toString().padStart(2, '0') + '/' + 
                                    latestDateObj.getFullYear();
                    }
                }
                
                // Calculate status based on violation count
                const status = getViolationStatus(count);
                const statusClass = status.toLowerCase().replace(/\s+/g, '-');
                
                studentRow.innerHTML = `
                    <td class="student-name-cell">
                        <strong>${studentName}</strong>
                    </td>
                    <td class="student-id-cell">${latestViolation.student_id || 'No ID'}</td>
                    <td>${latestViolation.violation_type || 'Multiple'}</td>
                    <td>${latestDate}</td>
                    <td><span class="status-badge status-${statusClass}">${status}</span></td>
                    <td class="count-cell">
                        <span class="violation-count-badge ${getCountClass(count)}">${getCountText(count)}</span>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewStudentViolations('${studentName}')">View</button>
                        <button class="btn btn-success btn-sm" onclick="completeViolation('${studentName}')">Complete</button>
                    </td>
                `;
                
                tableBody.appendChild(studentRow);
                
                // Create details row
                const detailsRow = document.createElement('tr');
                detailsRow.className = 'violation-details-row';
                detailsRow.id = `details-${studentName.replace(/\s+/g, '-')}`;
                
                const detailsCell = document.createElement('td');
                detailsCell.className = 'violation-details-cell';
                detailsCell.colSpan = 8;
                
                let detailsHtml = '<div style="margin-bottom: 10px;"><strong>All Violations for ' + studentName + ':</strong></div>';
                studentViolations.forEach((violation, index) => {
                    // Format date and time from last_updated
                    let dateDisplay = '';
                    let timeDisplay = '';
                    if (violation.last_updated) {
                        try {
                            // Parse last_updated format: "YYYY-MM-DD HH:MM:SS"
                            const lastUpdated = violation.last_updated;
                            const dateTimeParts = lastUpdated.split(' ');
                            if (dateTimeParts.length >= 2) {
                                const datePart = dateTimeParts[0];
                                const timePart = dateTimeParts[1];
                                // Format date as MM/DD/YYYY
                                const dateObj = new Date(datePart + 'T' + timePart);
                                dateDisplay = dateObj.toLocaleDateString('en-US', {month: '2-digit', day: '2-digit', year: 'numeric'});
                                // Format time as HH:MM
                                timeDisplay = timePart.substring(0, 5);
                            }
                        } catch (e) {
                            console.error('Error parsing last_updated:', e);
                        }
                    }
                    // Fallback to date field if last_updated is not available
                    if (!dateDisplay && violation.date) {
                        try {
                            const dateObj = new Date(violation.date);
                            dateDisplay = dateObj.toLocaleDateString('en-US', {month: '2-digit', day: '2-digit', year: 'numeric'});
                        } catch (e) {
                            dateDisplay = violation.date;
                        }
                    }
                    
                    detailsHtml += `
                        <div class="violation-item">
                            <div class="violation-info">
                                <strong>${violation.violation_type || 'Unknown Type'}</strong> - 
                                <span class="status-badge status-${(violation.status || 'Active').toLowerCase()}">${violation.status || 'Active'}</span>
                                ${dateDisplay ? `<div style="margin-top: 5px; color: #666; font-size: 12px; text-align: center;">
                                    <div>${dateDisplay}</div>
                                    ${timeDisplay ? `<div style="color: rgba(255, 255, 255, 0.6); font-size: 11px; text-align: center; margin-top: 2px; opacity: 0.7;">${timeDisplay}</div>` : ''}
                                </div>` : ''}
                            </div>
                            <div class="violation-actions">
                                <button class="btn btn-sm btn-secondary" onclick="editViolation('${violation.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteViolation('${violation.id}')">Delete</button>
                            </div>
                        </div>
                    `;
                });
                
                detailsCell.innerHTML = detailsHtml;
                detailsRow.appendChild(detailsCell);
                tableBody.appendChild(detailsRow);
            });
            
            // Reapply search filter after building table
            reapplyViolationSearch();
        }

        function buildGroupedViolationsTableFromTable() {
            // Fallback method to build from existing table
            const table = document.getElementById('violationsTableBody');
            if (!table) return;

            const rows = table.querySelectorAll('tr');
            const violations = [];

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 6) {
                    violations.push({
                        id: row.dataset.id || Math.random().toString(36).substr(2, 9),
                        student_name: cells[0]?.textContent?.trim(),
                        student_id: cells[1]?.textContent?.trim(),
                        violation_type: cells[2]?.textContent?.trim(),
                        status: cells[3]?.textContent?.trim()
                    });
                }
            });

            buildGroupedViolationsTable(violations);
            // Reapply search filter after building table
            setTimeout(() => reapplyViolationSearch(), 100);
        }

        function getCountClass(count) {
            if (count >= 3) return 'max-violations';      // Red for Guidance (3+)
            if (count === 2) return 'normal-violations';  // Orange for Advisory (2)
            if (count === 1) return 'warning-violations'; // Yellow for Warning (1)
            return 'normal-violations';
        }
        
        function getCountText(count) {
            if (count >= 3) return `${getOrdinalNumber(count)} (MAX)`;
            return getOrdinalNumber(count);
        }
        
        function getOrdinalNumber(num) {
            if (num >= 11 && num <= 13) {
                return num + 'th';
            }
            switch (num % 10) {
                case 1: return num + 'st';
                case 2: return num + 'nd';
                case 3: return num + 'rd';
                default: return num + 'th';
            }
        }
        
        function getRowClass(count) {
            if (count >= 3) return 'guidance-violations-row';
            if (count === 2) return 'advisory-violations-row';
            if (count === 1) return 'warning-violations-row';
            return '';
        }
        
        function getViolationStatus(count) {
            if (count >= 3) return 'Guidance';
            if (count === 2) return 'Advisory';
            if (count === 1) return 'Warning';
            return 'No Violations';
        }


        function viewAppealDetails(appealId) {
            console.log('=== VIEW APPEAL DETAILS CALLED ===');
            console.log('Appeal ID:', appealId);
            
            // Show immediate feedback
            showAlert(`Loading appeal details for ID: ${appealId}`, 'info');
            
            try {
                // Get appeals data
                const appealsData = window.currentAppealsData || [];
                console.log('Available appeals data:', appealsData);
                console.log('Number of appeals:', appealsData.length);
                
                if (appealsData.length === 0) {
                    showAlert('No appeals data available. Please refresh the page.', 'warning');
                    return;
                }
                
                // Find the specific appeal
                const appeal = appealsData.find(a => {
                    console.log('Checking appeal:', a.id, 'against:', appealId);
                    return a.id === appealId || a.id === String(appealId) || a.id === parseInt(appealId);
                });
                
                console.log('Found appeal:', appeal);
                
                if (appeal) {
                    console.log('Showing appeal details modal');
                    showAppealDetailsModal(appeal);
                } else {
                    console.log('Appeal not found in current data, showing simple modal');
                    // Show a simple modal with basic info
                    showSimpleAppealModal(appealId);
                }
            } catch (error) {
                console.error('Error in viewAppealDetails:', error);
                showAlert('Error loading appeal details: ' + error.message, 'error');
            }
        }

        function showSimpleAppealModal(appealId) {
            console.log('Showing simple appeal modal for ID:', appealId);
            
            // Create a simple modal
            const modal = document.createElement('div');
            modal.id = 'simpleAppealModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 25px;
                    border-radius: 10px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                ">
                    <h3 style="margin-top: 0; color: #333; margin-bottom: 20px; text-align: center;">Appeal Details</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="margin: 8px 0;"><strong>Appeal ID:</strong> ${appealId}</p>
                        <p style="margin: 8px 0;"><strong>Status:</strong> Loading...</p>
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #1877f2;">
                        <p style="margin: 0; color: #666; font-size: 14px; text-align: center;">Loading appeal details...</p>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="document.getElementById('simpleAppealModal').remove()" 
                                style="
                                    background: #1877f2;
                                    color: white;
                                    border: none;
                                    padding: 10px 20px;
                                    border-radius: 5px;
                                    cursor: pointer;
                                ">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Try to fetch more details
            fetch(`/api/appeals/${appealId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.appeal) {
                        const appeal = data.appeal;
                        const appealDate = appeal.status === 'Approved' && appeal.approved_date 
                            ? new Date(appeal.approved_date).toLocaleDateString() 
                            : appeal.date || appeal.created_date || appeal.submitted_date || 'Not specified';
                        const reasonType = appeal.reason_type || 'Not specified';
                        const reason = appeal.reason || appeal.appeal_reason || 'No reason provided';
                        
                        // Update the modal content with only required fields
                        const status = appeal.status || 'Unknown';
                        
                        modal.innerHTML = `
                            <div style="
                                background: white;
                                padding: 25px;
                                border-radius: 10px;
                                max-width: 600px;
                                width: 90%;
                                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                            ">
                                <h3 style="margin-top: 0; color: #333; margin-bottom: 20px; text-align: center;">Appeal Details</h3>
                                
                                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #1877f2; margin-bottom: 20px;">
                                    <h4 style="color: #1877f2; margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid #bbdefb; padding-bottom: 5px;">Student Name</h4>
                                    <p style="margin: 0; font-size: 14px; font-weight: 600; color: #333;">${appeal.student_name || appeal.studentName || 'Not specified'}</p>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                        <h4 style="color: #1877f2; margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid #e3f2fd; padding-bottom: 5px;">Reason Type</h4>
                                        <p style="margin: 0; font-size: 14px; font-weight: 600; color: #333;">${reasonType}</p>
                                    </div>
                                    
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                        <h4 style="color: #1877f2; margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid #e3f2fd; padding-bottom: 5px;">Approve Date</h4>
                                        <p style="margin: 0; font-size: 14px; font-weight: 600; color: #333;">${appealDate}</p>
                                    </div>
                                </div>
                                
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                    <h4 style="color: #1877f2; margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid #e3f2fd; padding-bottom: 5px;">Status</h4>
                                    <p style="margin: 0;">
                                        <span style="padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; 
                                            background: ${status === 'Approved' ? '#d4edda' : status === 'Pending' ? '#fff3cd' : '#f8d7da'}; 
                                            color: ${status === 'Approved' ? '#155724' : status === 'Pending' ? '#856404' : '#721c24'};">
                                            ${status}
                                        </span>
                                    </p>
                                </div>
                                
                                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #1877f2; margin-bottom: 20px;">
                                    <h4 style="color: #1877f2; margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid #bbdefb; padding-bottom: 5px;">Reason Description</h4>
                                    <p style="margin: 0; line-height: 1.5; color: #333; font-size: 13px; white-space: pre-wrap;">${reason}</p>
                                </div>
                                
                                <div style="text-align: center;">
                                    <button onclick="document.getElementById('simpleAppealModal').remove()" 
                                            style="
                                                background: #1877f2;
                                                color: white;
                                                border: none;
                                                padding: 10px 20px;
                                                border-radius: 5px;
                                                cursor: pointer;
                                            ">
                                        Close
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error fetching appeal details:', error);
                    modal.querySelector('p:nth-child(3)').innerHTML = `<strong>Status:</strong> <span style="color: #dc3545;">Error loading</span>`;
                });
        }

        function fetchAppealDetails(appealId) {
            console.log('Fetching appeal details for ID:', appealId);
            
            fetch(`/api/appeals/${appealId}`, {
                credentials: 'same-origin'
            })
                .then(response => response.json())
            .then(appeal => {
                console.log('Fetched appeal:', appeal);
                if (appeal) {
                    showAppealDetailsModal(appeal);
                    } else {
                    showAlert('Appeal not found', 'error');
                    }
                })
                .catch(error => {
                console.error('Error fetching appeal:', error);
                showAlert('Error loading appeal details: ' + error.message, 'error');
            });
        }

        function showAppealDetailsModal(appeal) {
            console.log('Showing appeal details modal for:', appeal);
            
            // Remove any existing modal
            const existingModal = document.getElementById('appealDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const currentReasonType = appeal.reason_type || 'Unexcused';
            const reason = appeal.reason || appeal.appeal_reason || 'No reason provided';
            const status = appeal.status || 'Unknown';
            const appealId = appeal.id;
            const isApproved = status === 'Approved';
            
            const modalHtml = `
                <div id="appealDetailsModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 550px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Appeal Details</h3>
                            <button class="close-btn" onclick="closeAppealDetailsModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="padding: 15px;">
                                <!-- Student Info -->
                                <div style="background: #e3f2fd; padding: 12px 15px; border-radius: 6px; border-left: 4px solid #1877f2; margin-bottom: 15px;">
                                    <div style="font-size: 12px; color: #1877f2; font-weight: 600; margin-bottom: 4px;">STUDENT</div>
                                    <div style="font-size: 15px; font-weight: 600; color: #333;">${appeal.student_name || appeal.studentName || 'Not specified'}</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 2px;">ID: ${appeal.student_id || 'N/A'}</div>
                                </div>
                                
                                <!-- Status and Reason Type Side by Side -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <!-- Status -->
                                    <div style="background: #f8f9fa; padding: 12px 15px; border-radius: 6px;">
                                        <div style="font-size: 12px; color: #1877f2; font-weight: 600; margin-bottom: 8px;">STATUS</div>
                                        <span style="padding: 6px 12px; border-radius: 12px; font-size: 13px; font-weight: 600; 
                                            background: ${status === 'Approved' ? '#d4edda' : status === 'Pending' ? '#fff3cd' : '#f8d7da'}; 
                                            color: ${status === 'Approved' ? '#155724' : status === 'Pending' ? '#856404' : '#721c24'};">
                                            ${status}
                                        </span>
                                    </div>
                                    
                                    <!-- Reason Type -->
                                    <div style="background: #f8f9fa; padding: 12px 15px; border-radius: 6px;">
                                        <div style="font-size: 12px; color: #1877f2; font-weight: 600; margin-bottom: 8px;">REASON TYPE</div>
                                        ${isApproved ? `
                                            <span style="padding: 6px 12px; border-radius: 4px; font-size: 13px; font-weight: 600;
                                                background: ${currentReasonType === 'Excused' ? '#d4edda' : '#f8d7da'}; 
                                                color: ${currentReasonType === 'Excused' ? '#155724' : '#721c24'};">
                                                ${currentReasonType}
                                            </span>
                                        ` : `
                                            <select id="appealReasonTypeSelect" style="
                                                width: 100%;
                                                padding: 8px 10px;
                                                border: 2px solid #e3f2fd;
                                                border-radius: 5px;
                                                font-size: 14px;
                                                background: white;
                                                color: #333;
                                                cursor: pointer;
                                            ">
                                                <option value="Excused" ${currentReasonType === 'Excused' ? 'selected' : ''}>Excused</option>
                                                <option value="Unexcused" ${currentReasonType === 'Unexcused' ? 'selected' : ''}>Unexcused</option>
                                            </select>
                                        `}
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div style="margin-top: 15px; text-align: center; display: flex; gap: 10px; justify-content: center;">
                                    ${!isApproved ? `
                                        <button onclick="approveAppealFromModal('${appealId}')" style="
                                            background: #28a745;
                                            color: white;
                                            border: none;
                                            padding: 10px 20px;
                                            border-radius: 5px;
                                            font-size: 14px;
                                            font-weight: 600;
                                            cursor: pointer;
                                            transition: background 0.3s;
                                        " onmouseover="this.style.background='#218838'" onmouseout="this.style.background='#28a745'">
                                             Approve Appeal
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-primary" onclick="closeAppealDetailsModal()" style="padding: 10px 20px; font-size: 14px;">
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeAppealDetailsModal() {
            const modal = document.getElementById('appealDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        function approveAppealFromModal(appealId) {
            // Get the selected reason type from the dropdown
            const reasonTypeSelect = document.getElementById('appealReasonTypeSelect');
            const reasonType = reasonTypeSelect ? reasonTypeSelect.value : 'Unexcused';
            
            if (confirm(`Are you sure you want to approve this appeal as "${reasonType}"?`)) {
                // Prepare update data
                const updateData = {
                    status: 'Approved',
                    reason_type: reasonType
                };
                
                fetch(`/api/appeals/${appealId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(updateData)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        let message = `Appeal approved successfully as "${reasonType}"!`;
                        if (result.violation_deleted) {
                            message += ' Related violation has been automatically deleted.';
                        }
                        showAlert(message, 'success');
                        
                        // Log activity
                        logActivity('edit', 'appeal', 'Appeal Approved', `Appeal with ID ${appealId} has been approved`, `Status: Approved, Reason Type: ${reasonType}`);
                        
                        // Close the modal
                        closeAppealDetailsModal();
                        
                        // Refresh the data
                        if (typeof reapplyGrouping === 'function') {
                            reapplyGrouping();
                        }
                        if (typeof refreshDataOnly === 'function') {
                            refreshDataOnly();
                        } else if (typeof loadDashboardData === 'function') {
                            loadDashboardData();
                        }
                    } else {
                        showAlert('Error approving appeal: ' + (result.error || result.message || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error approving appeal:', error);
                    showAlert('Error approving appeal: ' + error.message, 'error');
                });
            }
        }
        
        function viewStudentAppeals(studentName) {
            console.log('View button clicked for:', studentName);
            
            // Fetch all appeals for this student
            fetch('/api/appeals', {
                credentials: 'same-origin'
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data) {
                        const studentAppeals = result.data.filter(a => a.student_name === studentName);
                        showStudentAppealsModal(studentName, studentAppeals);
                    } else {
                        showAlert('Error fetching appeals for ' + studentName, 'error');
                    }
                })
                .catch(error => {
                    showAlert('Error fetching appeals: ' + error.message, 'error');
                });
        }

        function showStudentAppealsModal(studentName, appeals) {
            // Remove any existing student appeals modal
            const existingModal = document.getElementById('studentAppealsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal HTML similar to violations modal
            const modalHtml = `
                <div id="studentAppealsModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3 class="modal-title">All Appeals for ${studentName} (${appeals.length} total)</h3>
                            <button class="close-btn" onclick="closeStudentAppealsModal()">&times;</button>
                        </div>
                        <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                            <div class="appeals-list">
                                ${appeals.map((appeal, index) => {
                                    const appealId = appeal.id || appeal._id || `appeal-${index}`;
                                    const appealDate = appeal.status === 'Approved' && appeal.approved_date 
                                        ? new Date(appeal.approved_date).toLocaleDateString() 
                                        : appeal.date || appeal.created_date || appeal.submitted_date || appeal.appeal_date || 'No Date';
                                    const appealStatus = appeal.status || 'Pending Review';
                                    // Show "Pending Review" as reason type if appeal is not approved, otherwise show actual reason type
                                    const reasonType = appealStatus === 'Approved' 
                                        ? (appeal.reason_type || 'Unexcused') 
                                        : 'Pending Review';
                                    const studentId = appeal.student_id || 'N/A';
                                    
                                    return `
                                        <div class="appeal-item" style="margin-bottom: 15px; padding: 15px; border: 1px solid #e4e6ea; border-radius: 8px; background: #f8f9fa;">
                                            <div class="appeal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="font-weight: 600; color: #1877f2;">Appeal #${index + 1}</span>
                                                <span class="status-badge status-${appealStatus.toLowerCase().replace(/\s+/g, '-')}" style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">${appealStatus}</span>
                                            </div>
                                            <div class="appeal-details" style="margin-bottom: 10px;">
                                                <p style="margin: 5px 0;"><strong>Student ID:</strong> ${studentId}</p>
                                                <p style="margin: 5px 0;"><strong>Date:</strong> ${appealDate}</p>
                                                <p style="margin: 5px 0;"><strong>Reason Type:</strong> ${reasonType}</p>
                                            </div>
                                            <div class="appeal-actions" style="margin-top: 10px;">
                                                <button class="btn btn-primary btn-sm" onclick="viewAppealDetails('${appealId}')" style="margin-right: 8px;">
                                                    View Details
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeStudentAppealsModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeStudentAppealsModal() {
            const modal = document.getElementById('studentAppealsModal');
            if (modal) {
                modal.remove();
            }
        }

        function showStudentAppealsSummary(studentName, appeals) {
            // Remove any existing modal
            const existingModal = document.getElementById('studentAppealsSummaryModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modalHtml = `
                <div id="studentAppealsSummaryModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3 class="modal-title">All Appeals for ${studentName} (${appeals.length} total)</h3>
                            <button class="close-btn" onclick="closeStudentAppealsSummary()">&times;</button>
                        </div>
                        <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                            <div class="appeals-list">
                                ${appeals.map((appeal, index) => {
                                    const appealId = appeal.id || appeal._id || `appeal-${index}`;
                                    const appealDate = appeal.status === 'Approved' && appeal.approved_date 
                                        ? new Date(appeal.approved_date).toLocaleDateString() 
                                        : appeal.date || appeal.created_date || appeal.submitted_date || 'No Date';
                                    const appealStatus = appeal.status || 'Pending Review';
                                    const appealReason = appeal.reason || appeal.appeal_reason || 'No reason provided';
                                    
                                    return `
                                        <div class="appeal-item" style="margin-bottom: 15px; padding: 15px; border: 1px solid #e4e6ea; border-radius: 8px; background: #f8f9fa;">
                                            <div class="appeal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <span style="font-weight: 600; color: #1877f2;">Appeal #${index + 1}</span>
                                                <span class="status-badge status-${appealStatus.toLowerCase().replace(/\s+/g, '-')}" style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">${appealStatus}</span>
                                            </div>
                                            <div class="appeal-details">
                                                <p style="margin: 5px 0;"><strong>Date:</strong> ${appealDate}</p>
                                                <p style="margin: 5px 0;"><strong>Reason:</strong> ${appealReason}</p>
                                            </div>
                                            <div class="appeal-actions" style="margin-top: 10px;">
                                                <button class="btn btn-primary btn-sm" onclick="viewAppeal('${appealId}')" style="margin-right: 8px;">
                                                    View Details
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeStudentAppealsSummary()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
                document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeStudentAppealsSummary() {
            const modal = document.getElementById('studentAppealsSummaryModal');
            if (modal) {
                modal.remove();
            }
        }

        function showSimpleStudentAppealsModal(studentName) {
            // Remove any existing modal
            const existingModal = document.getElementById('simpleStudentAppealsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modalHtml = `
                <div id="simpleStudentAppealsModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Appeals for ${studentName}</h3>
                            <button class="close-btn" onclick="closeSimpleStudentAppealsModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p>Student: <strong>${studentName}</strong></p>
                            <p>This student has appeals in the system. The detailed view is being loaded...</p>
                            <div style="text-align: center; margin: 20px 0;">
                                <button class="btn btn-primary" onclick="refreshAppealsData()">Refresh Data</button>
                                <button class="btn btn-secondary" onclick="closeSimpleStudentAppealsModal()">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeSimpleStudentAppealsModal() {
            const modal = document.getElementById('simpleStudentAppealsModal');
            if (modal) {
                modal.remove();
            }
        }

        function refreshAppealsData() {
            showAlert('Refreshing appeals data...', 'info');
            loadAppealsData().then(appealsData => {
                if (appealsData && appealsData.length > 0) {
                    updateAppealsTable(appealsData);
                    showAlert('Appeals data refreshed successfully!', 'success');
                } else {
                    showAlert('No appeals data available after refresh', 'warning');
                }
            }).catch(error => {
                showAlert('Error refreshing appeals data: ' + error.message, 'error');
            });
        }


        function viewStudentViolationsByStudentId(studentId) {
            // Fetch all violations for this student_id from violation_history
            fetch(`/api/violations/student/${encodeURIComponent(studentId)}`, {
                credentials: 'same-origin'
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data) {
                        const studentViolations = result.data;
                        const studentName = studentViolations.length > 0 ? studentViolations[0].student_name : 'Unknown Student';
                        showStudentViolationsModal(studentName, studentViolations);
                    } else {
                        showAlert('Error fetching violations for student ID: ' + studentId, 'error');
                    }
                })
                .catch(error => {
                    showAlert('Error fetching violations: ' + error.message, 'error');
                });
        }

        function viewStudentViolations(studentName) {
            // Fetch all violations for this student
            fetch('/api/violations', {
                credentials: 'same-origin'
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data) {
                        const studentViolations = result.data.filter(v => v.student_name === studentName);
                        showStudentViolationsModal(studentName, studentViolations);
                    } else {
                        showAlert('Error fetching violations for ' + studentName, 'error');
                    }
                })
                .catch(error => {
                    showAlert('Error fetching violations: ' + error.message, 'error');
                });
        }

        function showStudentViolationsModal(studentName, violations) {
            // Remove any existing student violations modal
            const existingModal = document.getElementById('studentViolationsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal HTML
            const modalHtml = `
                <div id="studentViolationsModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3 class="modal-title">All Violations for ${studentName} (${violations.length} total)</h3>
                            <button class="close-btn" onclick="closeStudentViolationsModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="violations-list">
                                ${violations.map((violation, index) => {
                                    // Format date and time from timestamp field (check multiple possible field names)
                                    let dateDisplay = '';
                                    let timeDisplay = '';
                                    
                                    // Try to get timestamp from various possible field names
                                    const timestamp = violation.timestamp || violation.last_updated || violation.created_at || violation.date || '';
                                    
                                    if (timestamp) {
                                        try {
                                            // Handle different timestamp formats
                                            let dateObj;
                                            let dateStr = '';
                                            let timeStr = '';
                                            
                                            // If timestamp is already in "YYYY-MM-DD HH:MM:SS" format
                                            if (typeof timestamp === 'string' && timestamp.includes(' ')) {
                                                const dateTimeParts = timestamp.split(' ');
                                                if (dateTimeParts.length >= 2) {
                                                    dateStr = dateTimeParts[0];
                                                    timeStr = dateTimeParts[1];
                                                    dateObj = new Date(dateStr + 'T' + timeStr);
                                                }
                                            }
                                            // If timestamp is in ISO format or date string
                                            else if (typeof timestamp === 'string') {
                                                dateObj = new Date(timestamp);
                                            }
                                            // If timestamp is a number (Unix timestamp)
                                            else if (typeof timestamp === 'number') {
                                                dateObj = new Date(timestamp * 1000); // Convert seconds to milliseconds if needed
                                                if (isNaN(dateObj.getTime())) {
                                                    dateObj = new Date(timestamp); // Try as milliseconds
                                                }
                                            }
                                            
                                            if (dateObj && !isNaN(dateObj.getTime())) {
                                                // Format date as MM/DD/YYYY
                                                dateDisplay = dateObj.toLocaleDateString('en-US', {month: '2-digit', day: '2-digit', year: 'numeric'});
                                                
                                                // Format time as HH:MM (24-hour format)
                                                const hours = String(dateObj.getHours()).padStart(2, '0');
                                                const minutes = String(dateObj.getMinutes()).padStart(2, '0');
                                                timeDisplay = `${hours}:${minutes}`;
                                                
                                                // If we already have timeStr from parsing, use it
                                                if (timeStr && timeStr.length >= 5) {
                                                    timeDisplay = timeStr.substring(0, 5);
                                                }
                                            }
                                        } catch (e) {
                                            console.error('Error parsing timestamp:', e, 'timestamp value:', timestamp);
                                        }
                                    }
                                    
                                    // Fallback to date field if timestamp parsing failed
                                    if (!dateDisplay && violation.date) {
                                        try {
                                            const dateObj = new Date(violation.date);
                                            if (!isNaN(dateObj.getTime())) {
                                                dateDisplay = dateObj.toLocaleDateString('en-US', {month: '2-digit', day: '2-digit', year: 'numeric'});
                                            } else {
                                                dateDisplay = violation.date;
                                            }
                                        } catch (e) {
                                            dateDisplay = violation.date;
                                        }
                                    }
                                    
                                    // If still no date, show a placeholder
                                    if (!dateDisplay) {
                                        dateDisplay = 'No date available';
                                    }
                                    
                                    // Format missing_items or last_missing_items as numbered list
                                    let missingItemsContent = '';
                                    // Check missing_items first (primary field)
                                    let missingItems = violation.missing_items || violation.last_missing_items || [];
                                    
                                    if (missingItems && Array.isArray(missingItems) && missingItems.length > 0) {
                                        const missingItemsHtml = missingItems.map((item, idx) => {
                                            // Escape HTML in item text
                                            const escapedItem = String(item).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
                                            return `${idx + 1}. ${escapedItem}`;
                                        }).join('<br>');
                                        missingItemsContent = missingItemsHtml;
                                    } else {
                                        missingItemsContent = 'No missing items information available';
                                    }
                                    
                                    return `
                                    <div class="violation-item">
                                        <div class="violation-header">
                                            <span class="violation-number">#${index + 1}</span>
                                            <div class="violation-type-container" style="flex: 1; display: flex; flex-direction: column; gap: 5px;">
                                                <span class="violation-type" style="font-weight: 600; font-size: 15px;">${violation.violation_type || 'Incomplete Uniform'}</span>
                                                <div style="display: flex; flex-direction: column; gap: 3px;">
                                                    <div style="font-size: 13px; color: #666;">
                                                        <strong>Date:</strong> ${dateDisplay}
                                                    </div>
                                                    ${timeDisplay ? `
                                                    <div style="font-size: 13px; color: #666; margin-top: 2px;">
                                                        <strong>Time:</strong> ${timeDisplay}
                                                    </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                            <span class="violation-status status-${(violation.status || 'Warning').toLowerCase().replace(/[^a-z0-9]/g, '-')}">${violation.status || 'Warning'}</span>
                                        </div>
                                        <div class="violation-details">
                                            <p><strong>Missing Items:</strong></p>
                                            <p style="margin-top: 5px;">${missingItemsContent}</p>
                                        </div>
                                        <div class="violation-actions">
                                            <button class="btn btn-sm btn-danger" onclick="deleteViolation('${violation.id}')">Delete</button>
                                        </div>
                                    </div>
                                `;
                                }).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeStudentViolationsModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeStudentViolationsModal() {
            const modal = document.getElementById('studentViolationsModal');
                if (modal) {
                modal.remove();
            }
        }
        
        function editViolationFromModal(violationId, studentName, violationType, description, status) {
            // Close the student violations modal first
            closeStudentViolationsModal();
            
            // Populate the edit form with the violation data
            document.getElementById('editViolationId').value = violationId;
            document.getElementById('editStudentName').value = studentName;
            document.getElementById('editViolationType').value = violationType;
            document.getElementById('editDescription').value = description;
            document.getElementById('editStatus').value = status;
            
            // Open the edit violation modal
            openModal('editViolationModal');
        }

        function editStudentViolations(studentName) {
            showAlert(`Edit all violations for ${studentName} - Feature coming soon!`, 'info');
        }


        function editStudentAppeals(studentName) {
            showAlert(`Edit all appeals for ${studentName} - Feature coming soon!`, 'info');
        }

        function deleteAllStudentViolations(studentName) {
            if (confirm(` WARNING: This will delete ALL violations for ${studentName} permanently!\n\nThis includes:\n All violation records\n This action cannot be undone!\n\nAre you absolutely sure you want to continue?`)) {
                if (confirm(` FINAL CONFIRMATION \n\nThis will permanently delete ALL violations for ${studentName}!\n\nType "DELETE ALL" to confirm:`)) {
                    // Show loading indicator
                    showLoading();
                    
                    // Call the API to delete all violations for this student
                    fetch(`/api/violations/student/${encodeURIComponent(studentName)}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(result => {
                        hideLoading();
                        
                        if (result.success) {
                            const totalDeleted = result.total_deleted || 0;
                            const deletedViolations = result.deleted_violations || 0;
                            const deletedAppeals = result.deleted_appeals || 0;
                            
                            if (totalDeleted > 0) {
                                let message = ` Successfully deleted `;
                                const parts = [];
                                if (deletedViolations > 0) parts.push(`${deletedViolations} violation(s)`);
                                if (deletedAppeals > 0) parts.push(`${deletedAppeals} appeal(s)`);
                                message += parts.join(' and ') + ` for ${studentName}!`;
                                
                                // Log the activity
                                logActivity('delete', 'violation', 'Student Violations Deleted', 
                                    `All violations deleted for student: ${studentName}`, 
                                    `Student: ${studentName}, Violations deleted: ${deletedViolations}, Deleted by: ${getCurrentUser()}`);
                                
                                showAlert(message, 'success');
                                // Refresh the page to show updated data
                                setTimeout(() => {
                                    location.reload();
                                }, 1500);
                            } else {
                                showAlert(` No violations or appeals found for ${studentName}`, 'info');
                            }
                        } else {
                            showAlert(` Error deleting violations: ${result.error || 'Unknown error'}`, 'error');
                        }
                    })
                    .catch(error => {
                        hideLoading();
                        showAlert(` Error deleting violations: ${error.message}`, 'error');
                        console.error('Delete all violations error:', error);
                    });
                }
            }
        }

        // Loading indicator functions
        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
        }
        
        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }
        
        // Hide loading on page load (data already loaded from server)
        window.addEventListener('load', function() {
            hideLoading();
            
            // Initialize observer as disabled
            window.appealsObserverActive = false;
            window.appealsObserver = null;
            console.log('Appeals observer completely disabled on page load');
        });
        
        // Show loading only for external navigation
        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'A' && e.target.href && !e.target.href.includes('#') && !e.target.href.includes(window.location.hostname)) {
                showLoading();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved language and apply translations
            const savedLanguage = localStorage.getItem('selectedLanguage') || 'en';
            applyTranslations(savedLanguage);
            
            // Check if there's a stored active tab
            const storedTab = sessionStorage.getItem('activeTab');
            if (storedTab) {
                showTab(storedTab);
                sessionStorage.removeItem('activeTab'); // Clear after use
            }
            
            // Set up search input listeners
            document.getElementById('violationSearch').addEventListener('input', searchViolations);
            document.getElementById('appealSearch').addEventListener('input', searchAppeals);
            document.getElementById('activitySearch').addEventListener('input', searchActivities);
            
            // Set today's date for violation form
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('violationDate').value = today;
            
            // Prevent non-numeric input in Student ID fields
            const studentIdInputs = document.querySelectorAll('input[name="student_id"], #editStudentId, input[name="student_id"][form="appealForm"]');
            studentIdInputs.forEach(function(input) {
                input.addEventListener('input', function(e) {
                    // Remove any non-numeric characters
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
                
                input.addEventListener('keypress', function(e) {
                    // Prevent typing non-numeric characters
                    if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                    }
                });
            });
            
            // Initialize activities
            addInitialActivities();
            
            // Load appeals data on page load
            loadAppealsData().then(appealsData => {
                if (appealsData && appealsData.length > 0) {
                    updateAppealsTable(appealsData);
                } else {
                    console.log('No appeals data available');
                }
            }).catch(error => {
                console.error('Error loading appeals data:', error);
            });
            
            // Immediate grouping on page load
            forceGrouping();
            calculateViolationCounts();
            
            // Add event listeners to view buttons after a short delay
            setTimeout(() => {
            }, 500);
            
            // Use requestAnimationFrame for immediate grouping
            requestAnimationFrame(() => {
                forceGrouping();
                calculateViolationCounts();
            });
            
            // Load violations data on page load and group by student
            fetch('/api/violations', {
                credentials: 'same-origin',
                cache: 'no-cache'
            })
            .then(response => response.json())
            .then(result => {
                if (result.success && result.data) {
                    console.log('Loaded violations data on page load:', result.data);
                    // Group violations by student (one row per student)
                    buildGroupedViolationsTable(result.data);
                } else if (Array.isArray(result)) {
                    console.log('Loaded violations data (array) on page load:', result);
                    buildGroupedViolationsTable(result);
                } else {
                    // Fallback: group existing server-side rendered violations
                    const tableBody = document.getElementById('violationsTableBody');
                    if (tableBody && tableBody.children.length > 0) {
                        groupViolationRows();
                    }
                }
            })
            .catch(error => {
                console.error('Error loading violations data:', error);
                // Fallback: group existing server-side rendered violations
                const tableBody = document.getElementById('violationsTableBody');
                if (tableBody && tableBody.children.length > 0) {
                    groupViolationRows();
                }
            });
            
            // Calculate violation counts on page load
            setTimeout(() => {
                // Load appeals data
                loadAppealsData().then(appealsData => {
                    console.log('Loaded appeals data on page load:', appealsData);
                    if (appealsData.length > 0) {
                        updateAppealsTable(appealsData);
                    }
                });
                
                // Group appeals by student
                forceGrouping();
            }, 100);
            
            // Additional grouping after a longer delay to ensure it works after page refresh
            setTimeout(() => {
                forceGrouping();
                calculateViolationCounts();
            }, 500);
            
            // More aggressive grouping for page refreshes
            setTimeout(() => {
                forceGrouping();
                calculateViolationCounts();
            }, 1000);
            
            setTimeout(() => {
                forceGrouping();
                calculateViolationCounts();
            }, 2000);
            
            // DISABLED: MutationObserver for appeals table - causing issues
            // const appealsTable = document.getElementById('appeals');
            // if (appealsTable) {
            //     const appealsTbody = appealsTable.querySelector('tbody');
            //     if (appealsTbody) {
            //         // Store tbody reference globally for reuse
            //         window.appealsTbody = appealsTbody;
            //         
            //         // Create observer but don't start it
            //         window.appealsObserver = new MutationObserver(function(mutations) {
            //             // Observer functionality disabled
            //         });
            //         
            //         console.log('Appeals observer disabled to prevent console messages');
            //     }
            // }
            
            // Initialize observer as disabled
            window.appealsObserverActive = false;
            window.appealsObserver = null;
            console.log('Appeals observer completely disabled');
            
            // Set up automatic refresh every 30 seconds (only if page is visible)
            setInterval(() => {
                if (!document.hidden) {
                    console.log('Auto-refreshing data...');
                    refreshDataOnly();
                }
            }, 30000); // 30 seconds
        });
    </script>
</body>
</html>
</html>